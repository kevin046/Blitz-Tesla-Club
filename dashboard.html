<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dashboard - Blitz T Club</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="mobile-navigation.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/BvmtNLtB/logo.png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/BvmtNLtB/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="navigation.js" defer></script>
    <script>
        // Add a global direct logout function that can be called from anywhere
        window.performLogout = async function(options = {}) {
            const { showMessage = true, redirectDelay = 3000, skipRedirect = false } = options;
            console.log('Direct logout function called with options:', options);
            
            try {
                // Try to sign out through Supabase
                if (window.supabaseClient) {
                    await window.supabaseClient.auth.signOut()
                        .catch(e => console.error('Error during signOut call:', e));
                }
            } catch (error) {
                console.error('Critical error during logout attempt:', error);
            } finally {
                // Always clear storage regardless of errors
                console.log('Clearing auth storage');
                localStorage.removeItem('supabase.auth.token');
                sessionStorage.removeItem('supabase.auth.token');
                
                // Clear any other auth-related storage that might exist
                try {
                    for (let key in localStorage) {
                        if (key.includes('supabase') || key.includes('auth') || key.includes('token')) {
                            localStorage.removeItem(key);
                        }
                    }
                    for (let key in sessionStorage) {
                        if (key.includes('supabase') || key.includes('auth') || key.includes('token')) {
                            sessionStorage.removeItem(key);
                        }
                    }
                } catch (e) {
                    console.error('Error clearing storage:', e);
                }
                
                // Show a message to the user
                if (showMessage) {
                    const errorDisplay = document.getElementById('errorNotification');
                    if (errorDisplay) {
                        errorDisplay.querySelector('.error-message').textContent = 
                            'You have been logged out. Redirecting to login page...';
                        errorDisplay.style.display = 'flex';
                    }
                }
                
                // Allow skipping redirect or delaying it
                if (!skipRedirect) {
                    setTimeout(() => {
                        // Force redirect to login page after delay
                window.location.href = 'login.html';
                    }, redirectDelay);
                }
            }
        };
        
        // Only keep necessary script elements for dashboard functionality, removing any mobile menu customizations
        
        // Calculate viewport height for mobile browsers (fix iOS issues)
        function setViewportHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        // Set the height on page load
        window.addEventListener('load', setViewportHeight);
        // Update height on resize and orientation change
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', setViewportHeight);
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #171a20;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }
        
        /* Hide elements with hidden class - for removing mandatory updates */
        .hidden {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            width: 0 !important;
            opacity: 0 !important;
            position: absolute !important;
            overflow: hidden !important;
            z-index: -9999 !important;
            pointer-events: none !important;
        }
        
        .dashboard-page main {
            flex: 1;
            padding: clamp(20px, 4vw, 40px); /* Updated padding */
            z-index: 1;
        }

        /* Dashboard Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* General Dashboard Card Styles */
        .dashboard-card {
            background: linear-gradient(145deg, #222a36, #1c2330);
            border-radius: 20px;
            padding: clamp(24px, 3vw, 32px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #00e676, #2196f3);
            opacity: 0.8;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-header h2 {
            font-size: 1.25rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffffff;
        }

        .card-header h2 i {
            color: #00e676;
            font-size: 1.1em;
        }

        .card-header .view-all {
            color: #2196f3;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .card-header .view-all:hover {
            color: #00e676;
            text-decoration: underline;
        }

        .card-content {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* Profile Completion Alert Styles */
        .completion-alert {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
            margin-bottom: 30px;
        }
        
        .completion-alert::before {
            background: #ff9800;
        }
        
        .completion-alert .card-header {
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }
        
        .completion-alert .card-header h2 {
            color: #e65100;
        }
        
        .completion-alert .card-header h2 i {
            color: #ff9800;
        }
        
        .completion-alert .card-content p {
            color: #424242;
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .missing-info-list {
            margin: 15px 0;
        }
        
        .missing-info-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255, 152, 0, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .missing-info-item i {
            color: #ff9800;
            margin-right: 10px;
            font-size: 16px;
        }
        
        .completion-actions {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        
        .completion-actions .btn {
            padding: 12px 25px;
            font-weight: 500;
        }

        /* Badge Styling */
        .badge.upcoming {
            background: #ffca28;
            color: #1a1a1a;
            padding: 4px 8px;
            margin-left: 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            vertical-align: middle;
            display: inline-block;
            position: relative;
            top: -1px;
        }

        /* Quick Links Styling */
        .quick-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .quick-link-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            text-decoration: none;
            color: #fff;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .quick-link-item:hover {
            background: rgba(0, 230, 118, 0.1);
            transform: translateY(-3px);
        }

        .quick-link-item i {
            font-size: 1.5rem;
            color: #00e676;
        }

        .quick-link-item span {
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        /* Dashboard Content Styles */
        
        /* Special handling for mobile menu open state to prevent split screen */
        body.nav-open {
            overflow: hidden !important; 
            position: fixed !important;
            width: 100% !important;
            height: 100% !important;
            top: 0 !important;
            left: 0 !important;
            touch-action: none !important; /* JavaScript in navigation.js already handles this */
        }
        
        /* iOS Optimizations */
        @supports (-webkit-touch-callout: none) {
            .dashboard-container {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }

            .dashboard-header {
                margin-top: env(safe-area-inset-top);
            }

            nav {
                padding-top: env(safe-area-inset-top);
            }

            footer {
                padding-bottom: env(safe-area-inset-bottom);
            }

            /* Prevent text size adjustment */
            body {
                -webkit-text-size-adjust: none;
            }

            /* Improve touch targets */
            .nav-links a,
            .quick-actions button,
            .quick-link-item,
            .resend-btn {
                min-height: 44px;
                padding: 12px;
            }

            /* Smooth scrolling */
            .dashboard-container {
                -webkit-overflow-scrolling: touch;
            }

            /* Prevent unwanted highlighting */
            * {
                -webkit-tap-highlight-color: transparent;
            }
        }
        
        /* Modern Membership Card Styles */
        .modal-content.membership-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: 16px;
            padding: 30px;
            margin: 0 auto;
            text-align: left;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            position: relative;
            overflow: hidden;
            transform: perspective(1000px) rotateY(0deg);
            transition: transform 0.5s ease;
        }
        
        .modal-content.membership-card:hover {
            transform: perspective(1000px) rotateY(5deg);
        }
        
        .modal-content.membership-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.05) 50%, 
                rgba(255,255,255,0) 100%);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            background: transparent;
            padding: 0;
            border: none;
        }
        
        .card-header img {
            height: 60px;
            width: auto;
            background: transparent;
            margin: 0;
        }
        
        .header-text h2 {
            font-size: 22px;
            margin: 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.95);
            background: transparent;
        }
        
        .member-info {
            margin: 25px 0;
            text-align: left;
        }
        
        .member-info h3 {
            font-size: 24px;
            margin-bottom: 25px;
            font-weight: 700;
            color: white;
            letter-spacing: 0.5px;
            text-transform: capitalize;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 14px;
            color: white;
            margin-bottom: 5px;
        }
        
        .info-row .label {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        
        .card-footer {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }
        
        .qr-section {
            text-align: center;
        }
        
        canvas.qr-code {
            width: 120px;
            height: 120px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin: 0 auto 15px;
        }
        
        .qr-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .qr-text i {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        /* Premium Card Style */
        .membership-card[data-type="premium"] {
            background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .membership-card[data-type="premium"]::before {
            background: linear-gradient(45deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.1) 50%, 
                rgba(255,255,255,0) 100%);
        }
        
        .membership-card[data-type="premium"] .header-text h2 {
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .membership-card[data-type="premium"] .info-row {
            border-bottom: 1px solid rgba(255, 255, 255, 0.25);
        }
        
        .membership-card[data-type="premium"] .qr-text {
            color: rgba(255, 255, 255, 0.9);
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Modal styling for the card */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow: auto;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease forwards;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            position: relative;
            margin: 20px;
            animation: modalSlideIn 0.4s ease-out forwards;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .close-modal:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(1.1);
        }

        .profile-settings {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
        }

        .form-group input {
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Edit Profile Modal Styles */
        .danger-btn {
            background-color: #dc3545;
            color: white;
        }
        
        .danger-btn:hover {
            background-color: #c82333;
        }
        
        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .toggle-password {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Modern Settings Modal Styles */
        .settings-modal {
            max-width: 600px;
            width: 90%;
            background: #1a1a1a;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .settings-modal .modal-header {
            background: #222;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            border-bottom: 1px solid #333;
        }

        .settings-modal .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            color: #fff;
        }

        .settings-modal .modal-body {
            padding: 20px;
        }

        .settings-section {
            background: #222;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 1.1em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            color: #888;
            font-size: 0.9em;
        }

        .info-value {
            color: #fff;
            font-weight: 500;
        }

        .modern-input {
            width: 100%;
            padding: 12px;
            background: #333;
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 0.95em;
            transition: border-color 0.3s ease;
        }

        .modern-input:focus {
            border-color: #666;
            outline: none;
        }

        .danger-zone {
            border: 1px solid #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .danger-text {
            color: #dc3545;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .primary-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .primary-btn:hover {
            background: #0056b3;
        }

        .danger-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .danger-btn:hover {
            background: #c82333;
        }

        .password-input-container {
            position: relative;
            width: 100%;
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0;
        }

        .toggle-password:hover {
            color: #888;
        }

        /* Password Strength Meter */
        .password-strength-meter {
            margin-top: 10px;
            font-size: 0.85em;
        }

        .strength-label {
            margin-bottom: 5px;
            color: #bbb;
        }

        .strength-bar-container {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-bottom: 6px;
        }

        .strength-bar {
            height: 100%;
            width: 0;
            transition: width 0.3s ease, background 0.3s ease;
            border-radius: 2px;
        }

        .strength-weak {
            width: 33%;
            background: #dc2626;
        }

        .strength-medium {
            width: 66%;
            background: #f59e0b;
        }

        .strength-strong {
            width: 100%;
            background: #16a34a;
        }

        #passwordRequirements {
            color: #888;
            font-size: 0.85em;
        }
        
        /* Coupon Card Styles */
        .coupon-container {
            text-align: center;
            padding: 10px 0;
        }
        
        .coupon-icon {
            font-size: 48px;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .coupon-icon.redeemed {
            color: #16a34a;
        }
        
        .coupon-status h3 {
            margin-bottom: 10px;
            color: #1a1a1a;
        }
        
        .coupon-status p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .coupon-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.9rem;
            background: #e3f2fd;
            color: #0d47a1;
            margin-bottom: 20px;
        }
        
        .coupon-badge.redeemed {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        #redeemCouponBtn {
            transition: all 0.3s ease;
            display: block;
            margin: 0 auto;
        }
        
        #redeemCouponBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .coupon-redeemed {
            text-align: center;
        }
        
        .coupon-redeemed h3 {
            margin-bottom: 10px;
            color: #1a1a1a;
        }
        
        .coupon-redeemed p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .redemption-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .redemption-info p {
            margin: 0;
            color: #555;
        }
        
        /* Coupon Redemption Modal */
        .redemption-modal .modal-content {
            max-width: 500px;
            padding: 30px;
            background: white;
            border-radius: 15px;
            text-align: center;
        }
        
        .redemption-modal .modal-icon {
            font-size: 60px;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .redemption-modal h2 {
            color: #1a1a1a;
            margin-bottom: 15px;
        }
        
        .redemption-modal p {
            color: #666;
            margin-bottom: 25px;
        }
        
        .redemption-modal .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .redemption-modal .confirm-btn {
            background: #16a34a;
        }
        
        .redemption-modal .confirm-btn:hover {
            background: #15803d;
        }

        /* Car models display styling */
        .car-models-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 5px 0;
        }
        
        .car-model-badge {
            background: rgba(0, 123, 255, 0.2);
            color: #fff;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .car-model-badge i {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* Address display styling */
        .address-display {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            color: #fff;
            line-height: 1.6;
            transition: all 0.3s ease;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .address-display address {
            font-style: normal;
            margin: 0;
        }
        
        .edit-info-btn {
            margin-top: 15px;
            background: transparent;
            border: 1px solid #007bff;
            color: #007bff;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-info-btn:hover {
            background: rgba(0, 123, 255, 0.1);
        }

        .form-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .address-fields {
            grid-column: 1 / -1;
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .address-fields #editStreet {
            grid-column: 1 / -1;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .icon-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .icon-btn i {
            margin-right: 6px;
        }

        #addressUpdateForm {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        /* … your existing styles … */
        .badge.upcoming {
            background: #ffca28;
            color: #1a1a1a;
            padding: 2px 6px;
            margin-left: 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            vertical-align: middle;
        }

        /* Add to existing dashboard styles */
        .status-indicators {
            display: flex;
            gap: 1.5rem;
            align-items: center;  /* Vertical centering */
            justify-content: center;  /* Horizontal centering */
            margin: 1rem 0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: #f8f9fa;
        }

        .status-icon {
            font-size: 1.2rem;
        }

        /* Ensure text alignment */
        .status-text {
            color: #333; /* Changed from white to dark grey */
            font-weight: 500;
            margin: 0;
        }

        /* If using status badges */
        .status-badge {
            color: #333 !important; /* Force text color */
            background-color: #f8f9fa;
        }

        .upcoming-events {
            position: relative;
            padding-right: 120px; /* Space for button */
        }

        .upcoming-events .btn-small {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .error-alert {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Add these styles */
        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 1.2rem;
        }

        .missing-info {
            color: #ff6b6b;
            font-style: italic;
        }

        #addressDisplay p {
            margin: 2px 0;
            line-height: 1.4;
        }

        .verified-info {
            color: #4CAF50;
            font-weight: 500;
        }

        .missing-info {
            color: #FF5252;
            background: rgba(255,82,82,0.1);
            padding: 8px 12px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .address-line {
            font-weight: 500;
            font-size: 1.1em;
        }

        .city-province {
            color: #666;
        }

        .postal-code {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
        
        /* Username display styling */
        .username-display {
            margin: 0.25rem 0 0.75rem;
            font-size: 0.95rem;
            color: #5c5e62;
        }
        
        .username-label {
            font-weight: 500;
            margin-right: 0.5rem;
        }
        
        #userUsername {
            font-family: monospace;
            background: rgba(0, 230, 118, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            color: #171a20;
        }

        /* Profile Completion Progress Bar */
        .profile-completion-status {
            margin-top: 20px;
            text-align: center;
        }
        
        .progress-container {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #ff9800, #00e676);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .profile-completion-status span {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Dashboard Page Specific Styles */
        /* Removing this style that changes the background color
        body.dashboard-page {
            background-color: #121212;
            font-family: 'Montserrat', sans-serif;
        }
        */
        
        /* Full Profile Update Section Styles */
        .full-profile-update-section {
            background: linear-gradient(145deg, rgba(76, 175, 80, 0.05) 0%, rgba(33, 150, 243, 0.05) 100%);
            border-radius: 12px;
            padding: 24px;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
        }
        
        .full-profile-update-section:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.12);
        }
        
        .profile-update-description {
            color: #e0e0e0;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .profile-update-benefits {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .benefit-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .benefit-item i {
            color: #4CAF50;
            font-size: 16px;
        }
        
        .benefit-item span {
            color: #e0e0e0;
            font-size: 0.9rem;
        }
        
        .profile-update-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: linear-gradient(90deg, #4CAF50 0%, #2196F3 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            border: none;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
            text-decoration: none;
            text-transform: none;
            letter-spacing: 0.5px;
        }
        
        .profile-update-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            background: linear-gradient(90deg, #43A047 0%, #1E88E5 100%);
        }
        
        .profile-update-btn i:last-child {
            transition: transform 0.3s ease;
        }
        
        .profile-update-btn:hover i:last-child {
            transform: translateX(4px);
        }
        
        @media (max-width: 768px) {
            .full-profile-update-section {
                padding: 20px;
            }
            
            .profile-update-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
        }

        /* Stats Grid Styling */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .stat-item:hover {
            background: rgba(0, 230, 118, 0.08);
            transform: translateY(-3px);
        }

        .stat-label {
            display: block;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }

        .stat-value {
            display: block;
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffffff;
        }

        /* Member ID specific styling - ensure it's white and visible */
        #memberId {
            color: #ffffff !important;
            font-weight: 700 !important;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Coupon Styling - ensure text is white and visible */
        .coupon-container {
            text-align: center;
            padding: 10px;
        }
        
        .coupon-icon {
            font-size: 2.5rem;
            color: #00e676;
            margin-bottom: 15px;
        }
        
        .coupon-status h3 {
            margin-top: 0;
            font-size: 1.3rem;
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .coupon-status p {
            color: rgba(255, 255, 255, 0.9) !important;
        }
        
        .coupon-badge {
            display: inline-block;
            background: rgba(0, 230, 118, 0.2);
            color: #00e676;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            margin: 15px 0;
        }
        
        .coupon-badge.redeemed {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        /* iOS Optimizations */
    </style>
    <!-- Add this in the head section -->
    <script>
    // Global Supabase initialization
    window.supabaseClient = supabase.createClient(
        'https://qhkcrrphsjpytdfqfamq.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoa2NycnBoc2pweXRkZnFmYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzMjQ4NzgsImV4cCI6MjA0OTkwMDg3OH0.S9JT_WmCWYMvSixRq1RrB1UlqXm6fix_riLFYCR3JOI',
        {
            auth: {
                persistSession: true,
                autoRefreshToken: true
            }
        }
    );
    </script>
    <script>
    // Moved and Enhanced sanitizeProfileData function
    function sanitizeProfileData(rawProfile) {
        console.log('[LOG] sanitizeProfileData received rawProfile:', JSON.stringify(rawProfile));
        const source = rawProfile || {};
        // Create a mutable copy. If source is an empty object, profile will be too.
        const profile = JSON.parse(JSON.stringify(source));

        // Ensure all critical fields exist with reasonable defaults

        // Full Name:
        profile.full_name = source.full_name || profile.full_name || '';
        profile.first_name = source.first_name || '';
        profile.last_name = source.last_name || '';
        
        // Username (user email before the @ if not provided)
        profile.username = source.username || '';
        if (!profile.username && profile.email) {
            // Extract username from email as fallback
            profile.username = profile.email.split('@')[0];
        }

        // Membership type
        profile.membership_type = source.membership_type || 'standard';

        // Member ID:
        let tempMemberId = source.member_id; 
        if (typeof tempMemberId === 'string') tempMemberId = tempMemberId.trim();
        let localStorageMemberId = localStorage.getItem('userMemberId');
        if (typeof localStorageMemberId === 'string') localStorageMemberId = localStorageMemberId.trim();
        profile.member_id = tempMemberId || localStorageMemberId || 'Not Available'; // Explicit fallback

        // Phone:
        let tempPhone = source.phone_number || source.phone; // Prefer source.phone_number or source.phone from DB
        if (typeof tempPhone === 'string') tempPhone = tempPhone.trim();
        profile.phone = tempPhone || 'Not provided';

        // Ensure membership_status is set properly
        profile.membership_status = source.membership_status || 'pending';
        
        // Set email_verified flag
        profile.email_verified = !!source.email_verified;
        
        // Email
        profile.email = source.email || '';
        
        // Created and updated timestamps
        profile.created_at = source.created_at || new Date().toISOString();
        profile.updated_at = source.updated_at || new Date().toISOString();
        
        // Car models
        profile.car_models = Array.isArray(source.car_models) ? source.car_models : [];
        
        // Date of birth
        profile.date_of_birth = source.date_of_birth || '';

        // Address fields: Now primarily working with a single full_address string
        profile.full_address = (source.full_address || '').trim();

        // First use the direct individual fields if they exist in the source data
        profile.street = source.street || '';
        profile.city = source.city || '';
        profile.province = source.province || '';
        profile.postal_code = source.postal_code || '';

        // Only try to parse the full_address if we don't have the individual components already
        if (profile.full_address && (!profile.street || !profile.city || !profile.province || !profile.postal_code)) {
            // Regex to capture: (anything for street), (city), (2-letter province), (postal code)
            // This regex assumes the province is 2 uppercase letters and postal code is A1A 1A1 format.
            // It tries to make the street part flexible to include commas.
            const addressRegex = /^(.*?),\s*([^,]+),\s*([A-Z]{2}),\s*([A-Z]\d[A-Z]\s*\d[A-Za-z]\d)$/i;
            const match = profile.full_address.match(addressRegex);

            if (match) {
                profile.street = (match[1] || '').trim();
                profile.city = (match[2] || '').trim();
                profile.province = (match[3] || '').toUpperCase().trim();
                profile.postal_code = (match[4] || '').toUpperCase().trim();
            } else {
                // Fallback for simpler comma splitting if regex doesn't match
                const parts = profile.full_address.split(',').map(part => part.trim());
                if (parts.length >= 1) profile.street = parts[0] || profile.street;
                if (parts.length >= 2) profile.city = parts[1] || profile.city;
                if (parts.length >= 3) profile.province = parts[2] || profile.province;
                if (parts.length >= 4) profile.postal_code = parts[3] || profile.postal_code;
                console.log('[sanitizeProfileData] Regex did not match, used fallback split. Parts:', parts);
            }
        }

        // If we still don't have a full_address but have the components, rebuild it
        if (!profile.full_address && profile.street && profile.city) {
            profile.full_address = `${profile.street}, ${profile.city}${profile.province ? ', ' + profile.province : ''}${profile.postal_code ? ', ' + profile.postal_code : ''}`;
        }
        
        // Keep the address object for backward compatibility
        profile.address = {
            street: profile.street,
            city: profile.city,
            province: profile.province,
            postal_code: profile.postal_code
        };

        console.log('[LOG] sanitizeProfileData returning profile:', JSON.stringify(profile));
        return profile;
    }

    // Global Supabase initialization (if not already moved higher, this is a good place)
    if (!window.supabaseClient) {
        window.supabaseClient = supabase.createClient(
            'https://qhkcrrphsjpytdfqfamq.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoa2NycnBoc2pweXRkZnFmYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzMjQ4NzgsImV4cCI6MjA0OTkwMDg3OH0.S9JT_WmCWYMvSixRq1RrB1UlqXm6fix_riLFYCR3JOI',
            {
                auth: {
                    persistSession: true,
                    autoRefreshToken: true
                }
            }
        );
    }
    </script>
</head>
<body class="dashboard-page">
    <!-- Standard Navigation -->
    <nav>
        <div class="logo">
            <a href="index.html">
                <img src="https://i.ibb.co/fkrdXZK/Logo4-white.png" 
                     alt="Blitz Tesla Club Logo" 
                     loading="lazy" 
                     width="40" 
                     height="40" 
                     style="display: block !important; width: 40px !important; height: 40px !important; border-radius: 8px !important; margin-right: 12px !important; max-width: 40px !important; max-height: 40px !important; opacity: 1 !important; visibility: visible !important; object-fit: contain !important; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2)) !important;"
                     onerror="this.onerror=null; this.src='https://i.postimg.cc/BvmtNLtB/logo.png';">
                <span style="display: inline-block !important; visibility: visible !important; opacity: 1 !important;">BLITZ T CLUB</span>
            </a>
        </div>
        <button class="menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="nav-links">
            <i class="fas fa-bars"></i>
        </button>
        <ul class="nav-links" id="nav-links">
            <!-- Navigation items will be dynamically inserted by navigation.js -->
        </ul>
    </nav>

    <!-- Dashboard Content -->
    <main class="dashboard-container">
        <!-- Welcome Header -->
        <div class="dashboard-header">
            <div class="user-welcome">
                <h1>Welcome, <span id="userFullName"></span></h1>
                <div class="username-display">
                    <span class="username-label">Username:</span>
                    <span id="userUsername"></span>
                </div>
                <div class="status-badge">
                    <span class="status-label">Membership Status:</span>
                    <span id="membershipStatus" data-status="pending"></span>
                    <span class="verification-status" id="verificationStatus"></span>
                </div>
            </div>
            <div class="quick-actions">
                <button class="btn primary-btn" id="membershipCardBtn">
                    <i class="fas fa-id-card"></i>
                    View Membership Card
                </button>
                <!-- Admin Dashboard Button - Only visible to admins -->
                <button class="btn admin-btn" id="adminDashboardBtn" style="display: none;">
                    <i class="fas fa-user-shield"></i>
                    Admin Dashboard
                </button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Profile Completion Alert -->
            <div id="profileCompletionAlert" class="dashboard-card completion-alert hidden" style="display: none !important; visibility: hidden;">
                <div class="card-header">
                    <h2><i class="fas fa-exclamation-circle"></i> Complete Your Profile</h2>
                </div>
                <div class="card-content">
                    <p>Consider completing your profile to enhance your membership experience:</p>
                    <div class="missing-info-list" id="missingInfoList">
                        <!-- Missing fields will be listed here dynamically -->
                    </div>
                    <div class="completion-actions">
                        <a href="profile-completion.html" class="btn primary-btn">
                            <i class="fas fa-user-edit"></i> Complete Profile
                        </a>
                    </div>
                </div>
            </div>

            <!-- Upcoming Events Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-calendar"></i> Upcoming Events</h2>
                    <a href="events.html" class="view-all">View All</a>
                </div>
                <div class="card-content" id="upcomingEventsList">
                    <p class="no-events">No upcoming events at this time</p>
                </div>
            </div>

            <!-- Member Stats Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-line"></i> Member Stats</h2>
                </div>
                <div class="card-content">
                    <div class="stat-grid">
                        <div class="stat-item">
                            <span class="stat-label">Member Since</span>
                            <span class="stat-value" id="memberSince">Loading...</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Member ID</span>
                            <span class="stat-value" id="memberId" style="font-family: monospace; font-weight: bold;"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Events Attended</span>
                            <span class="stat-value" id="eventsAttended">0</span>
                        </div>
                    </div>
                    
                    <!-- Remove the profile completion status section -->
                </div>
            </div>

            <!-- Quick Links Card (now before Member Coupon) -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-link"></i> Quick Links</h2>
                </div>
                <div class="card-content">
                    <div class="quick-links-grid">
                        <a href="events.html" id="registerEvent" class="quick-link-item">
                            <i class="fas fa-calendar-plus"></i>
                            <span>Register for Event</span>
                        </a>
                        <a href="javascript:void(0)" id="viewInvoices" class="quick-link-item">
                            <i class="fas fa-file-invoice"></i>
                            <span>
                              View Invoices 
                              <small class="badge upcoming">Coming Soon</small>
                            </span>
                        </a>
                        <a href="#" class="quick-link-item" id="accountSettingsBtn">
                            <i class="fas fa-cog"></i>
                            <span>Account Settings</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Member Coupon Card (now after Quick Links) -->
            <div class="dashboard-card" id="couponCard">
                <div class="card-header">
                    <h2><i class="fas fa-ticket-alt"></i> Member Coupon</h2>
                </div>
                <div class="card-content">
                    <div class="coupon-container">
                        <div class="coupon-status" id="couponStatus">
                            <div class="coupon-icon">
                                <i class="fas fa-gift"></i>
                            </div>
                            <h3 style="color: #ffffff !important;">Club Event Item Coupon</h3>
                            <p style="color: rgba(255, 255, 255, 0.9) !important;">As a valued member, you receive one coupon to redeem for an exclusive club event item.</p>
                            <div class="coupon-badge" id="couponBadge">Available</div>
                            <button class="btn primary-btn" id="redeemCouponBtn">
                                <i class="fas fa-ticket-alt"></i> Redeem Coupon
                            </button>
                        </div>
                        <div class="coupon-redeemed" id="couponRedeemed" style="display: none;">
                            <div class="coupon-icon redeemed">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3>Coupon Redeemed</h3>
                            <p>You've already redeemed your club event item coupon.</p>
                            <div class="coupon-badge redeemed">Redeemed</div>
                            <div class="redemption-info">
                                <p>Redeemed on: <span id="redemptionDate">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Standard Footer -->
    <footer>
        <div class="footer-content">
        
            
            <div class="footer-section">
                <h3>Quick Links</h3>
                <div class="footer-links">
                    <a href="index.html">Home</a>
                    <a href="events.html">Events</a>
                    <a href="gallery.html">Gallery</a>
                    <a href="contact.html">Contact</a>
                    <a href="faq.html">FAQ</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Member Area</h3>
                <div class="footer-links">
                    <a href="sponsors.html">Our Sponsors</a>
                    <a href="member-benefits.html">Member Benefits</a>
                    <a href="#" id="footerLogoutBtn">Logout</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Legal</h3>
                <div class="footer-links">
                    <a href="privacy.html">Privacy Policy</a>
                    <a href="terms.html">Terms of Service</a>
                    <a href="about.html">About Us</a>
                </div>
            </div>

            <div class="footer-section">
                <h3>Connect With Us</h3>
                <div class="footer-social">
                    <a href="https://x.com/BlitzTClub" target="_blank" aria-label="Follow us on X">
                        <i class="fa-brands fa-square-x-twitter"></i>
                    </a>
                    <a href="https://www.instagram.com/blitztclub/" target="_blank" aria-label="Follow us on Instagram">
                        <i class="fab fa-instagram"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <p>© 2025 Blitz T Club. All rights reserved.</p>
            <p class="powered-by">
                Website powered by <a href="http://www.summitpixels.com" target="_blank">SummitPixels</a>
            </p>
        </div>
    </footer>

    <!-- Keep your existing script -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Check for any pending account deletion requests
            const pendingDeletion = localStorage.getItem('pendingAccountDeletion');
            const deletionTime = localStorage.getItem('deletionRequestTime');
            
            if (pendingDeletion && navigator.onLine && window.location.protocol !== 'file:') {
                console.log('Found pending account deletion request from:', deletionTime);
                
                try {
                    // Check if we're on localhost or a deployed server
                    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                    const apiUrl = isLocalhost
                        ? 'http://localhost:3000/api/cleanup-orphaned-users'
                        : '/api/cleanup-orphaned-users';
                    
                    console.log('Processing pending deletion via API:', apiUrl);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: pendingDeletion
                        })
                    });
                    
                    if (response.ok) {
                        console.log('Successfully processed pending account deletion');
                        // Clear the pending deletion
                        localStorage.removeItem('pendingAccountDeletion');
                        localStorage.removeItem('deletionRequestTime');
                    } else {
                        console.warn('Could not process pending deletion - will try again later');
                    }
                } catch (error) {
                    console.error('Error processing pending deletion:', error);
                }
            }
            
            // Initialize navigation first - let the navigation.js handle all menu functionality
            console.log('Waiting for navigation.js to initialize...');
            
            // Check if user is logged in
            const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
            
            console.log('Session:', session);
            
            if (!session) {
                // Don't immediately redirect, try to refresh the session first
                try {
                    console.log('No session found, attempting to refresh...');
                    const { data: refreshData, error: refreshError } = await supabaseClient.auth.refreshSession();
                    
                    if (refreshError || !refreshData.session) {
                        console.log('Session refresh failed, showing error message before redirect');
                        const errorDisplay = document.getElementById('errorNotification');
                        if (errorDisplay) {
                            errorDisplay.querySelector('.error-message').textContent = 
                                'Your session has expired. Please log in again.';
                            errorDisplay.style.display = 'flex';
                        }
                        
                        // Delay redirect to allow user to see error message
                        setTimeout(() => {
                window.location.href = 'login.html';
                        }, 5000); // Increased from 3000 to 5000ms
                return;
                    } else {
                        console.log('Session refreshed successfully:', refreshData.session);
                        // Continue with the refreshed session
                    }
                } catch (refreshException) {
                    console.error('Exception during session refresh:', refreshException);
                    
                    // Check for network errors which may be temporary
                    if (refreshException instanceof TypeError && refreshException.message.includes('network')) {
                        console.log('Network error during refresh. Showing temporary message.');
                        const errorDisplay = document.getElementById('errorNotification');
                        if (errorDisplay) {
                            errorDisplay.querySelector('.error-message').textContent = 
                                'Network error detected. Please check your connection.';
                            errorDisplay.style.display = 'flex';
                            setTimeout(() => errorDisplay.style.display = 'none', 5000);
                        }
                        
                        // Don't redirect - user may recover when network returns
                        return;
                    }
                    
                    // Delay redirect to allow error to be seen
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 5000); // Increased from 3000 to 5000ms
                    return;
                }
            }

                // Get user profile
                const { data: userData, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', session.user.id) // Use UUID instead of email
                    .single();

                console.log('Fetching profile for user ID:', session.user.id);
                console.log('Profile query result:', { profile: userData, profileError });

            let profileDataToSanitize;

            if (profileError && profileError.code === 'PGRST116') {
                    // Profile doesn't exist, try to fetch by email before creating a new one
                    console.log('No profile found by ID, trying email fallback...');
                    const { data: emailProfileData, error: emailProfileError } = await supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('email', session.user.email)
                        .single();
                        
                    if (!emailProfileError && emailProfileData) {
                        console.log('Found profile by email, updating with correct ID...');
                        // Update the profile to have the correct ID
                        const { error: updateError } = await supabaseClient
                            .from('profiles')
                            .update({ id: session.user.id })
                            .eq('email', session.user.email);
                            
                        if (updateError) {
                            console.warn('Could not update profile ID, but will use existing profile:', updateError);
                        }
                        
                        profileDataToSanitize = emailProfileData;
                    } else {
                        // Profile doesn't exist by ID or email, create one
                        console.log('No profile found by ID or email, creating new profile...');
                        
                        try {
                            const memberId = await generateSequentialMemberId();
                
                const { data: newProfile, error: createError } = await supabaseClient
                        .from('profiles')
                    .insert([
                        {
                            id: session.user.id,
                            email: session.user.email,
                            full_name: session.user.user_metadata?.full_name || session.user.email.split('@')[0],
                            username: session.user.email.split('@')[0],
                            membership_status: 'pending',
                            membership_type: 'standard',
                                        member_id: memberId,
                            created_at: new Date().toISOString()
                        }
                    ])
                        .select()
                        .single();

                if (createError) {
                    console.error('Error creating profile:', createError);
                                
                                // Attempt to handle duplicate key errors gracefully
                                if (createError.code === '23505') { // PostgreSQL duplicate key error
                                    console.log('Profile exists but could not be fetched. Using session data for display.');
                                    // Create a basic profile from session data as fallback
                                    profileDataToSanitize = {
                                        id: session.user.id,
                                        email: session.user.email,
                                        full_name: session.user.user_metadata?.full_name || session.user.email.split('@')[0],
                                        username: session.user.email.split('@')[0],
                                        membership_status: 'pending',
                                        membership_type: 'standard',
                                        created_at: new Date().toISOString()
                                    };
                                    
                                    // Show error but don't log out
                                    const errorDisplay = document.getElementById('errorNotification');
                                    if (errorDisplay) {
                                        errorDisplay.querySelector('.error-message').textContent = 
                                            'Could not load your complete profile. Some features may be limited.';
                                        errorDisplay.style.display = 'flex';
                                        setTimeout(() => errorDisplay.style.display = 'none', 5000);
                                    }
                                } else {
                                    // For non-duplicate errors, show message but don't log out
                                    const errorDisplay = document.getElementById('errorNotification');
                                    if (errorDisplay) {
                                        errorDisplay.querySelector('.error-message').textContent = 
                                            'Error loading your profile: ' + createError.message;
                                        errorDisplay.style.display = 'flex';
                                        setTimeout(() => errorDisplay.style.display = 'none', 5000);
                                    }
                                    
                                    // Use fallback profile from session
                                    profileDataToSanitize = {
                                        id: session.user.id,
                                        email: session.user.email,
                                        full_name: session.user.user_metadata?.full_name || session.user.email.split('@')[0],
                                        username: session.user.email.split('@')[0],
                                        membership_status: 'pending',
                                        membership_type: 'standard',
                                        created_at: new Date().toISOString()
                                    };
                                }
                            } else {
                profileDataToSanitize = newProfile;
                console.log('New profile created (before sanitization):', newProfile);
                            }
                        } catch (createException) {
                            console.error('Exception during profile creation:', createException);
                            
                            // Use fallback profile from session
                            profileDataToSanitize = {
                                id: session.user.id,
                                email: session.user.email,
                                full_name: session.user.user_metadata?.full_name || session.user.email.split('@')[0],
                                username: session.user.email.split('@')[0],
                                membership_status: 'pending',
                                membership_type: 'standard',
                                created_at: new Date().toISOString()
                            };
                            
                            // Show error but don't log out
                            const errorDisplay = document.getElementById('errorNotification');
                            if (errorDisplay) {
                                errorDisplay.querySelector('.error-message').textContent = 
                                    'Could not create your profile. Using basic information.';
                                errorDisplay.style.display = 'flex';
                                setTimeout(() => errorDisplay.style.display = 'none', 5000);
                            }
                        }
                    }
            } else if (profileError) {
                    // Other profile fetch error - don't log out, just show error and use session data
                console.error('Error fetching profile:', profileError);
                    
                    const errorDisplay = document.getElementById('errorNotification');
                    if (errorDisplay) {
                        errorDisplay.querySelector('.error-message').textContent = 
                            'Could not load your profile data. Using basic information.';
                        errorDisplay.style.display = 'flex';
                        setTimeout(() => errorDisplay.style.display = 'none', 5000);
                    }
                    
                    // Create fallback profile from session data
                    profileDataToSanitize = {
                        id: session.user.id,
                        email: session.user.email,
                        full_name: session.user.user_metadata?.full_name || session.user.email.split('@')[0],
                        username: session.user.email.split('@')[0],
                        membership_status: 'pending',
                        membership_type: 'standard',
                        created_at: new Date().toISOString()
                    };
                } else {
                profileDataToSanitize = userData;
            }

            // Sanitize the initially fetched data specifically for UI display purposes first
            const initialDisplayProfile = sanitizeProfileData(JSON.parse(JSON.stringify(profileDataToSanitize))); // Use a deep copy for safety
            console.log('[LOG] Initial profile data for direct UI display:', JSON.stringify(initialDisplayProfile));

            // BEGIN: INTEGRATED STATIC NODE CREATION FOR NAME AND MEMBER ID
            try {
                const staticNameText = (initialDisplayProfile.full_name || 'Member').trim();
                const staticMemberIdText = (initialDisplayProfile.member_id || 'Not Available').trim();

                const userFullNameNode = document.createTextNode(staticNameText);
                // const memberIdNode = document.createTextNode(staticMemberIdText); // We will create this inside the new span

                const userFullNameElement = document.getElementById('userFullName');
                if (userFullNameElement && userFullNameElement.parentNode) {
                    userFullNameElement.parentNode.replaceChild(userFullNameNode, userFullNameElement);
                } else {
                    console.warn('userFullName element or its parent not found for static replacement.');
                }

                // Create a new styled span for the Member ID
                const newMemberIdSpan = document.createElement('span');
                newMemberIdSpan.className = 'stat-value'; // Preserve original class
                newMemberIdSpan.id = 'memberId'; // Re-assign ID to the new span
                newMemberIdSpan.style.fontFamily = 'monospace'; // Preserve original style
                newMemberIdSpan.style.fontWeight = 'bold';   // Preserve original style
                newMemberIdSpan.style.color = 'black';       // Apply new black color
                newMemberIdSpan.appendChild(document.createTextNode(staticMemberIdText)); // Add the text

                const originalMemberIdElement = document.getElementById('memberId');
                if (originalMemberIdElement && originalMemberIdElement.parentNode) {
                    // Replace the original memberId element with our new styled span
                    originalMemberIdElement.parentNode.replaceChild(newMemberIdSpan, originalMemberIdElement);
                } else {
                    // This fallback might be tricky if the element was already replaced or doesn't exist.
                    // However, if the goal is to ensure it *becomes* black if it somehow exists and wasn't replaced:
                    console.warn('Original memberId element or its parent not found for static replacement with new styled span.');
                    const miEl = document.getElementById('memberId'); // Try to find it again
                    if (miEl) { // If it exists (e.g. replacement failed)
                        miEl.textContent = staticMemberIdText;
                        miEl.style.color = 'black';
                        if (!miEl.classList.contains('stat-value')) miEl.classList.add('stat-value');
                        miEl.style.fontFamily = 'monospace';
                        miEl.style.fontWeight = 'bold';
                    }
                }
            } catch (e) {
                console.error('Error creating static nodes for name/ID:', e);
                // Fallback if replacement fails, set text content directly (though this is what we try to avoid flickering on)
                const ufnEl = document.getElementById('userFullName');
                if (ufnEl) ufnEl.textContent = (initialDisplayProfile.full_name || 'Member').trim();
                const miEl = document.getElementById('memberId');
                if (miEl) miEl.textContent = (initialDisplayProfile.member_id || 'Not Available').trim();
            }
            // END: INTEGRATED STATIC NODE CREATION

            // The rest of the original DOMContentLoaded logic that uses initialDisplayProfile for OTHER elements continues here
            const statusElement = document.getElementById('membershipStatus');
            if (statusElement) {
                // For status, it's okay to use initialDisplayProfile too, as updateStatusDisplay will refresh it later.
                statusElement.textContent = initialDisplayProfile.membership_status ? 
                    initialDisplayProfile.membership_status.charAt(0).toUpperCase() + initialDisplayProfile.membership_status.slice(1) : 
                    'Pending';
                statusElement.dataset.status = initialDisplayProfile.membership_status || 'pending';
            }

            // Update member stats - Use `initialDisplayProfile`
            const memberSinceEl = document.getElementById('memberSince');
            if (memberSinceEl) {
                memberSinceEl.textContent = initialDisplayProfile.created_at ? 
                    new Date(initialDisplayProfile.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'Not Available';
            }

            const eventsAttendedEl = document.getElementById('eventsAttended');
            if (eventsAttendedEl) {
                eventsAttendedEl.textContent = initialDisplayProfile.events_attended || '0';
            }
            
            // Now, set up the global window.userProfile which CAN be updated by updateStatusDisplay
            // This ensures that other parts of the app (modals, etc.) use the potentially more up-to-date global profile.
            window.userProfile = sanitizeProfileData(profileDataToSanitize); // Or just use initialDisplayProfile if deep copy was done correctly
            console.log('[LOG] Global window.userProfile initialized:', JSON.stringify(window.userProfile));

            // Function to update status display
            const updateStatusDisplay = async () => {
                try {
                    console.log('[LOG] Refreshing profile data and status display...');
                    
                    // Get current user session
                    const { data: sessionData, error: sessionError } = await window.supabaseClient.auth.getSession();
                    
                    if (sessionError || !sessionData.session) {
                        console.error('Error getting session or user not authenticated:', sessionError);
                        window.performLogout({
                            showMessage: true,
                            redirectDelay: 5000
                        }); // Log out user if session can't be fetched with delay
                        return;
                    }
                    
                    const user = sessionData.session.user;
                    console.log('[LOG] Current user email for profile fetch:', user.email);
                    
                    // Fetch latest profile data from Supabase - use id as primary identifier, email as fallback
                    const { data: latestProfile, error: profileError } = await window.supabaseClient
                        .from('profiles')
                    .select('*')
                        .eq('id', user.id)
                        .single();

                    if (profileError) {
                        console.error('Error fetching profile by ID, trying email as fallback:', profileError);
                        
                        // Try fetching by email as fallback
                        const { data: emailProfile, error: emailProfileError } = await window.supabaseClient
                            .from('profiles')
                            .select('*')
                            .eq('email', user.email)
                            .single();
                        
                        if (emailProfileError) {
                            console.error('Error fetching profile by email:', emailProfileError);
                        return;
                    }

                        if (!emailProfile) {
                        console.warn('No profile data found during status update');
                        return;
                    }

                        console.log('[LOG] Profile found by email instead of ID');
                        window.userProfile = sanitizeProfileData(emailProfile);
                    } else if (!latestProfile) {
                        console.warn('No profile data found during status update');
                        return;
                    } else {
                    console.log('[LOG] updateStatusDisplay fetched latestProfile:', JSON.stringify(latestProfile));
                    // Update the global profile data - Sanitize it before assignment
                    window.userProfile = sanitizeProfileData(latestProfile);
                    }
                    
                    console.log('[LOG] updateStatusDisplay RE-SANITIZED window.userProfile:', JSON.stringify(window.userProfile));

                    // Update verification status display
                    const verificationStatus = document.getElementById('verificationStatus');
                    const statusElement = document.getElementById('membershipStatus');

                    if (!verificationStatus || !statusElement) {
                        console.warn('Status elements not found');
                    } else {
                    // Use the now re-sanitized window.userProfile data for status display logic
                        if (window.userProfile.membership_status === 'active' || 
                            window.userProfile.email_verified === true) {
                            
                            console.log('[LOG] User is verified - updating status display to ACTIVE');
                        verificationStatus.innerHTML = `
                            <span class="badge success">
                                <i class="fas fa-check-circle"></i>
                                Email verified
                            </span>
                        `;
                        statusElement.textContent = 'Active';
                        statusElement.className = 'status-active';
                            statusElement.dataset.status = 'active';
                } else {
                            console.log('[LOG] User is NOT verified - status remains PENDING');
                        verificationStatus.innerHTML = `
                            <span class="badge warning">
                                <i class="fas fa-envelope"></i>
                                Please verify your email
                                <button id="resendVerification" class="resend-btn">
                                    <i class="fas fa-redo"></i> Resend Verification
                                </button>
                            </span>
                        `;
                        statusElement.textContent = 'Pending';
                        statusElement.className = 'status-pending';
                            statusElement.dataset.status = 'pending';
                        }
                    }

                    // Always update these key display elements to ensure they show the latest data
                    const userFullNameEl = document.getElementById('userFullName');
                    if (userFullNameEl) {
                        console.log('[updateStatusDisplay] Setting userFullName. Value from window.userProfile.full_name:', window.userProfile.full_name);
                        userFullNameEl.textContent = window.userProfile.full_name || 'Member'; // Fallback to 'Member' if empty
                    }
                    
                    const memberIdEl = document.getElementById('memberId');
                    if (memberIdEl) {
                        console.log('[updateStatusDisplay] Setting memberId. Value from window.userProfile.member_id:', window.userProfile.member_id);
                        memberIdEl.textContent = window.userProfile.member_id || 'Not Available'; // Fallback if undefined/empty
                        memberIdEl.style.color = 'black';
                        memberIdEl.style.fontFamily = 'monospace';
                        memberIdEl.style.fontWeight = 'bold';
                    }
                    
                    // Update member stats with latest data
                    const memberSinceEl = document.getElementById('memberSince');
                    if (memberSinceEl && window.userProfile.created_at) {
                        memberSinceEl.textContent = new Date(window.userProfile.created_at).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }

                    const eventsAttendedEl = document.getElementById('eventsAttended');
                    if (eventsAttendedEl) {
                        eventsAttendedEl.textContent = window.userProfile.events_attended || '0';
                    }
                    
                    // Ensure modals have the latest data too (for account settings display)
                    const modalUserEmail = document.getElementById('modalUserEmail');
                    if (modalUserEmail) modalUserEmail.textContent = window.userProfile?.email || 'Not available';
                    
                    const modalMemberId = document.getElementById('modalMemberId');
                    if (modalMemberId) modalMemberId.textContent = window.userProfile?.member_id || 'Not Available';
                    
                    const modalMemberSince = document.getElementById('modalMemberSince');
                    if (modalMemberSince && window.userProfile.created_at) {
                        modalMemberSince.textContent = new Date(window.userProfile.created_at).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                    
                    const modalMembershipStatus = document.getElementById('modalMembershipStatus');
                    if (modalMembershipStatus) {
                        const status = window.userProfile?.membership_status || 'Pending';
                        modalMembershipStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    }
                    
                    const modalPhoneNumber = document.getElementById('modalPhoneNumber');
                    if (modalPhoneNumber) modalPhoneNumber.textContent = window.userProfile?.phone || 'Not provided';
                    
                    // Update address fields directly without relying on the address object
                    const elements = {
                        street: document.getElementById('editStreet'),
                        city: document.getElementById('editCity'),
                        province: document.getElementById('editProvince'),
                        postalCode: document.getElementById('editPostalCode')
                    };
                    
                    if (elements.street) elements.street.value = window.userProfile?.street || '';
                    if (elements.city) elements.city.value = window.userProfile?.city || '';
                    if (elements.province) elements.province.value = window.userProfile?.province || '';
                    if (elements.postalCode) elements.postalCode.value = window.userProfile?.postal_code || '';
                    
                    // Update the car models display if available
                    const carModelsElement = document.getElementById('carModelsDetails');
                    if (carModelsElement && window.userProfile?.car_models && 
                        Array.isArray(window.userProfile.car_models) && 
                        window.userProfile.car_models.length > 0) {
                        
                        let carModelsHtml = '';
                        window.userProfile.car_models.forEach(model => {
                            carModelsHtml += `<div>${model}</div>`;
                        });
                        carModelsElement.innerHTML = carModelsHtml;
                    }
                    
                    // Update the username display
                    const userUsernameEl = document.getElementById('userUsername');
                    if (userUsernameEl) {
                        console.log('[updateStatusDisplay] Setting username. Value from window.userProfile.username:', window.userProfile.username);
                        userUsernameEl.textContent = window.userProfile.username || window.userProfile.email?.split('@')[0] || 'member'; 
                    }
            } catch (error) {
                    console.error('Error updating status display:', error);
                }
            };

            // Initial status update (with a slight delay to allow primary UI to render but BEFORE the interval)
            setTimeout(async () => {
                await updateStatusDisplay();
            }, 200);

            // Set interval for periodic updates - increase frequency to 10 seconds for better responsiveness
            setInterval(updateStatusDisplay, 10000);

            // Handle logout - KEEP THIS OUTSIDE OF TRY/CATCH BLOCKS
            const logoutButtons = document.querySelectorAll('#logoutBtn, #footerLogoutBtn');
            logoutButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Call our direct logout function with explicit user action
                    window.performLogout({
                        showMessage: true,
                        redirectDelay: 2000 // Shorter delay for user-initiated logout
                    });
                });
            });

            // Add this after profile data is loaded
            const membershipCardBtn = document.getElementById('membershipCardBtn');
            const modal = document.getElementById('membershipCardModal');
            const closeModalBtn = document.querySelector('.close-modal');

            membershipCardBtn.addEventListener('click', () => {
                // Format date for card display
                const formattedDate = window.userProfile.created_at ? 
                    new Date(window.userProfile.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'Not Available';

                // Get the member ID from all possible sources
                const storedMemberId = localStorage.getItem('userMemberId');
                const cardMemberId = window.userProfile.member_id || 
                                  session.user.user_metadata?.member_id || 
                                  storedMemberId || 
                                  'Not Available';
                
                console.log('Member ID for card display:', {
                    profileId: window.userProfile.member_id,
                    metadataId: session.user.user_metadata?.member_id,
                    localStorageId: storedMemberId,
                    using: cardMemberId
                });

                // Update card info
                document.getElementById('cardFullName').textContent = window.userProfile.full_name;
                document.getElementById('cardMemberId').textContent = cardMemberId;
                document.getElementById('cardMemberSince').textContent = formattedDate;
                document.getElementById('cardMembershipStatus').textContent = 
                    window.userProfile.membership_type.charAt(0).toUpperCase() + window.userProfile.membership_type.slice(1);

                // Set card style based on membership type
                const cardElement = document.querySelector('.membership-card');
                cardElement.dataset.type = window.userProfile.membership_type;

                // Generate QR code
                const qrUrl = `https://blitztclub.com/verify-member.html?member_id=${window.userProfile.id}`;
                const qrCanvas = document.getElementById('memberQRCode');
                // Clear previous QR code if any
                const context = qrCanvas.getContext('2d');
                context.clearRect(0, 0, qrCanvas.width, qrCanvas.height);
                QRCode.toCanvas(qrCanvas, qrUrl, {
                    width: 120,
                    margin: 0,
                    color: {
                        dark: '#171a20',
                        light: '#ffffff'
                    }
                });
                // Remove the old QR code URL preview and create a modern button
                let qrTextDiv = document.getElementById('qrCodeUrlPreview');
                if (qrTextDiv) {
                    qrTextDiv.remove();
                }

                // Remove any existing copy button to prevent duplicates
                const existingBtn = document.getElementById('copyQrLinkBtn');
                if (existingBtn) {
                    existingBtn.remove();
                }

                // Create a "Copy Link" button instead of showing the URL
                const copyBtn = document.createElement('button');
                copyBtn.id = 'copyQrLinkBtn';
                copyBtn.className = 'copy-link-btn';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy Verification Link';
                qrCanvas.parentNode.appendChild(copyBtn);

                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(qrUrl).then(() => {
                        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        setTimeout(() => {
                            // Check if the button still exists before trying to update it
                            if (document.getElementById('copyQrLinkBtn')) {
                                copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy Verification Link';
                            }
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                        alert('Failed to copy link.');
                    });
                });

                modal.classList.add('show');
            });

            // Close modal when clicking the X button
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                    modal.classList.remove('show');
                });
            }

            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });

            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('show')) {
                    modal.classList.remove('show');
                }
            });

            // Handle account settings
            const accountSettingsBtn = document.getElementById('accountSettingsBtn');
            const editProfileModal = document.getElementById('editProfileModal');
            const modalEditProfileForm = document.getElementById('modalEditProfileForm');
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');
            
            // Show modal when Account Settings link is clicked
            accountSettingsBtn.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Logs for debugging (can be removed later)
                console.log('[LOG] Account Settings Modal: window.userProfile type:', typeof window.userProfile);
                if (window.userProfile) {
                    // Log both individual address fields and the address object for compatibility
                    console.log('[LOG] Account Settings Modal: Address fields:',
                        JSON.stringify({
                            street: window.userProfile.street,
                            city: window.userProfile.city,
                            province: window.userProfile.province,
                            postal_code: window.userProfile.postal_code,
                            full_address: window.userProfile.full_address
                        })
                    );
                    console.log('[LOG] Account Settings Modal: Backward compatibility address object:', JSON.stringify(window.userProfile.address));
                    console.log('[LOG] Account Settings Modal: window.userProfile keys:', Object.keys(window.userProfile).join(', '));
                    console.log('[LOG] Account Settings Modal: window.userProfile.full_name:', window.userProfile.full_name);
                    console.log('[LOG] Account Settings Modal: window.userProfile.member_id:', window.userProfile.member_id);
                }

                // Populate general account information
                document.getElementById('modalUserEmail').textContent = window.userProfile?.email || 'Not available';
                
                // Add username display
                const usernameElement = document.getElementById('modalUsername');
                if (usernameElement) {
                    usernameElement.textContent = window.userProfile?.username || window.userProfile?.email?.split('@')[0] || 'Not available';
                }
                
                document.getElementById('modalMemberId').textContent = window.userProfile?.member_id || 'Not Available';
                document.getElementById('modalMemberSince').textContent = window.userProfile?.created_at ? 
                    new Date(window.userProfile.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Not Available';
                document.getElementById('modalMembershipStatus').textContent = window.userProfile?.membership_status ?
                    window.userProfile.membership_status.charAt(0).toUpperCase() + window.userProfile.membership_status.slice(1) : 'Pending';
                document.getElementById('modalPhoneNumber').textContent = window.userProfile?.phone || 'Not provided'; // Uses sanitized phone
                
                // Date of birth
                if (window.userProfile?.date_of_birth) {
                    const [year, month, day] = window.userProfile.date_of_birth.split('-');
                    const dobDate = new Date(year, month - 1, day);
                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                    const dateString = dobDate.toLocaleDateString('en-US', options);
                    const dayWithSuffix = dateString.replace(/(\\d+),/, (_, dayNum) => getOrdinalSuffix(dayNum) + ',');
                    document.getElementById('modalDateOfBirth').textContent = dayWithSuffix;
                } else {
                    document.getElementById('modalDateOfBirth').textContent = 'Not provided';
                }
                
                // Car models
                const carModelsContainer = document.getElementById('modalCarModels');
                carModelsContainer.innerHTML = ''; // Clear previous
                if (window.userProfile?.car_models && Array.isArray(window.userProfile.car_models) && window.userProfile.car_models.length > 0) {
                    window.userProfile.car_models.forEach(model => {
                        const badge = document.createElement('div');
                        badge.className = 'car-model-badge';
                        badge.innerHTML = `<i class="fas fa-car"></i> ${model}`;
                        carModelsContainer.appendChild(badge);
                    });
                } else {
                    carModelsContainer.innerHTML = '<p>No Tesla models provided</p>';
                }
                
                // Address Display Logic
                const addressContainer = document.getElementById('modalAddress');
                const addressUpdateForm = document.getElementById('addressUpdateForm');
                // const userAddr = window.userProfile?.address; // We'll use window.userProfile.street etc. directly or from the guaranteed window.userProfile.address object

                // Populate form fields (will be used when 'Edit' is clicked)
                // These should refer to the top-level sanitized properties which are the source of truth,
                // which are now parsed from full_address by sanitizeProfileData.
                document.getElementById('editStreet').value = window.userProfile?.street || '';
                document.getElementById('editCity').value = window.userProfile?.city || '';
                document.getElementById('editProvince').value = window.userProfile?.province || '';
                document.getElementById('editPostalCode').value = window.userProfile?.postal_code || '';

                const displayAddress = () => {
                    // Check if we have address components
                    const hasAddress = window.userProfile?.street || window.userProfile?.full_address;
                    
                    if (hasAddress) {
                        // First try to use full_address if available
                        if (window.userProfile?.full_address) {
                            addressContainer.innerHTML = `<address>${window.userProfile.full_address.replace(/\n/g, '<br>')}</address>
                            <button type="button" class="edit-info-btn" id="editAddressBtn_modal" style="margin-top: 10px;">
                                <i class="fas fa-edit"></i> Edit Address
                            </button>`;
                        } else {
                            // Otherwise construct from components
                            const street = window.userProfile?.street || '';
                            const city = window.userProfile?.city || '';
                            const province = window.userProfile?.province || '';
                            const postalCode = window.userProfile?.postal_code || '';
                            
                            // Only show if we have at least street and city
                            if (street && city) {
                                const formattedAddress = `${street}<br>${city}${province ? ', ' + province : ''}${postalCode ? ' ' + postalCode : ''}`;
                                
                                addressContainer.innerHTML = `<address>${formattedAddress}</address>
                                <button type="button" class="edit-info-btn" id="editAddressBtn_modal" style="margin-top: 10px;">
                                <i class="fas fa-edit"></i> Edit Address
                                </button>`;
                            } else {
                                // Not enough address components
                                addressContainer.innerHTML = `
                                <p>Incomplete address information.</p>
                                <button type="button" class="edit-info-btn" id="addAddressInfoBtn_modal">
                                <i class="fas fa-plus-circle"></i> Complete Address Information
                                </button>`;
                            }
                        }
                        
                        addressUpdateForm.style.display = 'none';
                        addressContainer.style.display = 'block';

                        // Add event listener to the edit button
                        const editBtn = document.getElementById('editAddressBtn_modal');
                        if (editBtn) {
                            editBtn.onclick = () => {
                                // Fill in form fields with current values
                                document.getElementById('editStreet').value = window.userProfile?.street || '';
                                document.getElementById('editCity').value = window.userProfile?.city || '';
                                document.getElementById('editProvince').value = window.userProfile?.province || '';
                                document.getElementById('editPostalCode').value = window.userProfile?.postal_code || '';
                                
                                addressUpdateForm.style.display = 'block';
                                addressContainer.style.display = 'none';
                            };
                    }
                } else {
                        // No address information
                    addressContainer.innerHTML = `
                            <p>No address information on file.</p>
                            <button type="button" class="edit-info-btn" id="addAddressInfoBtn_modal">
                                <i class="fas fa-plus-circle"></i> Add Address Information
                        </button>`;
                        
                        addressUpdateForm.style.display = 'none';
                        addressContainer.style.display = 'block';

                        const addBtn = document.getElementById('addAddressInfoBtn_modal');
                        if (addBtn) {
                            addBtn.onclick = () => {
                                // Clear form fields for new entry
                                document.getElementById('editStreet').value = '';
                                document.getElementById('editCity').value = '';
                                document.getElementById('editProvince').value = '';
                                document.getElementById('editPostalCode').value = '';
                                
                                addressUpdateForm.style.display = 'block';
                                addressContainer.style.display = 'none';
                            };
                        }
                    }
                };

                displayAddress(); // Initial display of address section

                // Form submission logic for address
                addressUpdateForm.onsubmit = async (event) => {
                    event.preventDefault();
                    const saveChangesBtn = addressUpdateForm.querySelector('button[type="submit"]');
                    saveChangesBtn.disabled = true;
                    saveChangesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                    const street = document.getElementById('editStreet').value.trim();
                    const city = document.getElementById('editCity').value.trim();
                    const province = document.getElementById('editProvince').value; // Select, no trim needed
                    let postalCode = document.getElementById('editPostalCode').value.trim().toUpperCase();

                    if (!street || !city || !province || !postalCode) {
                        alert('Please fill in all address fields.');
                        saveChangesBtn.disabled = false;
                        saveChangesBtn.innerHTML = 'Save Changes';
                        return;
                    }

                    // Canadian Postal Code Regex (flexible with or without space/hyphen)
                    const postalCodeRegex = /^[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d$/;
                    if (!postalCodeRegex.test(postalCode)) {
                        alert('Invalid Postal Code format. Please use A1A 1A1 or A1A1A1.');
                        saveChangesBtn.disabled = false;
                        saveChangesBtn.innerHTML = 'Save Changes';
                        return;
                    }
                    // Format to A1A 1A1 for the postal code part of the string
                    postalCode = postalCode.replace(/([A-Za-z]\d[A-Za-z])[\s\-]?(\d[A-Za-z]\d)/, '$1 $2');

                    // Concatenate into a single full_address string
                    // Note: This format should ideally match how it's parsed in sanitizeProfileData
                    const newFullAddress = `${street}, ${city}, ${province}, ${postalCode}`;

                    try {
                        const updatesToSave = {
                            street: street,
                            city: city,
                            province: province,
                            postal_code: postalCode,
                            full_address: newFullAddress, // Saving the single concatenated string
                            updated_at: new Date().toISOString()
                        };

                        console.log('[VERY IMPORTANT LOG] Object being sent to Supabase update for address:', JSON.stringify(updatesToSave)); 

                        const { data, error } = await supabaseClient
                            .from('profiles')
                            .update(updatesToSave) // Update both individual fields and full_address
                            .eq('id', session.user.id)
                            .select() 
                            .single();

                        if (error) throw error;

                        if (data) {
                            // Update global userProfile with the new address data
                            window.userProfile.full_address = data.full_address;
                            window.userProfile.street = street;
                            window.userProfile.city = city;
                            window.userProfile.province = province;
                            window.userProfile.postal_code = postalCode;
                            window.userProfile.address = { 
                                street: street,
                                city: city,
                                province: province,
                                postal_code: postalCode
                            };
                            window.userProfile.updated_at = data.updated_at;

                            alert('Address updated successfully!');
                            displayAddress(); // Refresh the address display
                        }
                    } catch (error) {
                        console.error('Error updating address:', error);
                        alert(`Error updating address: ${error.message}`);
                    } finally {
                        saveChangesBtn.disabled = false;
                        saveChangesBtn.innerHTML = 'Save Changes';
                    }
                };
                
                // Setup for Cancel button (if it exists as part of the form)
                const cancelBtn = document.getElementById('cancelAddressEditBtn');
                if (cancelBtn) {
                    cancelBtn.onclick = () => {
                        displayAddress(); // Revert to showing address, hide form
                    };
                }
                
                editProfileModal.style.display = 'block';
            });
            
            // Close modal when clicking the X - FIXED to use modal-specific close button
            const editProfileCloseBtn = editProfileModal.querySelector('.close-modal');
            if (editProfileCloseBtn) {
                editProfileCloseBtn.addEventListener('click', () => {
                    editProfileModal.style.display = 'none';
                });
            }
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === editProfileModal) {
                    editProfileModal.style.display = 'none';
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && editProfileModal.classList.contains('show')) {
                    editProfileModal.style.display = 'none';
                }
            });

            // Handle password update
            modalEditProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const currentPassword = document.getElementById('modalCurrentPassword').value;
                const newPassword = document.getElementById('modalNewPassword').value;
                const confirmPassword = document.getElementById('modalConfirmPassword').value;
                
                if (!currentPassword) {
                    alert('Please enter your current password');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }
                
                // Password validation
                if (newPassword.length < 8) {
                    alert('Password must be at least 8 characters long');
                    return;
                }
                
                const submitButton = modalEditProfileForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                submitButton.disabled = true;
                
                try {
                    // First verify the current password by signing in
                    const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({
                        email: window.userProfile.email,
                        password: currentPassword
                    });
                    
                    if (signInError) {
                        throw new Error('Current password is incorrect');
                    }
                    
                    // Update password using Supabase auth
                    const { error } = await supabaseClient.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (error) throw error;
                    
                    // Show success message
                    alert('Password updated successfully');
                    
                    // Reset form and close modal
                    modalEditProfileForm.reset();
                    editProfileModal.style.display = 'none';
                    
                    // Optionally force re-login
                    if (confirm('Your password has been updated successfully. For security reasons, would you like to log out and sign in with your new password?')) {
                        await supabaseClient.auth.signOut();
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('Error updating password:', error);
                    
                    // Show specific error message based on the error
                    if (error.message.includes('Password should be at least')) {
                        alert('Password must be at least 8 characters long');
                    } else if (error.message.includes('expired')) {
                        alert('Your session has expired. Please log in again to change your password.');
                        await supabaseClient.auth.signOut();
                        window.location.href = 'login.html';
                    } else if (error.message.includes('incorrect')) {
                        alert('Current password is incorrect');
                    } else {
                        alert('Failed to update password: ' + error.message);
                    }
                } finally {
                    // Restore button state
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                }
            });
            
            // Handle account deletion
            deleteAccountBtn.addEventListener('click', async () => {
                // Safety confirmation
                const confirmDelete = confirm("Are you sure you want to delete your account? This action cannot be undone.");
                if (!confirmDelete) return;
                
                // Get confirmation through text entry
                const deletePrompt = prompt("To confirm deletion, please type 'delete'");
                if (deletePrompt?.toLowerCase() !== 'delete') {
                    alert("Account deletion cancelled. Please type 'delete' to confirm.");
                    return;
                }
                
                try {
                    // Show loading state
                    deleteAccountBtn.disabled = true;
                    deleteAccountBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                    
                    // Get the current user and profile
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    if (!user) {
                        alert("You must be logged in to delete your account.");
                        deleteAccountBtn.disabled = false;
                        deleteAccountBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete Account';
                        return;
                    }
                    
                    console.log(`Deleting account for user: ${user.id}`);
                    
                    // Step 1: Delete profile data first (this part works)
                    const { error: profileError } = await supabaseClient
                    .from('profiles')
                        .delete()
                        .eq('id', user.id);

                if (profileError) {
                        console.error("Error deleting profile:", profileError);
                        throw new Error(`Failed to delete profile data: ${profileError.message}`);
                    }
                    
                console.log("Profile data deleted successfully");
                
                    // Step 2: Delete any related data (with better error handling)
                    try {
                        const { error: regError } = await supabaseClient
                            .from('event_registrations')
                            .delete()
                            .eq('user_id', user.id);
                            
                        if (regError && !regError.message?.includes('not found')) {
                            console.warn("Error deleting event registrations:", regError);
                        } else {
                            console.log("Event registrations deleted or none found");
                        }
                    } catch (err) {
                        console.log("Event registrations table may not exist:", err.message);
                    }
                    
                    // Step 3: Tell the user what happened - be honest about limitations
                    alert(
                        "Your profile data has been deleted, but your account will remain in our authentication system. " +
                        "You will be signed out now. If you need complete removal from our systems, please contact our support team."
                    );
                    
                    // Step 4: Sign out the user
                    await supabaseClient.auth.signOut();
                    
                    // Step 5: Clear storage
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    // Redirect to homepage
                    window.location.href = 'index.html';
                    
                } catch (error) {
                    console.error("Error during account deletion:", error);
                    
                    // Reset button state
                    deleteAccountBtn.disabled = false;
                    deleteAccountBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete Account';
                    
                    // Show error
                    alert(`There was an error deleting your account: ${error.message}`);
                }
            });
            
            // Password visibility toggle
            document.querySelectorAll('.toggle-password').forEach(button => {
                button.addEventListener('click', function() {
                    const input = this.previousElementSibling;
                    const icon = this.querySelector('i');
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                } else {
                        input.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            });

            // Password strength meter
            const passwordInput = document.getElementById('modalNewPassword');
            const strengthMeter = document.querySelector('.password-strength-meter');
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');

            passwordInput.addEventListener('input', function() {
                const password = this.value;
                
                // Show strength meter only if password has some value
                if (password.length > 0) {
                    strengthMeter.style.display = 'block';
                } else {
                    strengthMeter.style.display = 'none';
                    return;
                }
                
                // Calculate password strength
                let strength = 0;
                
                // Basic requirements
                if (password.length >= 8) strength += 1; // Length
                if (/[A-Z]/.test(password)) strength += 1; // Uppercase
                if (/[a-z]/.test(password)) strength += 1; // Lowercase
                if (/[0-9]/.test(password)) strength += 1; // Numbers
                if (/[^A-Za-z0-9]/.test(password)) strength += 1; // Special chars
                
                // Update strength indicator
                strengthBar.className = 'strength-bar';
                
                if (strength < 3) {
                    strengthBar.classList.add('strength-weak');
                    strengthText.textContent = 'Weak';
                    strengthText.style.color = '#dc3545';
                } else if (strength < 5) {
                    strengthBar.classList.add('strength-medium');
                    strengthText.textContent = 'Medium';
                    strengthText.style.color = '#ffc107';
                } else {
                    strengthBar.classList.add('strength-strong');
                    strengthText.textContent = 'Strong';
                    strengthText.style.color = '#28a745';
                }
            });

            // Check if coming from verification success
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('verified') === 'true') {
                await updateStatusDisplay();
                // Clear the URL parameters
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // The old resend verification logic inside this if block will be removed.
            // The new event listener at the end of the file (using document.body.addEventListener)
            // will handle the #resendVerification button click.
            // The updateStatusDisplay function will still be responsible for
            // dynamically adding the #resendVerification button when status is pending.
            if (window.userProfile.membership_status === 'pending') {
                verificationStatus.innerHTML = `
                    <span class="badge warning">
                        <i class="fas fa-envelope"></i>
                        Please verify your email
                        <button id="resendVerification" class="resend-btn">
                            <i class="fas fa-redo"></i> Resend Verification
                        </button>
                    </span>
                `;

                // Ensure the resend button is correctly identified and handled by the
                // delegated event listener attached to document.body.
                // No need to add a specific event listener here anymore.
            }

            // Initialize coupon status if needed
            async function initializeCouponStatus() {
                try {
                    // Only proceed if all required DOM elements are found
                    if (!couponStatus || !couponRedeemed || !redeemCouponBtn || !redemptionDate || 
                        !redemptionModal || !cancelRedemptionBtn || !confirmRedemptionBtn) {
                        console.warn('Some coupon elements not found, skipping coupon initialization');
                        return;
                    }

                    // Check if coupon_redeemed exists in profile data
                    if (window.userProfile.coupon_redeemed === undefined) {
                        console.log('Coupon feature not fully set up in the database');
                        
                        // Try to update the profile with the field if it's missing
                        try {
                            // Initialize coupon_redeemed field to false (for existing users)
                            const { error: updateError } = await supabaseClient
                                .from('profiles')
                                .update({ coupon_redeemed: false })
                                .eq('id', session.user.id);
                            
                            if (updateError) {
                                if (updateError.message && updateError.message.includes('column "coupon_redeemed" does not exist')) {
                                    console.error('Coupon column does not exist in the database:', updateError);
                                    throw new Error('Database schema needs to be updated for coupon feature');
                                } else {
                                    console.error('Error updating coupon status:', updateError);
                                }
                            } else {
                                // Update was successful, so update local profile data
                                window.userProfile.coupon_redeemed = false;
                                console.log('Successfully initialized coupon_redeemed field');
                            }
                        } catch (error) {
                            console.error('Error initializing coupon status:', error);
                            // For admin users, show an alert about the missing column
                            if (window.userProfile.email && (window.userProfile.email.includes('admin') || window.userProfile.email === 'linkevin046@gmail.com')) {
                                alert('Admin notice: The coupon_redeemed column is missing in the profiles table. Please run the SQL to add it.');
                            }
                        }
                    }
                    
                    updateCouponDisplay();
                } catch (error) {
                    console.error('Error initializing coupon status:', error);
                }
            }

            // Handle coupon redemption functionality - WRAP IN TRY/CATCH
            try {
                const couponStatus = document.getElementById('couponStatus');
                const couponRedeemed = document.getElementById('couponRedeemed');
                const couponBadge = document.getElementById('couponBadge');
                const redeemCouponBtn = document.getElementById('redeemCouponBtn');
                const redemptionDate = document.getElementById('redemptionDate');
                const redemptionModal = document.getElementById('redemptionModal');
                const cancelRedemptionBtn = document.getElementById('cancelRedemptionBtn');
                const confirmRedemptionBtn = document.getElementById('confirmRedemptionBtn');
                
                // Update coupon display based on redemption status
                function updateCouponDisplay() {
                    if (window.userProfile.coupon_redeemed) {
                        couponStatus.style.display = 'none';
                        couponRedeemed.style.display = 'block';
                        
                        // Display redemption date if available
                        if (window.userProfile.coupon_redeemed_at) {
                            const formattedDate = new Date(window.userProfile.coupon_redeemed_at).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                            redemptionDate.textContent = formattedDate;
                        } else {
                            redemptionDate.textContent = 'Not available';
                        }
                    } else {
                        couponStatus.style.display = 'block';
                        couponRedeemed.style.display = 'none';
                    }
                }
                
                // Initialize coupon status
                if (couponStatus && couponRedeemed && redeemCouponBtn) {
                    await initializeCouponStatus();
                    
                    // Handle redeem button click
                    redeemCouponBtn.addEventListener('click', () => {
                        // Show redemption confirmation modal
                        redemptionModal.classList.add('show');
                    });
                    
                    // Close modal when clicking the cancel button
                    cancelRedemptionBtn.addEventListener('click', () => {
                        redemptionModal.classList.remove('show');
                    });
                    
                    // Close modal when clicking the X button
                    redemptionModal.querySelector('.close-modal').addEventListener('click', () => {
                        redemptionModal.classList.remove('show');
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                        if (e.target === redemptionModal) {
                            redemptionModal.classList.remove('show');
                        }
                    });
                    
                    // Handle redemption confirmation
                    confirmRedemptionBtn.addEventListener('click', async () => {
                        try {
                            // Disable button to prevent multiple clicks
                            confirmRedemptionBtn.disabled = true;
                            confirmRedemptionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                            
                            // Get latest profile info to ensure we have accurate data
                            const { data: latestProfile, error: profileError } = await supabaseClient
                                .from('profiles')
                                .select('*')
                                .eq('id', session.user.id)
                                .single();
                            
                            if (profileError) {
                                throw new Error('Failed to fetch profile data: ' + profileError.message);
                            }
                            
                            // Check if coupon_redeemed exists in the profile, if not it means the column hasn't been added
                            if (latestProfile.coupon_redeemed === undefined) {
                                throw new Error('Coupon feature is not available. Please contact the administrator.');
                            }
                            
                            // Double-check if coupon has already been redeemed
                            if (latestProfile.coupon_redeemed === true) {
                                alert('Your coupon has already been redeemed.');
                                redemptionModal.classList.remove('show');
                    return;
                }
                
                            // Update profile to mark coupon as redeemed
                            const redemptionTimestamp = new Date().toISOString();
                            const { error: updateError } = await supabaseClient
                                .from('profiles')
                                .update({ 
                                    coupon_redeemed: true,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', session.user.id);  // Use id instead of uid
                            
                            if (updateError) {
                                // If the update fails because the column doesn't exist, provide a meaningful error
                                if (updateError.message && updateError.message.includes('column "coupon_redeemed" does not exist')) {
                                    throw new Error('Coupon feature is not fully set up. The database needs to be updated.');
                        } else {
                                    throw new Error('Failed to update redemption status: ' + updateError.message);
                                }
                            }
                            
                            // Update local profile data
                            window.userProfile.coupon_redeemed = true;
                            window.userProfile.coupon_redeemed_at = redemptionTimestamp;
                            
                            // Update display
                            updateCouponDisplay();
                            
                            // Close modal
                            redemptionModal.classList.remove('show');
                            
                            // Show success message
                            alert('Coupon redeemed successfully! You can collect your club event item at the next event.');
                            
                } catch (error) {
                            console.error('Error redeeming coupon:', error);
                            alert('Error redeeming coupon: ' + error.message);
                        } finally {
                            // Reset button state
                            confirmRedemptionBtn.disabled = false;
                            confirmRedemptionBtn.innerHTML = '<i class="fas fa-check"></i> Confirm Redemption';
                        }
                    });
                }
            } catch (error) {
                console.error('Error initializing coupon redemption functionality:', error);
                // This ensures that even if the coupon feature fails, it doesn't break other features
            }

             // Remove duplicate session declaration and use existing session
             if (session?.user) {
                const { data: profileData } = await supabaseClient // Renamed to avoid conflict with outer 'profile' variables
                    .from('profiles')
                    .select(`
                        id,
                        phone,
                        full_address,
                        updated_at
                    `)
                    .eq('id', session.user.id)
                    .single();

                // Updated requiredFields to focus on phone and full_address for this mandatory redirect check.
                // update-profile.html should primarily be for ensuring these contact details are present.
                const requiredFields = ['phone', 'full_address']; 
                let isComplete = false;

                /* Temporarily suspending mandatory profile completion redirect
                if (profileData) {
                    console.log('[Completeness Check] Fetched profileData for check:', JSON.stringify(profileData));
                    isComplete = requiredFields.every(field => {
                        const value = profileData[field];
                        // Check if value is not null, not undefined, and not an empty string after trimming.
                        return value !== null && typeof value !== 'undefined' && String(value).trim() !== '';
                    });
                } else {
                    console.log('[Completeness Check] profileData was null or undefined when fetching for completeness.');
                    // If profileData couldn't be fetched (e.g., network error, or RLS issue for this specific select)
                    // then consider it incomplete to be safe, though this usually indicates a broader problem.
                    isComplete = false; 
                }

                if (!isComplete) {
                    console.log('[Completeness Check] Profile deemed INCOMPLETE. Redirecting to /profile-completion.html. Data used for check:', JSON.stringify(profileData));
                    sessionStorage.setItem('returnPath', window.location.pathname);
                    window.location.href = '/profile-completion.html?mandatory=true'; // UPDATED REDIRECT PATH
                } else {
                    console.log('[Completeness Check] Profile deemed COMPLETE. No redirect needed. Data used for check:', JSON.stringify(profileData));
                }
                */
            }
        });
    </script>

    <!-- Membership Card Modal -->
    <div id="membershipCardModal" class="modal">
        <div class="modal-content membership-card">
            <button class="close-modal">&times;</button>
                <div class="card-header">
                    <div class="header-text">
                    <h2>Blitz T Club</h2>
                    </div>
                <img src="https://i.ibb.co/fkrdXZK/Logo4-white.png" alt="Blitz Tesla Club Logo">
                    </div>
                    <div class="member-info">
                        <h3 id="cardFullName"></h3>
                        <div class="info-row">
                    <span class="label">Member ID</span>
                            <span id="cardMemberId"></span>
                        </div>
                        <div class="info-row">
                    <span class="label">Member Since</span>
                            <span id="cardMemberSince"></span>
                        </div>
                        <div class="info-row">
                    <span class="label">Status</span>
                            <span id="cardMembershipStatus"></span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="qr-section">
                            <canvas class="qr-code" id="memberQRCode"></canvas>
                            <div class="qr-text">
                                <i class="fas fa-qrcode"></i>
                                <small>Scan to verify membership</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Settings Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content settings-modal">
            <div class="modal-header">
                <h2><i class="fas fa-user-cog"></i> Account Settings</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Account Info Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-info-circle"></i> Account Information</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Email</span>
                            <span class="info-value" id="modalUserEmail"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Username</span>
                            <span class="info-value" id="modalUsername"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Member ID</span>
                            <span class="info-value" id="modalMemberId"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Member Since</span>
                            <span class="info-value" id="modalMemberSince"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Membership Status</span>
                            <span class="info-value" id="modalMembershipStatus"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Phone Number</span>
                            <span class="info-value" id="modalPhoneNumber"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Date of Birth</span>
                            <span class="info-value" id="modalDateOfBirth"></span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-car"></i> Your Tesla Models</h3>
                    <div class="car-models-list" id="modalCarModels">
                        <!-- Car models will be inserted here dynamically -->
                    </div>
                </div>
                
                <!-- Address Display Section -->
                <div class="settings-section">
                    <div class="section-header">
                        <h3><i class="fas fa-home"></i> Home Address</h3>
                        <button class="btn icon-btn" id="editAddressBtn">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    
                    <div class="address-content">
                        <div class="address-display" id="modalAddress">
                            <!-- Dynamic content will load here -->
                        </div>
                        
                        <form id="addressUpdateForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="editStreet">Street Address</label>
                                    <input type="text" id="editStreet" name="street" required
                                           class="modern-input" placeholder="123 Main St">
                                </div>
                                
                                <div class="form-group">
                                    <label for="editCity">City</label>
                                    <input type="text" id="editCity" name="city" required
                                           class="modern-input" placeholder="Toronto">
                                </div>

                                <div class="form-group">
                                    <label for="editProvince">Province</label>
                                    <select id="editProvince" name="province" required class="modern-input">
                                        <option value="">Select Province/Territory</option>
                                        <option value="AB">Alberta</option>
                                        <option value="BC">British Columbia</option>
                                        <option value="MB">Manitoba</option>
                                        <option value="NB">New Brunswick</option>
                                        <option value="NL">Newfoundland and Labrador</option>
                                        <option value="NS">Nova Scotia</option>
                                        <option value="ON">Ontario</option>
                                        <option value="PE">Prince Edward Island</option>
                                        <option value="QC">Quebec</option>
                                        <option value="SK">Saskatchewan</option>
                                        <option value="NT">Northwest Territories</option>
                                        <option value="NU">Nunavut</option>
                                        <option value="YT">Yukon</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="editPostalCode">Postal Code</label>
                                    <input type="text" id="editPostalCode" name="postal_code" required
                                           class="modern-input" placeholder="A1A 1A1" 
                                           pattern="[A-Za-z]\d[A-Za-z] ?\d[A-Za-z]\d">
                                </div>
                            </div>
                            <div class="form-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                                <button type="button" id="cancelAddressEditBtn" class="btn secondary-btn">Cancel</button>
                                <button type="submit" class="btn primary-btn">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Full Profile Update Section -->
                <div class="settings-section">
                    <div class="section-header">
                        <h3><i class="fas fa-user-edit"></i> Full Profile Management</h3>
                    </div>
                    <div class="full-profile-update-section">
                        <div class="profile-update-content">
                            <p class="profile-update-description">
                                Need to update additional profile information? Use our comprehensive profile editor to manage all your information in one place.
                            </p>
                            <div class="profile-update-benefits">
                                <div class="benefit-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Update your Tesla model information</span>
                                </div>
                                <div class="benefit-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Manage personal details and preferences</span>
                                </div>
                                <div class="benefit-item">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Ensure your profile is complete for event registration</span>
                                </div>
                            </div>
                            <a href="profile-completion.html" class="btn primary-btn profile-update-btn">
                                <i class="fas fa-user-cog"></i>
                                <span>Complete Profile Management</span>
                                <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Password Change Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-key"></i> Change Password</h3>
                    <form id="modalEditProfileForm">
                <div class="form-group">
                            <label for="modalCurrentPassword">Current Password</label>
                    <div class="password-input-container">
                                <input type="password" id="modalCurrentPassword" name="currentPassword" 
                                    placeholder="Enter current password" autocomplete="current-password"
                                    class="modern-input">
                        <button type="button" class="toggle-password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                            <label for="modalNewPassword">New Password</label>
                    <div class="password-input-container">
                                <input type="password" id="modalNewPassword" name="newPassword" 
                                    placeholder="Enter new password" autocomplete="new-password"
                                    class="modern-input">
                                <button type="button" class="toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="password-strength-meter" style="display: none;">
                                <div class="strength-label">Password strength: <span id="strengthText">Weak</span></div>
                                <div class="strength-bar-container">
                                    <div class="strength-bar" id="strengthBar"></div>
                                </div>
                                <small id="passwordRequirements">Use at least 8 characters, including uppercase, lowercase letters, and numbers</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="modalConfirmPassword">Confirm Password</label>
                            <div class="password-input-container">
                                <input type="password" id="modalConfirmPassword" name="confirmPassword" 
                                    placeholder="Confirm new password" autocomplete="new-password"
                                    class="modern-input">
                        <button type="button" class="toggle-password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="button-group">
                            <button type="submit" class="btn primary-btn">
                                <i class="fas fa-save"></i> Update Password
                    </button>
                </div>
            </form>
                </div>

                <!-- Danger Zone Section -->
                <div class="settings-section danger-zone">
                    <h3><i class="fas fa-exclamation-triangle"></i> Danger Zone</h3>
                    <p class="danger-text">Once you delete your account, there is no going back. Please be certain.</p>
                    <button type="button" class="btn danger-btn" id="deleteAccountBtn">
                        <i class="fas fa-trash-alt"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add event listener to ensure consistent menu initialization -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Ensuring mobile menu consistency across pages');
            
            // Force consistent class names to match index.html
            document.body.classList.remove('nav-open');
            
            const navLinks = document.querySelector('.nav-links');
            if (navLinks) {
                navLinks.classList.remove('active');
            }
            
            // Re-initialize navigation if available
            if (typeof window.initializeNavigation === 'function') {
                setTimeout(function() {
                    window.initializeNavigation();
                }, 100);
            }
        });
    </script>
    
    <!-- Coupon Redemption Modal -->
    <div id="redemptionModal" class="modal redemption-modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <div class="modal-icon">
                <i class="fas fa-ticket-alt"></i>
            </div>
            <h2>Redeem Your Club Event Item Coupon</h2>
            <p>Are you sure you want to redeem your coupon for an exclusive club event item? This action cannot be undone.</p>
            <div class="redemption-details">
                <p>You'll be able to collect your item at the next club event.</p>
                <p>Please show your membership card at the event to claim your item.</p>
            </div>
            <div class="button-group">
                <button class="btn primary-btn" id="cancelRedemptionBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn primary-btn confirm-btn" id="confirmRedemptionBtn">
                    <i class="fas fa-check"></i> Confirm Redemption
                </button>
            </div>
        </div>
    </div>

    <!-- Add this after the password change handler -->
    <script>
        // Wrap event listener in null check
        const profileForm = document.getElementById('profileUpdateForm');
        if (profileForm) {
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Get current session
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    alert('Session expired - please login again');
                    window.location.href = 'login.html';
                    return;
                }

                const formData = {
                    first_name: document.getElementById('editFirstName').value.trim(),
                    last_name: document.getElementById('editLastName').value.trim(),
                    phone: document.getElementById('editPhone').value.trim(),
                    street: document.getElementById('editStreet').value.trim(),
                    city: document.getElementById('editCity').value.trim(),
                    province: document.getElementById('editProvince').value,
                    postal_code: document.getElementById('editPostalCode').value.toUpperCase().trim()
                };

                // Basic validation
                if (!formData.first_name || !formData.last_name) {
                    alert('Please enter both first and last name');
                    return;
                }

                if (!/^\d{10}$/.test(formData.phone)) {
                    alert('Please enter a valid 10-digit phone number');
                    return;
                }

                if (!/^[A-Z]\d[A-Z] \d[A-Z]\d$/.test(formData.postal_code)) {
                    alert('Please enter a valid postal code (A1A 1A1 format)');
                    return;
                }

                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    const { error } = await supabaseClient
                        .from('profiles')
                        .update({
                            street: formData.street,
                            city: formData.city,
                            province: formData.province,
                            postal_code: formData.postal_code,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', user.id);

                    if (error) throw error;

                    // Update local profile data
                    Object.assign(window.userProfile, formData);
                    
                    // Check if all mandatory fields are now complete
                    const requiredFields = ['first_name', 'last_name', 'phone', 'street', 'city', 'province', 'postal_code'];
                    const isComplete = requiredFields.every(field => formData[field]?.trim() !== '');
                    
                    if (isComplete) {
                        // Remove mandatory update requirement
                        sessionStorage.removeItem('returnPath');
                        window.history.replaceState(null, null, window.location.pathname);
                    }

                    alert('Profile updated successfully!');
                    // Refresh displayed data
                    updateProfileDisplay();
                } catch (error) {
                    console.error('Profile update error:', error);
                    alert('Error updating profile: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                }
            });
        }

        // Add this function to update displayed profile info
        function updateProfileDisplay() {
            const profile = window.userProfile || {};
            
            // Phone Number Display
            const phoneDisplay = document.getElementById('modalPhoneNumber');
            phoneDisplay.innerHTML = profile.phone !== 'Not provided' 
                ? `<span class="verified-info">${profile.phone}</span>`
                : `<span class="missing-info">Not provided</span>`;

            // Address Display
            const addressContainer = document.getElementById('modalAddress');
            if (validateAddress(profile)) {
                addressContainer.innerHTML = `
                    <div class="address-display">
                        ${profile.street ? `<p class="address-line">${profile.street}</p>` : ''}
                        ${profile.city || profile.province ? `
                            <p class="city-province">
                                ${[profile.city, profile.province].filter(Boolean).join(', ')}
                            </p>` : ''}
                        ${profile.postal_code ? `<p class="postal-code">${profile.postal_code}</p>` : ''}
                    </div>
                `;
            } else {
                addressContainer.innerHTML = `
                    <div class="missing-info">
                        <i class="fas fa-exclamation-triangle"></i>
                        Please complete your address information
                    </div>
                `;
            }
        }
    </script>

    <!-- Address editing functionality -->
    <script>
        // Safe event listener initialization
        function initAddressEditing() {
            const editAddressBtn = document.getElementById('editAddressBtn');
            
            if (editAddressBtn) {
                editAddressBtn.addEventListener('click', () => {
                    // Show the form and hide the display
                    document.getElementById('addressUpdateForm').style.display = 'block';
                    document.getElementById('modalAddress').style.display = 'none';
                    
                    const profile = window.userProfile;
                    const address = profile.address || {};
                    
                    // Populate form fields
                    document.getElementById('editStreet').value = window.userProfile?.street || '';
                    document.getElementById('editCity').value = window.userProfile?.city || '';
                    document.getElementById('editProvince').value = window.userProfile?.province || '';
                    document.getElementById('editPostalCode').value = window.userProfile?.postal_code || '';
                });
            } else {
                console.error('CRITICAL: Edit address button missing from DOM');
                // Create button dynamically as fallback
                const newBtn = document.createElement('button');
                newBtn.id = 'editAddressBtn';
                newBtn.className = 'btn icon-btn';
                newBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
                newBtn.onclick = () => {
                    document.getElementById('addressUpdateForm').style.display = 'block';
                    document.getElementById('modalAddress').style.display = 'none';
                };
                document.querySelector('.section-header').appendChild(newBtn);
            }
        }

        // Initialize cancel button
        function initCancelButton() {
            const cancelEditBtn = document.getElementById('cancelEditAddress');
            
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('addressUpdateForm').style.display = 'none';
                    document.getElementById('modalAddress').style.display = 'block';
                });
            }
        }

        // Initialize form submission
        function initAddressFormSubmission() {
            const addressForm = document.getElementById('addressUpdateForm');
            
            if (addressForm) {
                addressForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    try {
                        const { data: { user } } = await supabaseClient.auth.getUser();
                        if (!user) throw new Error('User not authenticated');

                        // Get address fields individually
                        const street = document.getElementById('editStreet').value.trim();
                        const city = document.getElementById('editCity').value.trim();
                        const province = document.getElementById('editProvince').value;
                        const postalCode = document.getElementById('editPostalCode').value
                                    .toUpperCase()
                                    .replace(/\s/g, '')
                            .replace(/([A-Z]\d[A-Z])(\d[A-Z]\d)/, '$1 $2');
                        
                        // Create full address string
                        const fullAddress = `${street}, ${city}, ${province}, ${postalCode}`;

                        // Validation checks
                        if (!street || !city || !province || !postalCode) {
                            alert('Please fill all address fields');
                            return;
                        }

                        const { error } = await supabaseClient
                            .from('profiles')
                            .update({ 
                                street: street,
                                city: city,
                                province: province,
                                postal_code: postalCode,
                                full_address: fullAddress,
                                updated_at: new Date().toISOString() 
                            })
                            .eq('id', user.id);

                        if (error) throw error;

                        // Update local profile data
                        window.userProfile.street = street;
                        window.userProfile.city = city;
                        window.userProfile.province = province;
                        window.userProfile.postal_code = postalCode;
                        window.userProfile.full_address = fullAddress;
                        
                        // Update displayed profile
                        updateProfileDisplay();
                        
                        // Show success and hide form
                        alert('Address updated successfully!');
                        document.getElementById('addressUpdateForm').style.display = 'none';
                        document.getElementById('modalAddress').style.display = 'block';

                    } catch (error) {
                        console.error('Address update failed:', error);
                        alert('Error saving address: ' + error.message);
                    }
                });
            }
        }

        // Initialize all address components when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // First try
            initAddressEditing();
            initCancelButton();
            initAddressFormSubmission();
            
            // Periodic check for 5 seconds
            const interval = setInterval(() => {
                if(document.getElementById('editAddressBtn')) {
                    initAddressEditing();
                    clearInterval(interval);
                }
            }, 200);
            
            setTimeout(() => clearInterval(interval), 5000);
        });
     </script>

    <!-- Move this script block BEFORE any code that uses getOrdinalSuffix -->
    <script>
        // Add the getOrdinalSuffix function here
        function getOrdinalSuffix(day) {
            const dayNum = parseInt(day);
            if (dayNum > 3 && dayNum < 21) return day + 'th';
            switch (dayNum % 10) {
                case 1: return day + 'st';
                case 2: return day + 'nd';
                case 3: return day + 'rd';
                default: return day + 'th';
            }
        }

        function updateProfileDisplay() {
            // ... existing code ...
        }
    </script>

    <!-- Replace the existing address-related scripts with this -->
    <script>
        // Replace the existing address-related scripts with this
        function initAddressComponents() {
            // Create button if missing
            if (!document.getElementById('editAddressBtn')) {
                const btnHTML = `
                    <button class="btn icon-btn" id="editAddressBtn">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                `;
                const header = document.querySelector('.settings-section .section-header');
                if (header) header.insertAdjacentHTML('beforeend', btnHTML);
            }

            // Initialize event listeners
            const initAddressEditing = () => {
                // Required elements
                const elements = {
                    btn: document.getElementById('editAddressBtn'),
                    form: document.getElementById('addressUpdateForm'),
                    display: document.getElementById('modalAddress'),
                    street: document.getElementById('editStreet'),
                    city: document.getElementById('editCity'),
                    province: document.getElementById('editProvince'),
                    postalCode: document.getElementById('editPostalCode')
                };

                // Validate all elements exist
                if (Object.values(elements).some(el => !el)) {
                    console.error('Missing address elements:', 
                        Object.entries(elements)
                            .filter(([_, el]) => !el)
                            .map(([name]) => name)
                    );
                    return;
                }

                // Initialize only once
                if (!elements.btn._initialized) {
                    elements.btn._initialized = true;
                    
                    elements.btn.addEventListener('click', () => {
                        // Toggle visibility
                        elements.form.style.display = 'block';
                        elements.display.style.display = 'none';
                        
                        // Populate form fields
                        elements.street.value = window.userProfile?.street || '';
                        elements.city.value = window.userProfile?.city || '';
                        elements.province.value = window.userProfile?.province || '';
                        elements.postalCode.value = window.userProfile?.postal_code || '';
                    });
                }
            };

            // Initialize with retries
            const initWithRetry = (attempt = 0) => {
                if (attempt > 5) return;
                initAddressEditing();
                if (!document.getElementById('editAddressBtn')) {
                    setTimeout(() => initWithRetry(attempt + 1), 300);
                }
            };

            initWithRetry();
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initAddressComponents);
    </script>

    <!-- Add this at the BOTTOM of the file before closing body tag -->
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Initialize Supabase first
        if (!window.supabaseClient) {
            window.supabaseClient = supabase.createClient(
                'https://qhkcrrphsjpytdfqfamq.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoa2NycnBoc2pweXRkZnFmYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzMjQ4NzgsImV4cCI6MjA0OTkwMDg3OH0.S9JT_WmCWYMvSixRq1RrB1UlqXm6fix_riLFYCR3JOI',
                {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true
                    }
                }
            );
        }

        // Check database structure
        await checkDatabaseStructure();

        // Then initialize dashboard
        initializeDashboard();
    });
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const invoicesLink = document.getElementById('viewInvoices');
        if (invoicesLink) {
          invoicesLink.addEventListener('click', e => {
            e.preventDefault();
            alert('The "View Invoices" feature is coming soon!');
          });
        }
      });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) return;

        // Initialize with empty array
        let registrations = [];
        
        try {
            // Attempt to fetch event registrations - FIXED QUERY SYNTAX
            const response = await supabaseClient
            .from('event_registrations')
                .select('event_id')  // First get just the event IDs
            .eq('user_id', user.data.user.id);

            // Use response data if available
            registrations = response?.data || [];
            
            // If we have registrations, try to get event data
            if (registrations.length > 0) {
                try {
                    // Get all events (simpler approach to avoid 'in' operator issues)
                    const { data: allEvents } = await supabaseClient
                        .from('events')
                        .select('id, status');
                        
                    // If we got events data, merge it with registrations
                    if (allEvents && allEvents.length > 0) {
                        registrations = registrations.map(reg => ({
                            ...reg,
                            events: allEvents.find(e => e.id === reg.event_id) || null
                        }));
                    }
                } catch (eventError) {
                    console.error('Error fetching events:', eventError);
                    // Continue with just the registrations
                }
            }
        } catch (queryError) {
            console.error('Error fetching event registrations:', queryError);
            // Continue with empty registrations array
        }

        // Safely process the registrations
        const attended = registrations.filter(r => r?.events?.status === 'completed').length;
        const upcoming = registrations.filter(r => r?.events?.status === 'upcoming').length;
        
        safeTextUpdate('eventsAttended', attended);
        safeTextUpdate('upcomingEvents', upcoming);
    });
    </script>

    <script>
    async function initializeDashboard() {
        try {
            // ... existing auth checks ...

            // Initialize UI components in order
            initializeProfileSection();
            await loadUserEvents();
            updateEventStats();

        } catch (error) {
            handleDashboardError(error);
        }
    }
    </script>

    <script>
    async function generateSequentialMemberId() {
        const { count } = await window.supabaseClient
            .from('profiles')
            .select('*', { count: 'exact', head: true });
        
        return `BTC${String(count + 1).padStart(5, '0')}`; // Removed dash and fixed to 5 digits
    }
    </script>

    <!-- Replace email-based queries with UUID-based -->
    <script>
    document.querySelectorAll('[data-profile]').forEach(element => {
        supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', window.user.id)  // Use UUID instead of email
            .single()
            .then(({ data }) => {
                element.textContent = data?.full_name || 'Member';
            });
    });
    </script>

    <script>
    function handleDashboardError(error) {
        console.error('Dashboard Error:', error);
        const errorContainer = document.getElementById('errorNotification');
        if (errorContainer) {
            errorContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${error.message || 'An unexpected error occurred'}
                </div>`;
            errorContainer.style.display = 'block';
            setTimeout(() => errorContainer.style.display = 'none', 5000);
        }
        
        // Don't redirect on 401 errors, just display the message
        // if (error.message.includes('401')) window.location.href = 'login.html';
    }
    </script>

    <!-- Wrap all textContent updates in null checks -->
    <script>
    function safeTextUpdate(elementId, text) {
        const el = document.getElementById(elementId);
        if (el) {
            el.textContent = text || ''; // Handle undefined/null
            el.style.visibility = text ? 'visible' : 'hidden';
        }
    }
    </script>

    <script>
    function initializeProfileSection() {
        const elements = {
            profileName: document.getElementById('profileName'),
            userFullName: document.getElementById('userFullName'),
            memberId: document.getElementById('memberId'),
            membershipStatus: document.getElementById('membershipStatus'),
            memberSince: document.getElementById('memberSince'),
            phoneNumber: document.getElementById('profilePhone'),
            streetAddress: document.getElementById('profileStreet'),
            cityProvince: document.getElementById('profileCityProvince'),
            postalCode: document.getElementById('profilePostalCode')
        };

        if (!window.userProfile) return;

        // Update text content safely
        safeTextUpdate('profileName', window.userProfile.full_name || 'Member');
        safeTextUpdate('userFullName', window.userProfile.full_name || '');
        safeTextUpdate('memberId', window.userProfile.member_id || '');
        safeTextUpdate('profilePhone', window.userProfile.phone || 'Not provided');
        safeTextUpdate('profileStreet', window.userProfile.street || 'Not provided');
        
        // Combine city and province
        const cityProvince = [window.userProfile.city, window.userProfile.province]
            .filter(Boolean).join(', ');
        safeTextUpdate('profileCityProvince', cityProvince || 'Not provided');
        
        safeTextUpdate('profilePostalCode', window.userProfile.postal_code || 'Not provided');
    }
    </script>

    <script>
    async function loadUserEvents() {
        try {
            // Get the events container element
            const eventsContainer = document.getElementById('upcomingEventsList');
            
            // If there's no container, exit early
            if (!eventsContainer) {
                console.log('Events container not found in DOM');
                return;
            }
            
            // Check if the container already has event items (static HTML)
            const hasStaticEvents = eventsContainer.querySelector('.event-item') !== null;
            if (hasStaticEvents) {
                console.log('Found static event items, keeping them');
                
                // Remove any loading spinners
                const spinners = eventsContainer.querySelectorAll('.loading-spinner');
                spinners.forEach(spinner => spinner.remove());
                
                return;
            }
            
            // Show loading state if needed
            if (!eventsContainer.querySelector('.loading-spinner')) {
                eventsContainer.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>';
            }

            // Check if we have a user profile with ID
            if (!window.userProfile?.id) {
                console.log('User profile ID not available, showing Tesla Light Show example');
                
                // Show example event as fallback
                displayExampleEvent(eventsContainer);
                return;
            }
            
            console.log('Attempting to load events for user ID:', window.userProfile.id);
            
            // Attempt to fetch registered events
            try {
                // Fetch from event_registrations table
                const { data: registrations, error: regError } = await window.supabaseClient
                    .from('event_registrations')
                    .select('event_id')
                    .eq('user_id', window.userProfile.id)
                    .is('cancelled_at', null);
                
                if (regError) {
                    console.warn('Error fetching event registrations:', regError);
                    displayExampleEvent(eventsContainer);
                    return;
                }
                
                if (!registrations || registrations.length === 0) {
                    console.log('No event registrations found, showing example event');
                    displayExampleEvent(eventsContainer);
                    return;
                }
                
                // Extract event IDs
                const eventIds = registrations.map(reg => reg.event_id);
                
                // Fetch event details
                const { data: events, error: eventsError } = await window.supabaseClient
                    .from('events')
                .select('*')
                    .in('id', eventIds);
                
                if (eventsError || !events || events.length === 0) {
                    console.warn('Error fetching events or no events found:', eventsError);
                    displayExampleEvent(eventsContainer);
                    return;
                }
                
                // Display the events
                displayEvents(eventsContainer, events);
                
            } catch (fetchError) {
                console.error('Error in event fetch process:', fetchError);
                displayExampleEvent(eventsContainer);
            }
        } catch (error) {
            console.error('Error in loadUserEvents:', error);
            window.dashboardErrors.addError('events', error.message, false);
            
            // Fallback to example event
            const eventsContainer = document.getElementById('upcomingEventsList');
            if (eventsContainer) {
                displayExampleEvent(eventsContainer);
            }
        }
    }
    
    // Helper function to display events
    function displayEvents(container, events) {
        if (!container) return;
        
        if (!events || events.length === 0) {
            container.innerHTML = '<p class="no-events">No upcoming events found</p>';
            return;
        }
        
        const eventHtml = events.map(event => `
                        <div class="event-item">
                <div class="event-date">
                    <span class="event-month">${formatEventMonth(event.date)}</span>
                    <span class="event-day">${formatEventDay(event.date)}</span>
                    <span class="event-year">${formatEventYear(event.date)}</span>
                            </div>
                <div class="event-info">
                    <h3>${event.title || 'Upcoming Event'}</h3>
                    <div class="event-location">
                        <i class="fas fa-map-marker-alt"></i>
                        ${event.location || 'Location TBA'}
                        </div>
                    <div class="event-time">
                        <i class="fas fa-clock"></i>
                        ${formatEventTime(event.date)}
                    </div>
                    <div class="event-highlights">
                        <span class="highlight-tag"><i class="fas fa-star"></i> Registered</span>
                    </div>
                    <a href="events.html" class="event-btn">
                        <i class="fas fa-info-circle"></i> More Details
                    </a>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = eventHtml;
    }
    
    // Helper function to display example event
    function displayExampleEvent(container) {
        if (!container) return;
        
        // Show no upcoming events message
        container.innerHTML = `
            <p class="no-events">No upcoming events at this time</p>
        `;
    }
    
    // Helper functions for formatting event data
    function formatEventMonth(dateStr) {
        try {
            const date = new Date(dateStr);
            return date.toLocaleString('default', { month: 'short' });
        } catch {
            return 'TBA';
        }
    }
    
    function formatEventDay(dateStr) {
        try {
            const date = new Date(dateStr);
            return date.getDate();
        } catch {
            return '--';
        }
    }
    
    function formatEventYear(dateStr) {
        try {
            const date = new Date(dateStr);
            return date.getFullYear();
        } catch {
            return 'TBA';
        }
    }
    
    function formatEventTime(dateStr) {
        try {
            const date = new Date(dateStr);
            return date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        } catch {
            return 'Time TBA';
        }
    }
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof loadUserEvents === 'function') {
            loadUserEvents();
        } else {
            console.error('loadUserEvents function not defined');
        }
    });
    </script>

    <script>
    async function updateEventStats() {
        try {
            // Initialize with empty array and default values
            let registrations = [];
            let attended = 0;
            
            // Safely get the user ID, using fallbacks if necessary
            const userId = window.userProfile?.id || 
                          (await window.supabaseClient.auth.getUser()).data?.user?.id;
            
            if (!userId) {
                console.warn('Could not determine user ID for event stats');
                // Update UI with default values rather than throwing an error
                safeTextUpdate('eventsAttended', '0');
                safeTextUpdate('upcomingEvents', '0');
                return;
            }
            
            console.log('Updating event stats for user ID:', userId);
            
            // Try to get event registrations
            try {
                const response = await window.supabaseClient
                .from('event_registrations')
                    .select('event_id')
                    .eq('user_id', userId);

                registrations = response?.data || [];
                console.log('Found registrations:', registrations.length);
                
                // If we have registrations, try to get event data
                if (registrations.length > 0) {
                    try {
                        const { data: allEvents } = await window.supabaseClient
                            .from('events')
                            .select('id, status');
                            
                        if (allEvents && allEvents.length > 0) {
                            registrations = registrations.map(reg => ({
                                ...reg,
                                events: allEvents.find(e => e.id === reg.event_id) || null
                            }));
                        }
                    } catch (eventError) {
                        console.error('Error fetching events:', eventError);
                        // Continue with just the registrations
                    }
                }
            } catch (queryError) {
                console.error('Error fetching event registrations:', queryError);
                // Continue with empty registrations
            }

            // Calculate upcoming events count
            const upcoming = registrations.filter(r => r?.events?.status === 'upcoming').length;
            
            // Try to get events_attended from profile
            try {
                if (userId) {
                    const { data: profileData, error: profileError } = await window.supabaseClient
                        .from('profiles')
                        .select('events_attended')
                        .eq('id', userId)
                        .single();
                        
                    if (profileError) {
                        console.warn('Could not fetch events_attended:', profileError);
                        // Just use default value (0) instead of throwing
                    } else {
                        attended = profileData?.events_attended || 0;
                        
                        // Update userProfile if it exists
                        if (window.userProfile) {
                            window.userProfile.events_attended = attended;
                        }
                    }
                }
            } catch (profileError) {
                console.warn('Error handling profile fetch for events_attended:', profileError);
                // Continue with default value
            }
            
            // Update UI with the values we have
            safeTextUpdate('eventsAttended', attended);
            safeTextUpdate('upcomingEvents', upcoming);
            console.log('Event stats updated successfully:', {attended, upcoming});
            
        } catch (error) {
            console.error('Event stats error:', error);
            // Show error but don't throw
            safeTextUpdate('eventsAttended', '0');
            safeTextUpdate('upcomingEvents', '0');
        }
    }
    </script>

    <script>
    function checkProfileCompletion() {
        const completionStatus = document.getElementById('profileCompletionStatus');
        const accountSettingsBtn = document.getElementById('accountSettingsBtn');
        const profileCompletionAlert = document.getElementById('profileCompletionAlert');
        const missingInfoList = document.getElementById('missingInfoList');
        
        if (window.userProfile) {
            // Check required fields
            const requiredFields = [
                'phone',
                'street', 
                'city',
                'province',
                'postal_code'
            ];

            const fieldsConfig = {
                'phone': { icon: 'fa-phone-alt', label: 'Phone Number', description: 'Required for membership communication' },
                'street': { icon: 'fa-home', label: 'Street Address', description: 'Required for membership verification' },
                'city': { icon: 'fa-city', label: 'City', description: 'Required for membership verification' },
                'province': { icon: 'fa-map-marker-alt', label: 'Province', description: 'Required for membership verification' },
                'postal_code': { icon: 'fa-mail-bulk', label: 'Postal Code', description: 'Required for membership verification' },
                'car_models': { icon: 'fa-car', label: 'Tesla Model', description: 'Required to verify Tesla ownership' }
            };
            
            const completedFields = requiredFields.filter(field => 
                window.userProfile[field] && window.userProfile[field].trim() !== ''
            );

            const missingFields = requiredFields.filter(field => 
                !window.userProfile[field] || window.userProfile[field].trim() === ''
            );

            // Check for car models separately
            if (!window.userProfile.car_models || window.userProfile.car_models.length === 0) {
                missingFields.push('car_models');
            }

            const completionPercentage = Math.round(
                (completedFields.length / requiredFields.length) * 100
            );

            if (completionStatus) {
                // Update the completion status if the element exists
            completionStatus.innerHTML = `
                <div class="progress-container">
                    <div class="progress-bar" style="width: ${completionPercentage}%"></div>
                </div>
                <span>Profile ${completionPercentage}% Complete</span>
            `;
            }

            // Always show account settings button regardless of profile completion status
            if (accountSettingsBtn) {
                accountSettingsBtn.style.display = 'flex';
                accountSettingsBtn.style.visibility = 'visible';
            }

            // Display profile completion alert as a suggestion, not a requirement
            if (missingFields.length > 0 && profileCompletionAlert && missingInfoList) {
                // Clear previous list
                missingInfoList.innerHTML = '';
                
                // Add each missing field to the list
                missingFields.forEach(field => {
                    const config = fieldsConfig[field];
                    if (config) {
                        const item = document.createElement('div');
                        item.className = 'missing-info-item';
                        item.innerHTML = `
                            <i class="fas ${config.icon}"></i>
                            <div class="missing-info-text">
                                <strong>${config.label}</strong>
                                <span>${config.description}</span>
                            </div>
                        `;
                        missingInfoList.appendChild(item);
                    }
                });
                
                // Show the alert but modify the content to be suggestive rather than mandatory
                profileCompletionAlert.querySelector('p').textContent = 'Consider completing your profile to enhance your membership experience:';
                profileCompletionAlert.querySelector('.btn').textContent = 'Complete Profile';
                profileCompletionAlert.style.display = 'block';
            } else if (profileCompletionAlert) {
                // Hide the alert if no missing fields
                profileCompletionAlert.style.display = 'none';
            }
        }
    }
    </script>

    <script>
    async function loadAndUpdateProfile() {
        try {
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();

            if (error) throw error;
            
            // Initialize with proper defaults
            window.userProfile = {
                ...profile,
                phone: profile.phone || 'Not provided',
                street: profile.street || 'Not provided',
                city: profile.city || 'Not provided',
                province: profile.province || 'Not provided',
                postal_code: profile.postal_code || 'Not provided',
                car_models: profile.car_models || [],
                events_attended: profile.events_attended || 0
            };
            
            // Sanitize data to handle empty strings
            const fieldsToCheck = ['phone', 'street', 'city', 'province', 'postal_code'];
            fieldsToCheck.forEach(field => {
                if (window.userProfile[field] === 'Not provided' || window.userProfile[field].trim() === '') {
                    window.userProfile[field] = '';
                }
            });

            initializeProfileSection();
            // Removed checkProfileCompletion() call to disable profile completion checks
            updateAddressDisplay();
            
            // Update event stats after profile is loaded
            updateEventStats();
        } catch (error) {
            handleDashboardError(error);
        }
    }
    </script>

    <!-- Add this error boundary at the end of your script -->
    <script>
    window.addEventListener('error', (event) => {
        const error = event.error || event;
        console.error('Global Error:', error);
        
        const errorDisplay = document.getElementById('errorNotification');
        if (errorDisplay) {
            errorDisplay.querySelector('.error-message').textContent = 
                `Error: ${error.message || 'Unknown error occurred'}`;
            errorDisplay.style.display = 'flex';
            setTimeout(() => errorDisplay.style.display = 'none', 5000);
        }
        
        // Never redirect to login page on errors
        // Only the authentication system should control redirects
        
        // Prevent the error from propagating to other handlers
        event.preventDefault();
        event.stopPropagation();
        return true; // Prevents default error handler
    });
    
    // Add global unhandled promise rejection handler
    window.addEventListener('unhandledrejection', (event) => {
        console.error('Unhandled Promise Rejection:', event.reason);
        
        const errorDisplay = document.getElementById('errorNotification');
        if (errorDisplay) {
            errorDisplay.querySelector('.error-message').textContent = 
                `Error: ${event.reason?.message || 'Unhandled promise rejection occurred'}`;
            errorDisplay.style.display = 'flex';
            setTimeout(() => errorDisplay.style.display = 'none', 5000);
        }
        
        // Prevent the error from propagating
        event.preventDefault();
        event.stopPropagation();
        return true;
    });
    
    // Add a recovery function to create a reliable profile if needed
    window.recoverUserProfile = async function() {
        if (window.userProfile) return window.userProfile;
        
        try {
            // Get current session
            const { data: { session } } = await window.supabaseClient.auth.getSession();
            if (!session?.user) return null;
            
            // Create minimal profile
            const minimalProfile = {
                id: session.user.id,
                email: session.user.email,
                full_name: session.user.user_metadata?.full_name || session.user.email.split('@')[0],
                username: session.user.email.split('@')[0],
                membership_status: 'pending',
                membership_type: 'standard',
                created_at: new Date().toISOString()
            };
            
            // Set global profile
            window.userProfile = minimalProfile;
            console.log('Created recovery profile from session');
            
            return minimalProfile;
        } catch (e) {
            console.error('Error creating recovery profile:', e);
            return null;
        }
    };
    </script>

    <!-- Add at the end of body -->
    <div id="errorNotification" class="error-alert" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span class="error-message"></span>
    </div>

    <style>
    .error-alert {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #ff4444;
        color: white;
        padding: 15px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    </style>

    <!-- Enhanced address initialization with validation -->
    <script>
    function initAddressComponents() {
        const elements = {
            street: document.getElementById('editStreet'),
            city: document.getElementById('editCity'),
            province: document.getElementById('editProvince'),
            postalCode: document.getElementById('editPostalCode'),
            form: document.getElementById('addressUpdateForm')
        };

        // Validate elements exist
        const missing = Object.entries(elements)
            .filter(([_, el]) => !el)
            .map(([name]) => name);

        if (missing.length > 0) {
            console.error('Missing address elements:', missing);
            return;
        }

        // Initialize with actual profile data
        const updateForm = () => {
            elements.street.value = window.userProfile?.street || '';
            elements.city.value = window.userProfile?.city || '';
            elements.province.value = window.userProfile?.province || '';
            elements.postalCode.value = window.userProfile?.postal_code || '';
        };

        document.getElementById('editAddressBtn').addEventListener('click', updateForm);
        document.addEventListener('profile:updated', updateForm);
    }

    // Initialize with retry logic
    function initWithRetry(attempt = 0) {
        try {
            initAddressComponents();
        } catch (error) {
            if (attempt < 3) {
                setTimeout(() => initWithRetry(attempt + 1), 500);
            } else {
                console.error('Failed to initialize address components after 3 attempts');
            }
        }
    }

    // Call initialization after DOM load
    document.addEventListener('DOMContentLoaded', initWithRetry);
    </script>

    <script>
    // When loading profile data
    function sanitizeProfileData(profile) {
        return {
            ...(profile || {}),
            phone: profile?.phone || '',
            street: profile?.street || '',
            city: profile?.city || '',
            province: profile?.province || '',
            postal_code: profile?.postal_code || '',
            car_models: profile?.car_models || [],
            events_attended: profile?.events_attended || 0
        };
    }

    // Usage
    window.userProfile = sanitizeProfileData(window.userProfile || {});
    </script>

    <!-- Add this validation function -->
    <script>
    // Add this validation function
    function validateAddress(profile) {
        if (!profile) return false;
        return profile.street && profile.street.length > 5 &&
               profile.city && profile.city.length > 2 &&
               profile.province && profile.province.length === 2 &&
               profile.postal_code && /^[A-Z]\d[A-Z]\s?\d[A-Z]\d$/.test(profile.postal_code);
    }

    // Usage in display logic:
    const hasValidAddress = validateAddress(window.userProfile);
    </script>

    <script>
    // Update the validation call
    function updateAddressDisplay() {
        if (!window.userProfile) return;
        
        const hasValidAddress = validateAddress(window.userProfile);
        // Rest of your display logic
    }
    </script>

    <!-- Add this in DOMContentLoaded event listener -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize address components
        initAddressComponents();
        
        // Verify all elements exist
        const requiredElements = [
            '#editStreet', '#editCity', 
            '#editProvince', '#editPostalCode',
            '#modalPhoneNumber', '#modalAddress'
        ];
        
        requiredElements.forEach(selector => {
            if (!document.querySelector(selector)) {
                console.error(`Missing required element: ${selector}`);
            }
        });
    });
    </script>

    <!-- Add this function to check database structure -->
    <script>
    // Add this function to check database structure
    async function checkDatabaseStructure() {
        try {
            console.log('Checking database structure...');
            
            // Check if events table exists by trying to get a single row
            const { data: eventCheck, error: eventError } = await window.supabaseClient
                .from('events')
                .select('id')
                .limit(1);
                
            if (eventError) {
                console.error('Error accessing events table:', eventError);
                console.log('The events table might not exist or you might not have access to it.');
                console.log('To fix this, create an events table with id and status columns.');
                return false;
            }
            
            console.log('Events table exists and is accessible.');

            // Check if events_attended column exists in profiles table
            try {
                // Try to update a non-existent user with events_attended to see if the column exists
                const { error: columnError } = await window.supabaseClient
                    .from('profiles')
                    .update({ events_attended: 0 })
                    .eq('id', '00000000-0000-0000-0000-000000000000');  // Using a dummy UUID that won't exist
                
                // If there's no error about the column not existing, it means the column exists
                if (columnError && !columnError.message.includes('column "events_attended" does not exist')) {
                    console.log('events_attended column exists in profiles table');
                } else if (columnError && columnError.message.includes('column "events_attended" does not exist')) {
                    console.warn('events_attended column does not exist in profiles table');
                    
                    // For admin users, show an alert about the missing column
                    const { data: { user } } = await window.supabaseClient.auth.getUser();
                    const { data: profile } = await window.supabaseClient
                        .from('profiles')
                        .select('email')
                        .eq('id', user.id)
                        .single();
                        
                    if (profile?.email && (profile.email.includes('admin') || profile.email === 'linkevin046@gmail.com')) {
                        alert('Admin notice: The events_attended column is missing in the profiles table. Please run the migration SQL to add it.');
                    }
                }
            } catch (columnCheckError) {
                console.error('Error checking events_attended column:', columnCheckError);
            }
            
            return true;
        } catch (error) {
            console.error('Error checking database structure:', error);
            return false;
        }
    }

    // Call this function when initializing the dashboard
    document.addEventListener('DOMContentLoaded', async () => {
        // Initialize Supabase first
        if (!window.supabaseClient) {
            window.supabaseClient = supabase.createClient(
                'https://qhkcrrphsjpytdfqfamq.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoa2NycnBoc2pweXRkZnFmYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzMjQ4NzgsImV4cCI6MjA0OTkwMDg3OH0.S9JT_WmCWYMvSixRq1RrB1UlqXm6fix_riLFYCR3JOI',
                {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true
                    }
                }
            );
        }

        // Check database structure
        await checkDatabaseStructure();

        // Then initialize dashboard
        initializeDashboard();
    });
    </script>

    <!-- Replace the existing resend verification handler with this improved version -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Ensure Supabase client is available globally when the DOM is ready
        if (!window.supabaseClient) {
            console.error('Supabase client (window.supabaseClient) is not initialized. Resend verification functionality may not work.');
            return;
        }

        document.body.addEventListener('click', async (e) => {
            // Check if the clicked element or its parent is the resend button
            const button = e.target.closest('#resendVerification');
            if (button) {
                const originalBtnText = button.innerHTML;
                
                try {
                    console.log('[LOG] Resend verification button clicked');
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                    button.disabled = true;

                    // Generate verification token (use more broadly supported method)
                    const verificationToken = 'vt-' + Math.random().toString(36).substring(2, 15) + 
                                            Math.random().toString(36).substring(2, 15) + 
                                            Date.now().toString(36);
                    console.log('Generated token:', verificationToken);

                    // Store token temporarily in localStorage with 24 hour expiry
                    localStorage.setItem('verificationToken', verificationToken);
                    localStorage.setItem('tokenExpiry', new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString());

                    // Get current authenticated user
                    const { data: { user }, error: userError } = await window.supabaseClient.auth.getUser();
                    if (userError || !user) {
                        throw new Error('User not authenticated. Please log in again.');
                    }
                    
                    console.log('User authenticated, email:', user.email);
                    console.log('User ID:', user.id);
                    
                    // Always fetch fresh profile data before updating
                    const { data: freshProfile, error: freshProfileError } = await window.supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                        
                    if (freshProfileError) {
                        console.warn('Error fetching fresh profile before update:', freshProfileError);
                        // Proceed with window.userProfile as fallback
                    } else {
                        console.log('Fresh profile fetched for update:', freshProfile);
                        // Merge with existing profile data
                        window.userProfile = {
                            ...window.userProfile,
                            ...freshProfile
                        };
                    }

                    // Update the user's profile with verification info
                    console.log('Updating profile with verification token and setting status to pending');
                    const updateFields = {
                        verification_token: verificationToken,
                        verification_sent_at: new Date().toISOString(),
                        membership_status: 'pending', // Always set to pending during verification process
                        email_verified: false // Reset to false until verified
                    };
                    
                    try {
                        const { data: updateResult, error: updateError } = await window.supabaseClient
                            .from('profiles')
                            .update(updateFields)
                            .eq('id', user.id)
                            .select();
                        
                        if (updateError) {
                            console.warn('Error updating profile:', updateError);
                            
                            // If the update fails, we should determine if the user profile exists
                            const { data: checkProfile, error: checkError } = await window.supabaseClient
                                .from('profiles')
                                .select('id, email')
                                .eq('id', user.id)
                                .single();
                                
                            if (checkError || !checkProfile) {
                                // Profile doesn't exist - create it
                                console.warn('Profile not found, creating new profile for user ID:', user.id);
                                
                                // Extract name parts from email if possible
                                const emailName = user.email.split('@')[0];
                                const nameParts = emailName.split(/[.-_]/);
                                const firstName = nameParts[0] ? nameParts[0].charAt(0).toUpperCase() + nameParts[0].slice(1) : '';
                                const lastName = nameParts[1] ? nameParts[1].charAt(0).toUpperCase() + nameParts[1].slice(1) : '';
                                
                                // Create profile with basic info
                                const { error: insertError } = await window.supabaseClient
                                    .from('profiles')
                                    .insert({
                                        id: user.id,
                                        email: user.email,
                                        full_name: firstName && lastName ? `${firstName} ${lastName}` : (window.userProfile?.full_name || 'New Member'),
                                        member_id: window.userProfile?.member_id || null,
                                        verification_token: verificationToken,
                                        verification_sent_at: new Date().toISOString(),
                                        membership_status: 'pending',
                                        email_verified: false,
                                        created_at: new Date().toISOString(),
                                        updated_at: new Date().toISOString()
                                    });
                                    
                                if (insertError) {
                                    console.error('Failed to create profile:', insertError);
                                } else {
                                    console.log('Successfully created profile for user');
                                }
                            }
                        } else {
                            console.log('Profile updated successfully:', updateResult);
                            
                            // Update local userProfile with the changes
                            if (updateResult.length > 0) {
                                window.userProfile = sanitizeProfileData({
                                    ...window.userProfile,
                                    ...updateResult[0]
                                });
                                console.log('Local userProfile updated with new data');
                            }
                        }
                    } catch (updateException) {
                        console.warn('Exception during profile update:', updateException);
                    }

                    // Track if any email method succeeds
                    let emailSent = false;
                    let emailMethod = '';

                    // Method 1: Try password reset email (often works when resend doesn't)
                    try {
                        console.log('Attempting email verification via auth.resetPasswordForEmail');
                        const { error } = await window.supabaseClient.auth.resetPasswordForEmail(
                            user.email,
                            {
                                redirectTo: `${window.location.origin}/verify-email.html?source=dashboard`
                            }
                        );

                        if (error) {
                            console.warn('Password reset email method failed:', error);
                        } else {
                            console.log('Password reset email method succeeded');
                            emailSent = true;
                            emailMethod = 'password-reset';
                        }
                    } catch (resetError) {
                        console.warn('Password reset email exception:', resetError);
                    }

                    // Method 2: Try standard resend method
                    if (!emailSent) {
                        try {
                            console.log('Attempting resend via auth.resend');
                            const { error } = await window.supabaseClient.auth.resend({
                                type: 'signup',
                                email: user.email,
                                options: {
                                    emailRedirectTo: `${window.location.origin}/verify-email.html?source=dashboard`
                                }
                            });

                            if (error) {
                                console.warn('Supabase auth.resend failed:', error);
                            } else {
                                console.log('Supabase auth.resend succeeded');
                                emailSent = true;
                                emailMethod = 'auth-resend';
                            }
                        } catch (resendError) {
                            console.warn('Supabase auth.resend exception:', resendError);
                        }
                    }

                    // Method 3: FormSubmit as fallback (more reliable)
                    try {
                        console.log('Attempting FormSubmit fallback');
                        // Get base URL for verification link
                        const baseUrl = window.location.href.split('/').slice(0, -1).join('/');
                        const verificationUrl = `${baseUrl}/verify-email.html?token=${verificationToken}&source=formsubmit`;

                        // Send verification email using FormSubmit
                        const formData = new FormData();
                        formData.append('email', user.email);
                        formData.append('_captcha', 'false');
                        formData.append('_template', 'box');
                        formData.append('_subject', 'Verify Your Blitz T Club Membership');
                        formData.append('_autoresponse', 'Thank you for verifying your email. Your Blitz T Club membership will be activated shortly.');
                        formData.append('message', `Welcome to Blitz T Club!

Member ID: ${window.userProfile?.member_id || 'New Member'}

Please click the link below to verify your email and activate your membership:
${verificationUrl}

Important Notes:
- This verification link will expire in 24 hours
- Please verify on the same device you're currently using
- After verification, your membership will be activated instantly

Next Steps:
1. Click the verification link above
2. Your membership will be activated instantly
3. Access your digital membership card
4. Start enjoying member benefits

If you can't click the link, copy and paste this URL into your browser:
${verificationUrl}

If you didn't request this email, please ignore it.

Best regards,
Blitz T Club Team`);

                        // Send the verification email
                        const emailResponse = await fetch(`https://formsubmit.co/ajax/${user.email}`, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json'
                            },
                            body: formData
                        });

                        if (!emailResponse.ok) {
                            const responseText = await emailResponse.text();
                            console.error('FormSubmit response:', responseText);
                            if (!emailSent) { 
                                throw new Error('Failed to send verification email via FormSubmit');
                            }
                        } else {
                            const responseData = await emailResponse.json();
                            console.log('FormSubmit email sent successfully:', responseData);
                            emailSent = emailSent || true; // Mark as sent if not already sent
                            emailMethod = emailMethod || 'formsubmit';
                        }
                    } catch (formSubmitError) {
                        console.warn('FormSubmit fallback failed:', formSubmitError);
                        // Only throw if no other method worked
                        if (!emailSent) {
                            throw formSubmitError;
                        }
                    }

                    // Check if any email sending method succeeded
                    if (!emailSent) {
                        throw new Error('All email sending methods failed');
                    }

                    console.log(`Email successfully sent using method: ${emailMethod}`);

                    // Store verification data in localStorage
                    localStorage.setItem('pendingVerificationEmail', user.email);
                    localStorage.setItem('pendingMemberId', window.userProfile?.member_id || '');
                    localStorage.setItem('registrationTime', new Date().toISOString());

                    // Update UI to show success
                    const verificationStatus = document.getElementById('verificationStatus');
                    if (verificationStatus) {
                        verificationStatus.innerHTML = `
                            <span class="badge success">
                                <i class="fas fa-check-circle"></i>
                                Verification email sent! Please check your inbox.
                                <button id="resendVerification" class="resend-btn">
                                    <i class="fas fa-redo"></i> Send again
                                </button>
                            </span>
                        `;
                    }

                    // Refresh the user profile data immediately 
                    await updateStatusDisplay();

                    // Provide confirmation dialog with option to go to verification page
                    if (confirm('Verification email sent successfully! Would you like to view verification instructions?')) {
                        window.location.href = `verification-sent.html?email=${encodeURIComponent(user.email)}`;
                    }

                } catch (error) {
                    console.error('Error sending verification:', error);
                    alert('Failed to send verification email: ' + error.message + '. Please try again.');
                    
                    // Reset button state
                    if (button && button.parentNode) {
                        button.innerHTML = originalBtnText;
                        button.disabled = false;
                    }
                } finally {
                    // Ensure button is re-enabled even if there was a problem with the confirmation dialog
                    setTimeout(() => {
                        if (button && button.parentNode) {
                            button.disabled = false;
                            // Only restore original text if not navigating away
                            if (document.body.contains(button)) {
                                button.innerHTML = originalBtnText;
                            }
                        }
                    }, 1000);
                }
            }
        });
    });
    </script>

    <!-- Add this validation function -->
    <script>
    // Validate profile for completeness
    function validateProfile(profile) {
        if (!profile) return false;
        
        // Check required fields
        const hasValidPhone = profile.phone && profile.phone.trim().length >= 10;
        const hasValidAddress = profile.street && profile.street.trim().length > 3 &&
                               profile.city && profile.city.trim().length > 2 &&
                               profile.province && profile.province.trim().length > 0 &&
                               profile.postal_code && profile.postal_code.trim().length > 0;
        const hasValidCarModel = profile.car_models && Array.isArray(profile.car_models) && profile.car_models.length > 0;
        
        // Overall validation
        return hasValidPhone && hasValidAddress && hasValidCarModel;
    }

    // Usage in display logic:
    const hasCompleteProfile = validateProfile(window.userProfile);
    </script>

    <script>
    // Update the validation call
    function updateAddressDisplay() {
        if (!window.userProfile) return;
        
        const hasCompleteProfile = validateProfile(window.userProfile);
        // Rest of your display logic
    }
    </script>

    <style>
    /* ... existing styles ... */

    /* Add styles for the event item in the dashboard */
    .event-item {
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.08);
        flex-wrap: nowrap; /* Prevent wrapping */
        width: 100%; /* Ensure full width */
    }

    .event-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        background: rgba(255, 255, 255, 0.08);
    }

    .event-date {
        background: linear-gradient(145deg, #00e676, #2196f3);
        color: white;
        padding: 8px 12px;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        text-align: left;
        flex-shrink: 0; /* Prevent date section from shrinking */
        gap: 8px;
        border-radius: 12px 12px 0 0;
        position: relative;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .event-month {
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .event-day {
        font-size: 1.4rem;
        font-weight: 700;
        line-height: 1;
        margin: 0;
    }

    .event-year {
        font-size: 0.85rem;
        opacity: 0.9;
        margin-left: 2px;
    }

    /* Add a divider between date and time */
    .event-date::after {
        display: none;
    }

    /* Mobile optimizations for the new horizontal date layout */
    @media (max-width: 768px) {
        .event-date {
            padding: 8px 10px;
            gap: 4px;
        }
        
        .event-day {
            font-size: 1.2rem;
        }
        
        .event-month, .event-year {
            font-size: 0.75rem;
        }
        
        .event-date::after {
            right: 8px;
            font-size: 0.9rem;
        }
    }

    .event-info {
        padding: 15px;
        flex: 1;
        min-width: 0; /* Allow proper text truncation */
    }

    .event-info h3 {
        margin: 0 0 10px;
        font-size: 1.1rem;
        color: #ffffff;
        white-space: normal; /* Allow wrapping of long titles */
        word-break: break-word; /* Break long words if needed */
    }

    .event-location, .event-time {
        font-size: 0.9rem;
        margin: 5px 0;
        color: rgba(255, 255, 255, 1); /* Changed from 0.8 to 1 for full white */
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: normal; /* Allow text to wrap */
        word-break: break-word; /* Break long words if needed */
    }

    .event-time {
        margin-bottom: 10px;
    }

    .event-location i, .event-time i {
        flex-shrink: 0; /* Keep icons from shrinking */
        color: #00e676; /* Keep the icons green for contrast */
        width: 16px;
        text-align: center;
    }

    .event-highlights {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 10px 0;
    }

    .highlight-tag {
        background: rgba(0, 230, 118, 0.1);
        color: #00e676;
        font-size: 0.8rem;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 5px; /* Add space between wrapped tags */
    }

    .highlight-tag i {
        font-size: 0.75rem;
    }

    .event-btn {
        margin-top: 10px;
        padding: 8px 15px;
        font-size: 0.9rem;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        align-self: flex-start; /* Align button to the left */
    }

    .event-btn:hover {
        background: rgba(0, 230, 118, 0.2);
    }

    /* Improved mobile optimizations for events */
    @media (max-width: 768px) {
        .event-item {
            flex-direction: column;
            margin-bottom: 12px;
        }
        
        .event-date {
            min-width: 120px;
            padding: 8px 10px;
            gap: 4px;
        }
        
        .event-day {
            font-size: 1.2rem;
        }
        
        .event-info {
            padding: 12px 10px;
        }
        
        .event-info h3 {
            font-size: 1rem;
            margin-bottom: 8px;
        }
        
        .event-location, .event-time {
            font-size: 0.85rem;
            margin: 4px 0;
        }
        
        .event-highlights {
            margin: 8px 0;
            gap: 6px;
        }
        
        .highlight-tag {
            font-size: 0.75rem;
            padding: 3px 6px;
        }
        
        .event-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            margin-top: 8px;
        }
        
        /* Improve dashboard header on mobile */
        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .quick-actions {
            align-self: stretch;
        }
        
        .quick-actions button {
            width: 100%;
        }
        
        /* Better spacing for footer on mobile */
        .footer-content {
            gap: 20px;
        }
    }
    
    /* Extra small screens optimization */
    @media (max-width: 480px) {
        .event-item {
            flex-direction: column;
        }
        
        .event-date {
            width: 100%;
            justify-content: center;
            border-radius: 12px 12px 0 0;
        }
        
        /* Better touch targets for mobile */
        .event-btn, 
        .quick-link-item,
        .btn {
            min-height: 44px;
        }
    }
    </style>

    <!-- ... existing code ... */

    <!-- Add resilient initialization with retry -->
    <script>
    // Function to initialize with retry capability
    async function initWithRetry(maxRetries = 3, delay = 1000) {
        let attempts = 0;
        
        while (attempts < maxRetries) {
            try {
                console.log(`Dashboard initialization attempt ${attempts + 1}/${maxRetries}`);
                
                // First make sure we have a user profile
                if (!window.userProfile) {
                    await window.recoverUserProfile();
                }
                
                // Try to initialize all sections independently
                
                // Profile section
                try {
                    if (typeof initializeProfileSection === 'function') {
                        initializeProfileSection();
                    }
                } catch (profileError) {
                    console.warn('Could not initialize profile section:', profileError);
                }
                
                // Events
                try {
                    if (typeof loadUserEvents === 'function') {
                        await loadUserEvents();
                    }
                } catch (eventsError) {
                    console.warn('Could not load user events:', eventsError);
                }
                
                // Stats
                try {
                    if (typeof updateEventStats === 'function') {
                        await updateEventStats();
                    }
                } catch (statsError) {
                    console.warn('Could not update event stats:', statsError);
                }
                
                console.log('Dashboard initialization completed successfully');
                return;
            } catch (error) {
                attempts++;
                console.error(`Initialization attempt ${attempts} failed:`, error);
                
                // Show an error message but keep trying
                const errorDisplay = document.getElementById('errorNotification');
                if (errorDisplay) {
                    errorDisplay.querySelector('.error-message').textContent = 
                        `Dashboard load issue: ${error.message}. Retrying...`;
                    errorDisplay.style.display = 'flex';
                    setTimeout(() => {
                        if (errorDisplay.querySelector('.error-message').textContent.includes('Retrying')) {
                            errorDisplay.style.display = 'none';
                        }
                    }, 3000);
                }
                
                if (attempts < maxRetries) {
                    console.log(`Waiting ${delay}ms before retry ${attempts + 1}/${maxRetries}`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    // Increase delay for next retry
                    delay *= 1.5;
                }
            }
        }
        
        console.warn('All dashboard initialization attempts failed');
        // Show a persistent message
        const errorDisplay = document.getElementById('errorNotification');
        if (errorDisplay) {
            errorDisplay.querySelector('.error-message').textContent = 
                'Dashboard could not be fully loaded. Some features may be limited.';
            errorDisplay.style.display = 'flex';
            setTimeout(() => errorDisplay.style.display = 'none', 8000);
        }
    }
    
    // Run initialization with retry when the DOM is loaded
    document.addEventListener('DOMContentLoaded', initWithRetry);
    </script>

    <!-- Replace the global error handlers with improved versions -->
    <script>
    // Create a centralized error handling system
    window.dashboardErrors = {
        _errors: [],
        _notificationTimeout: null,
        _notificationDisplayed: false,
        
        // Add an error to the tracking system
        addError: function(source, message, isCritical = false) {
            const error = {
                source: source,
                message: message,
                timestamp: new Date(),
                isCritical: isCritical
            };
            
            console.error(`Dashboard Error [${source}]:`, message);
            this._errors.push(error);
            
            // Don't show notifications during initialization
            const isInitializing = window._dashboardInitializing === true;
            
            // Only show notifications for critical errors or after initialization
            if ((isCritical || !isInitializing) && !this._notificationDisplayed) {
                this.showNotification(message);
            }
            
            return error;
        },
        
        // Display an error notification
        showNotification: function(message, duration = 5000) {
            const errorDisplay = document.getElementById('errorNotification');
            if (!errorDisplay) return;
            
            // Clear any existing timeout
            if (this._notificationTimeout) {
                clearTimeout(this._notificationTimeout);
            }
            
            // Set notification content and display it
            errorDisplay.querySelector('.error-message').textContent = message;
            errorDisplay.style.display = 'flex';
            this._notificationDisplayed = true;
            
            // Auto-hide after duration
            this._notificationTimeout = setTimeout(() => {
                errorDisplay.style.display = 'none';
                this._notificationDisplayed = false;
            }, duration);
        },
        
        // Clear all notifications
        clearNotification: function() {
            const errorDisplay = document.getElementById('errorNotification');
            if (!errorDisplay) return;
            
            // Clear any existing timeout
            if (this._notificationTimeout) {
                clearTimeout(this._notificationTimeout);
            }
            
            // Hide the notification
            errorDisplay.style.display = 'none';
            this._notificationDisplayed = false;
        },
        
        // Get all errors
        getErrors: function() {
            return [...this._errors]; // Return a copy
        },
        
        // Check if we have critical errors
        hasCriticalErrors: function() {
            return this._errors.some(e => e.isCritical);
        }
    };
    
    // Replace window error handler
    window.addEventListener('error', (event) => {
        const error = event.error || new Error(event.message || 'Unknown error');
        
        // Add to our tracking system
        window.dashboardErrors.addError('global', error.message, false);
        
        // Prevent the error from bubbling to default handler
        event.preventDefault();
        return true;
    });
    
    // Replace unhandled promise rejection handler
    window.addEventListener('unhandledrejection', (event) => {
        const message = event.reason?.message || 'Unhandled promise rejection';
        
        // Add to our tracking system
        window.dashboardErrors.addError('promise', message, false);
        
        // Prevent from bubbling to default handler
        event.preventDefault();
        return true;
    });
    
    // More user-friendly handleDashboardError function
    function handleDashboardError(error, source = 'dashboard') {
        // Add to our error tracking system
        window.dashboardErrors.addError(source, error.message || 'Unknown error', false);
        
        // No automatic redirects to login page
    }
    </script>

    <!-- Update the initialization retry function to use the new error system -->
    <script>
    // Set a flag during initialization to suppress excessive notifications
    window._dashboardInitializing = true;
    
    // Master initialization function with dashboard loading logic
    async function initializeDashboard() {
        console.log('Starting unified dashboard initialization');
        
        try {
            // First check if we already have a profile
            if (!window.userProfile) {
                console.log('No user profile found, attempting to create from session');
                
                try {
                    // First attempt - get from session
                    const { data: { session } } = await window.supabaseClient.auth.getSession();
                    
                    if (!session?.user) {
                        window.dashboardErrors.addError('auth', 'No active session found', true);
                        // Redirect to login in 3 seconds with message
                        window.dashboardErrors.showNotification('Your session has expired. Redirecting to login...', 3000);
                        
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 3000);
                        return;
                    }
                    
                    // Get profile from database
                    console.log('Getting profile for user:', session.user.id);
                    const { data: profileData, error: profileError } = await window.supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('id', session.user.id)
                        .single();
                    
                    if (profileError) {
                        // Try email fallback if ID search fails
                        console.log('Failed to get profile by ID, trying email fallback');
                        const { data: emailProfileData, error: emailProfileError } = await window.supabaseClient
                            .from('profiles')
                            .select('*')
                            .eq('email', session.user.email)
                            .single();
                            
                        if (emailProfileData && !emailProfileError) {
                            // Found by email but not ID - update the ID
                            console.log('Found profile by email, updating ID');
                            await window.supabaseClient
                                .from('profiles')
                                .update({ id: session.user.id })
                                .eq('email', session.user.email);
                                
                            window.userProfile = emailProfileData;
                            window.userProfile.id = session.user.id;
                        } else {
                            // Create minimal profile
                            window.userProfile = {
                                id: session.user.id,
                                email: session.user.email,
                                full_name: session.user.user_metadata?.full_name || session.user.email.split('@')[0],
                                username: session.user.email.split('@')[0],
                                membership_status: 'pending',
                                created_at: new Date().toISOString()
                            };
                        }
                    } else {
                        // Profile found by ID
                        window.userProfile = profileData;
                    }
                    
                    console.log('Profile loaded successfully:', window.userProfile);
                    
                } catch (sessionError) {
                    window.dashboardErrors.addError('profile', 'Error loading profile: ' + sessionError.message, false);
                    // Create empty profile but don't throw
                    window.userProfile = {
                        full_name: 'Guest User',
                        membership_status: 'pending',
                        created_at: new Date().toISOString()
                    };
                }
            }
            
            // Initialize UI sections in sequence with independent error handling
            
            console.log('Initializing profile section');
            // Profile section
            try {
                if (typeof initializeProfileSection === 'function') {
                    initializeProfileSection();
                }
            } catch (profileError) {
                window.dashboardErrors.addError('profile', 'Could not initialize profile section', false);
            }
            
            console.log('Loading user events');
            // Events
            try {
                if (typeof loadUserEvents === 'function') {
                    await loadUserEvents();
                }
            } catch (eventsError) {
                window.dashboardErrors.addError('events', 'Could not load user events', false);
            }
            
            console.log('Updating event stats');
            // Stats
            try {
                await updateEventStats();
            } catch (statsError) {
                window.dashboardErrors.addError('stats', 'Could not update event stats', false);
            }
            
            console.log('Checking profile completion');
            // Profile completion check
            try {
                if (typeof checkProfileCompletion === 'function') {
                    checkProfileCompletion();
                }
            } catch (completionError) {
                window.dashboardErrors.addError('completion', 'Could not check profile completion', false);
            }
            
            console.log('Dashboard initialization completed successfully');
            
        } catch (error) {
            window.dashboardErrors.addError('init', 'Error in master initialization: ' + error.message, true);
        } finally {
            // Mark initialization as complete
            window._dashboardInitializing = false;
        }
    }
    
    // Set up the initialization with retry
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, starting initialization with retry');
        
        let attempts = 0;
        const maxAttempts = 3;
        const attemptInit = async () => {
            try {
                await initializeDashboard();
                // Clear any initialization messages on success
                window.dashboardErrors.clearNotification();
            } catch (error) {
                attempts++;
                console.error(`Dashboard initialization attempt ${attempts} failed:`, error);
                
                if (attempts < maxAttempts) {
                    console.log(`Retrying initialization (${attempts + 1}/${maxAttempts})...`);
                    // Show a retry message
                    window.dashboardErrors.showNotification(`Dashboard load issue. Retrying (${attempts + 1}/${maxAttempts})...`, 2000);
                    setTimeout(attemptInit, 1000 * attempts); // Increasing delay between attempts
                } else {
                    console.error('All initialization attempts failed');
                    // Only show error if we have critical errors, not for minor display issues
                    if (window.dashboardErrors.hasCriticalErrors()) {
                        window.dashboardErrors.showNotification('Dashboard could not be fully loaded due to critical errors.', 5000);
                    } else {
                        // Just clear any notifications for non-critical issues
                        window.dashboardErrors.clearNotification();
                    }
                }
            }
        };
        
        // Start the initialization process
        attemptInit();
    });
    </script>

    <!-- Existing modals and content -->
    
    <!-- Admin Dashboard Access Modal -->
    <div id="adminDashboardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-shield"></i> Admin Access</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="admin-access-content">
                    <p class="admin-message">You are accessing the admin dashboard. This area contains sensitive member information and administrative controls.</p>
                    
                    <div class="admin-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Please ensure you are authorized to access this area. All actions are logged for security purposes.</p>
                    </div>
                    
                    <div class="admin-actions">
                        <button id="confirmAdminAccess" class="btn primary-btn">
                            <i class="fas fa-unlock"></i> Continue to Admin Dashboard
                        </button>
                        <button id="cancelAdminAccess" class="btn secondary-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add CSS for admin modal -->
    <style>
        /* Admin button styling */
        .admin-btn {
            background: #6c5ce7;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 10px;
        }
        
        .admin-btn:hover {
            background: #5549bd;
            transform: translateY(-2px);
        }
        
        /* Admin modal styling */
        .admin-access-content {
            padding: 20px;
        }
        
        .admin-message {
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: #e0e0e0;
        }
        
        .admin-warning {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .admin-warning i {
            color: #dc3545;
            font-size: 24px;
        }
        
        .admin-warning p {
            margin: 0;
            color: #e0e0e0;
            font-size: 0.95rem;
        }
        
        .admin-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Add this to existing secondary button styles if needed */
        .secondary-btn {
            background: #4b5563;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .secondary-btn:hover {
            background: #374151;
        }
    </style>

    <script>
        // Add admin dashboard access functionality
        document.addEventListener('DOMContentLoaded', async function() {
            // Variables for admin access
            const adminDashboardBtn = document.getElementById('adminDashboardBtn');
            const adminDashboardModal = document.getElementById('adminDashboardModal');
            const confirmAdminAccess = document.getElementById('confirmAdminAccess');
            const cancelAdminAccess = document.getElementById('cancelAdminAccess');
            const adminModalClose = adminDashboardModal.querySelector('.close');
            
            // Function to check if user is admin
            async function checkAdminStatus() {
                try {
                    const { data: { session }, error: sessionError } = await window.supabaseClient.auth.getSession();
                    
                    if (sessionError || !session) {
                        console.error('No active session:', sessionError);
                        return false;
                    }
                    
                    // List of authorized admin user IDs
                    const authorizedAdminIds = [
                        '31f25dda-d747-412d-94c8-d49021f7bfc4',
                        '05d85f12-21ed-46ea-ba7f-89065a9cd570',
                        'd2b873f6-5f34-451e-9f8b-b9b4ea4ff819',
                        'f57ecbf3-5508-401c-a9b7-e69b6da9b1fd'
                    ];
                    
                    // Direct check for specified user IDs - these users always get admin access
                    if (authorizedAdminIds.includes(session.user.id)) {
                        console.log('Admin access granted based on authorized ID list');
                        
                        // Update profile to ensure user role is set to admin
                        try {
                            await window.supabaseClient
                                .from('profiles')
                                .update({ role: 'admin' })
                                .eq('id', session.user.id);
                        } catch (updateError) {
                            console.error('Unable to update profile role, but continuing with admin access:', updateError);
                        }
                        
                        return true;
                    }
                    
                    // First try to use the global profile if it exists
                    if (window.userProfile && window.userProfile.role === 'admin') {
                        console.log('Admin status confirmed from global profile');
                        return true;
                    }
                    
                    // Otherwise fetch from database
                    const { data: profile, error: profileError } = await window.supabaseClient
                        .from('profiles')
                        .select('role, membership_status')
                        .eq('id', session.user.id)
                        .single();
                    
                    if (profileError) {
                        console.error('Error fetching admin status:', profileError);
                        return false;
                    }
                    
                    return profile.role === 'admin' && profile.membership_status === 'active';
                } catch (error) {
                    console.error('Error checking admin status:', error);
                    return false;
                }
            }
            
            // Initialize admin button visibility
            async function initializeAdminButton() {
                const isAdmin = await checkAdminStatus();
                if (isAdmin && adminDashboardBtn) {
                    adminDashboardBtn.style.display = 'flex';
                    console.log('Admin button displayed - user has admin privileges');
                } else if (adminDashboardBtn) {
                    adminDashboardBtn.style.display = 'none';
                    console.log('Admin button hidden - user does not have admin privileges');
                }
            }
            
            // Call this after profile data is loaded
            setTimeout(initializeAdminButton, 1000);
            
            // Add admin button check to the status update interval
            // Modify the existing updateStatusDisplay function to include this check
            const originalUpdateStatusDisplay = window.updateStatusDisplay;
            if (typeof originalUpdateStatusDisplay === 'function') {
                window.updateStatusDisplay = async function() {
                    await originalUpdateStatusDisplay();
                    await initializeAdminButton();
                };
            }
            
            // Open admin modal when button is clicked
            if (adminDashboardBtn) {
                adminDashboardBtn.addEventListener('click', function() {
                    adminDashboardModal.style.display = 'block';
                });
            }
            
            // Close admin modal functions
            function closeAdminModal() {
                adminDashboardModal.style.display = 'none';
            }
            
            if (adminModalClose) {
                adminModalClose.addEventListener('click', closeAdminModal);
            }
            
            if (cancelAdminAccess) {
                cancelAdminAccess.addEventListener('click', closeAdminModal);
            }
            
            // Handle click outside the modal
            window.addEventListener('click', function(event) {
                if (event.target === adminDashboardModal) {
                    closeAdminModal();
                }
            });
            
            // Redirect to admin dashboard when confirmed
            if (confirmAdminAccess) {
                confirmAdminAccess.addEventListener('click', async function() {
                    const isAdmin = await checkAdminStatus();
                    if (isAdmin) {
                        window.location.href = 'admin-dashboard.html';
                    } else {
                        alert('Access denied. You do not have admin privileges.');
                        closeAdminModal();
                    }
                });
            }
        });
    </script>

    <!-- JotForm Chatbot Widget -->
    <script src='https://cdn.jotfor.ms/agent/embedjs/0197a4f8c2107841a0d93e4272525cea385d/embed.js?skipWelcome=1&maximizable=1'></script>
</body>
</html> 