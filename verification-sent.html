<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Verification Email Sent - Blitz Tesla Club</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="mobile-navigation.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/BvmtNLtB/logo.png">
    <!-- Add Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="verification-page">
    <!-- Standard Navigation -->
    <nav>
        <div class="logo">
            <a href="index.html">
                <img src="https://i.ibb.co/fkrdXZK/Logo4-white.png" alt="Blitz Tesla Club Logo" loading="lazy" width="50" height="50">
                <span>BLITZ T CLUB</span>
            </a>
        </div>
        <div class="menu-toggle">
            <i class="fas fa-bars"></i>
        </div>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="events.html">Events</a></li>
            <li><a href="gallery.html">Gallery</a></li>
            <li><a href="executive.html">Executives</a></li>
            <li><a href="news.html">News</a></li>
            <li><a href="register.html">Join Us</a></li>
            <li><a href="login.html">Login</a></li>
        </ul>
    </nav>

    <main class="verification-container">
        <div class="verification-box">
            <img src="https://i.postimg.cc/BvmtNLtB/logo.png" alt="Blitz Tesla Club Logo" class="verification-logo">
            <h1>Verification Email Sent</h1>
            <p>We've sent a verification email to your inbox. Please check your email and click the verification link to activate your account.</p>
            <p class="user-email" id="userEmail"></p>
            <div class="email-note">
                <p><strong>Important Instructions:</strong></p>
                <ol>
                    <li>Check your email inbox for a message from <strong>noreply@mail.app.supabase.io</strong> or <strong>Blitz T Club</strong></li>
                    <li>Open the email with subject line <strong>"Confirm your signup"</strong> or <strong>"Verify Your Blitz T Club Membership"</strong></li>
                    <li>Click the verification link in the email</li>
                    <li>You'll be redirected to our verification success page automatically</li>
                    <li>Your membership will be immediately activated upon verification</li>
                </ol>
                <p>Once verified, your account will be fully active and you can access all member features!</p>
            </div>
            <div class="verification-info">
                <p><i class="fas fa-info-circle"></i> If you don't see the email, please check your spam folder.</p>
                <p><i class="fas fa-clock"></i> The verification link will expire in 24 hours.</p>
                <p><i class="fas fa-exclamation-triangle"></i> If the verification link expires, you'll need to request a new one.</p>
                <p><i class="fas fa-envelope"></i> If you don't receive an email after a few minutes, click the "Resend Email" button below.</p>
            </div>
            <div class="verification-actions">
                <a href="login.html" class="btn primary-btn">Return to Login</a>
                <button id="resendButton" class="btn secondary-btn">
                    <i class="fas fa-redo"></i> Resend Email
                </button>
                <p class="timer" id="resendTimer"></p>
            </div>
            <div id="statusMessage" style="margin-top: 20px; padding: 10px; border-radius: 5px; display: none;"></div>
        </div>
    </main>

    <!-- Standard Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>Quick Links</h3>
                <div class="footer-links">
                    <a href="index.html">Home</a>
                    <a href="events.html">Events</a>
                    <a href="gallery.html">Gallery</a>
                    <a href="contact.html">Contact</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Member Area</h3>
                <div class="footer-links">
                    <a href="login.html">Login</a>
                    <a href="register.html">Register</a>
                    <a href="sponsors.html">Our Sponsors</a>
                    <a href="member-benefits.html">Member Benefits</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Legal</h3>
                <div class="footer-links">
                    <a href="privacy.html">Privacy Policy</a>
                    <a href="terms.html">Terms of Service</a>
                    <a href="about.html">About Us</a>
                </div>
            </div>

            <div class="footer-section">
                <h3>Connect With Us</h3>
                <div class="footer-social">
                    <a href="https://x.com/BlitzTClub" target="_blank" aria-label="Follow us on X">
                        <i class="fa-brands fa-square-x-twitter"></i>
                    </a>
                    <a href="https://www.instagram.com/blitztclub/" target="_blank" aria-label="Follow us on Instagram">
                        <i class="fab fa-instagram"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <p>Â© 2025 Blitz T Club. All rights reserved.</p>
            <p class="powered-by">
                Website powered by <a href="http://www.summitpixels.com" target="_blank">SummitPixels</a>
            </p>
        </div>
    </footer>

    <style>
        body.verification-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .verification-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 60px 0;
        }

        .verification-box {
            background: rgba(0, 0, 0, 0.7);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .verification-box h1 {
            margin: 20px 0;
            font-size: 24px;
            color: #fff;
        }

        .verification-box p {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .verification-logo {
            width: 100px;
            margin-bottom: 20px;
        }

        .verification-info {
            margin: 30px 0;
            text-align: left;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
        }

        .verification-info p {
            margin: 10px 0;
            color: #ccc;
            display: flex;
            align-items: center;
        }

        .verification-info i {
            margin-right: 10px;
            color: #4CAF50;
            min-width: 20px;
        }

        .verification-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .verification-actions .btn {
            min-width: 150px;
            padding: 12px 24px;
        }

        .secondary-btn {
            background: transparent;
            border: 2px solid #4CAF50;
            color: #4CAF50;
            transition: all 0.3s ease;
        }

        .secondary-btn:hover {
            background: #4CAF50;
            color: white;
        }

        .email-note {
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #4CAF50;
            padding: 15px 20px;
            margin: 20px 0;
            text-align: left;
            border-radius: 0 10px 10px 0;
        }

        .email-note p {
            margin: 10px 0;
        }

        .email-note strong {
            color: #4CAF50;
        }

        .email-note ol {
            margin: 10px 0;
            padding-left: 25px;
            color: #ccc;
        }

        .email-note li {
            margin: 8px 0;
            line-height: 1.4;
        }

        .device-warning {
            margin-top: 20px !important;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .device-warning i {
            color: #ffc107; /* Warning yellow color */
        }

        .device-warning span {
            color: #ffc107;
            font-weight: 500;
        }

        .user-email {
            color: #4CAF50 !important;
            font-weight: 500;
            font-size: 1.1em;
            margin: 10px 0;
        }

        .timer {
            color: #ccc;
            font-size: 0.9em;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .verification-box {
                margin: 20px;
                padding: 20px;
            }

            .verification-actions {
                flex-direction: column;
                gap: 10px;
            }

            .verification-actions .btn {
                width: 100%;
            }

            .email-note {
                margin: 15px 0;
                padding: 12px 15px;
            }
        }

        #statusMessage {
            transition: all 0.3s ease;
        }

        #statusMessage.success {
            background: rgba(76, 175, 80, 0.2);
            border-left: 4px solid #4CAF50;
            color: #4CAF50;
        }

        #statusMessage.error {
            background: rgba(244, 67, 54, 0.2);
            border-left: 4px solid #F44336;
            color: #F44336;
        }

        .disabled-btn {
            opacity: 0.6;
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <script src="navigation.js" defer></script>
    <script>
        // Initialize Supabase client
        window.supabaseClient = supabase.createClient(
            'https://qhkcrrphsjpytdfqfamq.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoa2NycnBoc2pweXRkZnFmYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzMjQ4NzgsImV4cCI6MjA0OTkwMDg3OH0.S9JT_WmCWYMvSixRq1RrB1UlqXm6fix_riLFYCR3JOI',
            {
                auth: {
                    persistSession: true,
                    autoRefreshToken: true
                }
            }
        );

        document.addEventListener('DOMContentLoaded', () => {
            // Display user email
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');
            const error = urlParams.get('error');
            
            // Check if coming from an expired link redirect
            if (error === 'expired') {
                showStatusMessage('Your verification link has expired. Please request a new verification email using the button below.', 'error');
                // Auto-scroll to the error message
                document.getElementById('statusMessage').scrollIntoView({ behavior: 'smooth' });
            }
            
            if (email) {
                document.getElementById('userEmail').textContent = email;
                localStorage.setItem('pendingVerificationEmail', email);
            } else {
                const storedEmail = localStorage.getItem('pendingVerificationEmail');
                if (storedEmail) {
                    document.getElementById('userEmail').textContent = storedEmail;
                } else {
                    document.getElementById('userEmail').textContent = 'Email address not found';
                    showStatusMessage('No email address found for verification. Please try registering again.', 'error');
                }
            }

            // Set up resend button
            const resendButton = document.getElementById('resendButton');
            const resendTimer = document.getElementById('resendTimer');
            
            // Handle resend cooldown
            let cooldownTime = localStorage.getItem('resendCooldown');
            if (cooldownTime && new Date().getTime() < parseInt(cooldownTime)) {
                startResendCooldown(parseInt(cooldownTime));
            }
            
            // Add event listener for resend button
            resendButton.addEventListener('click', async () => {
                await resendVerification();
            });
        });

        // Start cooldown timer for resend button
        function startResendCooldown(endTime) {
            const resendButton = document.getElementById('resendButton');
            const resendTimer = document.getElementById('resendTimer');
            resendButton.disabled = true;
            resendButton.classList.add('disabled-btn');
            
            // Update timer every second
            const interval = setInterval(() => {
                const now = new Date().getTime();
                const timeLeft = endTime - now;
                
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    resendButton.disabled = false;
                    resendButton.classList.remove('disabled-btn');
                    resendTimer.textContent = '';
                    localStorage.removeItem('resendCooldown');
                } else {
                    const seconds = Math.ceil(timeLeft / 1000);
                    resendTimer.textContent = `Please wait ${seconds} seconds before requesting another email`;
                }
            }, 1000);
        }

        // Show status message
        function showStatusMessage(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = '';
            statusMessage.classList.add(type);
            statusMessage.style.display = 'block';
            
            // Scroll to message
            statusMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Resend verification email
        async function resendVerification() {
            // Get email from page or storage
            const email = document.getElementById('userEmail').textContent || 
                         localStorage.getItem('pendingVerificationEmail');
            
            if (!email || email === 'Email address not found') {
                showStatusMessage('No email found for verification. Please try registering again.', 'error');
                return;
            }

            // Update button state
            const resendButton = document.getElementById('resendButton');
            const originalButtonText = resendButton.innerHTML;
            resendButton.innerHTML = '<span class="spinner"></span> Sending...';
            resendButton.disabled = true;
            resendButton.classList.add('disabled-btn');

            try {
                // Generate a verification token
                const verificationToken = `vt-${Math.random().toString(36).slice(2)}-${Date.now().toString(36)}`;
                localStorage.setItem('verificationToken', verificationToken);
                localStorage.setItem('tokenExpiry', new Date(Date.now() + 86400000).toISOString()); // 24-hour expiry

                // Check if user is logged in
                let userId = null;
                let user = null;
                try {
                    const { data } = await window.supabaseClient.auth.getUser();
                    user = data.user;
                    if (user) {
                        userId = user.id;
                        console.log('User is logged in:', userId);
                    }
                } catch (e) {
                    console.log('User not logged in:', e);
                    // Continue without user ID
                }

                // Try to update profile if we have userId
                if (userId) {
                    try {
                        console.log('Attempting to update profile with verification token');
                        const { data, error } = await window.supabaseClient
                            .from('profiles')
                            .update({
                                verification_token: verificationToken,
                                verification_sent_at: new Date().toISOString(),
                                membership_status: 'pending'
                            })
                            .eq('id', userId)
                            .select();
                        
                        if (error) {
                            console.warn('Could not update profile:', error);
                        } else {
                            console.log('Profile updated successfully:', data);
                        }
                    } catch (profileError) {
                        console.warn('Exception updating profile:', profileError);
                        // Continue with email sending anyway
                    }
                }

                // Track success of each method
                let emailSent = false;

                // 1. Try standard Supabase signup resend first (correct method for verification)
                try {
                    console.log('Attempting resend via auth.resend for signup verification');
                    const { error } = await window.supabaseClient.auth.resend({
                        type: 'signup',
                        email: email,
                        options: {
                            emailRedirectTo: `${window.location.origin}/verify-email.html`
                        }
                    });

                    if (error) {
                        console.warn('Supabase auth.resend failed:', error);
                    } else {
                        console.log('Supabase auth.resend succeeded');
                        emailSent = true;
                    }
                } catch (resendError) {
                    console.warn('Supabase auth.resend exception:', resendError);
                }

                // 2. Always send via FormSubmit as a reliable fallback
                if (!emailSent) {
                    try {
                        console.log('Attempting FormSubmit fallback');
                        // Get base URL for verification link
                        const baseUrl = window.location.href.split('/').slice(0, -1).join('/');
                        const verificationUrl = `${baseUrl}/verify-email.html?token=${verificationToken}`;

                        // Send verification email using FormSubmit
                        const formData = new FormData();
                        formData.append('email', email);
                        formData.append('_captcha', 'false');
                        formData.append('_template', 'box');
                        formData.append('_subject', 'Verify Your Blitz T Club Membership');
                        formData.append('_autoresponse', 'Thank you for verifying your email. Your Blitz T Club membership will be activated shortly.');
                        formData.append('message', `Welcome to Blitz T Club!

Member ID: ${localStorage.getItem('pendingMemberId') || 'New Member'}

Please click the link below to verify your email and activate your membership:
${verificationUrl}

Important Notes:
- This verification link will expire in 24 hours
- Please verify on the same device you're currently using
- After verification, your membership will be activated instantly

Next Steps:
1. Click the verification link above
2. Your membership will be activated instantly
3. Access your digital membership card
4. Start enjoying member benefits

If you can't click the link, copy and paste this URL into your browser:
${verificationUrl}

If you didn't request this email, please ignore it.

Best regards,
Blitz T Club Team`);

                        const emailResponse = await fetch(`https://formsubmit.co/ajax/${email}`, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json'
                            },
                            body: formData
                        });

                        if (!emailResponse.ok) {
                            const responseText = await emailResponse.text();
                            console.error('FormSubmit response:', responseText);
                            throw new Error('FormSubmit email sending failed');
                        }

                        const responseData = await emailResponse.json();
                        console.log('FormSubmit email sent successfully:', responseData);
                        emailSent = true;
                    } catch (formSubmitError) {
                        console.warn('FormSubmit fallback failed:', formSubmitError);
                    }
                }

                // Check overall success
                if (emailSent) {
                    showStatusMessage('Verification email sent! Please check your inbox (including spam folder).', 'success');
                    
                    // Set cooldown for 60 seconds
                    const cooldownEnd = new Date().getTime() + 60000;
                    localStorage.setItem('resendCooldown', cooldownEnd);
                    startResendCooldown(cooldownEnd);
                } else {
                    throw new Error('All email sending methods failed');
                }
            } catch (error) {
                console.error('Resend error:', error);
                showStatusMessage(`Error sending email: ${error.message}. Please try again later.`, 'error');
                
                // Reset button after error
                resendButton.disabled = false;
                resendButton.classList.remove('disabled-btn');
            } finally {
                // Restore button text
                setTimeout(() => {
                    resendButton.innerHTML = originalButtonText;
                }, 1000);
            }
        }
    </script>
</body>
</html> 