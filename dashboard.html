<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dashboard - Blitz T Club</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="mobile-navigation.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/BvmtNLtB/logo.png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/BvmtNLtB/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="navigation.js" defer></script>
    <script>
        // Add a global direct logout function that can be called from anywhere
        window.performLogout = async function(options = {}) {
            const { showMessage = true, redirectDelay = 3000, skipRedirect = false } = options;
            console.log('Direct logout function called with options:', options);
            
            try {
                // Try to sign out through Supabase
                if (window.supabaseClient) {
                    await window.supabaseClient.auth.signOut()
                        .catch(e => console.error('Error during signOut call:', e));
                }
            } catch (error) {
                console.error('Critical error during logout attempt:', error);
            } finally {
                // Always clear storage regardless of errors
                console.log('Clearing auth storage');
                localStorage.removeItem('supabase.auth.token');
                sessionStorage.removeItem('supabase.auth.token');
                
                // Clear any other auth-related storage that might exist
                try {
                    for (let key in localStorage) {
                        if (key.includes('supabase') || key.includes('auth') || key.includes('token')) {
                            localStorage.removeItem(key);
                        }
                    }
                    for (let key in sessionStorage) {
                        if (key.includes('supabase') || key.includes('auth') || key.includes('token')) {
                            sessionStorage.removeItem(key);
                        }
                    }
                } catch (e) {
                    console.error('Error clearing storage:', e);
                }
                
                // Show a message to the user
                if (showMessage) {
                    const errorDisplay = document.getElementById('errorNotification');
                    if (errorDisplay) {
                        errorDisplay.querySelector('.error-message').textContent = 
                            'You have been logged out. Redirecting to login page...';
                        errorDisplay.style.display = 'flex';
                    }
                }
                
                // Allow skipping redirect or delaying it
                if (!skipRedirect) {
                    setTimeout(() => {
                        // Force redirect to login page after delay
                window.location.href = 'login.html';
                    }, redirectDelay);
                }
            }
        };
        
        // Only keep necessary script elements for dashboard functionality, removing any mobile menu customizations
        
        // Calculate viewport height for mobile browsers (fix iOS issues)
        function setViewportHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        // Set the height on page load
        window.addEventListener('load', setViewportHeight);
        // Update height on resize and orientation change
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', setViewportHeight);
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #171a20;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }
        
        /* Hide elements with hidden class - for removing mandatory updates */
        .hidden {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            width: 0 !important;
            opacity: 0 !important;
            position: absolute !important;
            overflow: hidden !important;
            z-index: -9999 !important;
            pointer-events: none !important;
        }
        
        .dashboard-page main {
            flex: 1;
            padding: clamp(20px, 4vw, 40px); /* Updated padding */
            z-index: 1;
        }

        /* Dashboard Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* General Dashboard Card Styles */
        .dashboard-card {
            background: linear-gradient(145deg, #222a36, #1c2330);
            border-radius: 20px;
            padding: clamp(24px, 3vw, 32px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #00e676, #2196f3);
            opacity: 0.8;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-header h2 {
            font-size: 1.25rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffffff;
        }

        .card-header h2 i {
            color: #00e676;
            font-size: 1.1em;
        }

        .card-header .view-all {
            color: #2196f3;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .card-header .view-all:hover {
            color: #00e676;
            text-decoration: underline;
        }

        .card-content {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* Profile Completion Alert Styles */
        .completion-alert {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
            margin-bottom: 30px;
        }
        
        .completion-alert::before {
            background: #ff9800;
        }
        
        .completion-alert .card-header {
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }
        
        .completion-alert .card-header h2 {
            color: #e65100;
        }
        
        .completion-alert .card-header h2 i {
            color: #ff9800;
        }
        
        .completion-alert .card-content p {
            color: #424242;
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .missing-info-list {
            margin: 15px 0;
        }
        
        .missing-info-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255, 152, 0, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .missing-info-item i {
            color: #ff9800;
            margin-right: 10px;
            font-size: 16px;
        }
        
        .completion-actions {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        
        .completion-actions .btn {
            padding: 12px 25px;
            font-weight: 500;
        }

        /* Badge Styling */
        .badge.upcoming {
            background: #ffca28;
            color: #1a1a1a;
            padding: 4px 8px;
            margin-left: 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            vertical-align: middle;
            display: inline-block;
            position: relative;
            top: -1px;
        }

        /* Quick Links Styling */
        .quick-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .quick-link-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            text-decoration: none;
            color: #fff;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .quick-link-item:hover {
            background: rgba(0, 230, 118, 0.1);
            transform: translateY(-3px);
        }

        .quick-link-item i {
            font-size: 1.5rem;
            color: #00e676;
        }

        .quick-link-item span {
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        /* Dashboard Content Styles */
        
        /* Special handling for mobile menu open state to prevent split screen */
        body.nav-open {
            overflow: hidden !important; 
            position: fixed !important;
            width: 100% !important;
            height: 100% !important;
            top: 0 !important;
            left: 0 !important;
            touch-action: none !important; /* JavaScript in navigation.js already handles this */
        }
        
        /* iOS Optimizations */
        @supports (-webkit-touch-callout: none) {
            .dashboard-container {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }

            .dashboard-header {
                margin-top: env(safe-area-inset-top);
            }

            nav {
                padding-top: env(safe-area-inset-top);
            }

            footer {
                padding-bottom: env(safe-area-inset-bottom);
            }

            /* Prevent text size adjustment */
            body {
                -webkit-text-size-adjust: none;
            }

            /* Improve touch targets */
            .nav-links a,
            .quick-actions button,
            .quick-link-item,
            .resend-btn {
                min-height: 44px;
                padding: 12px;
            }

            /* Smooth scrolling */
            .dashboard-container {
                -webkit-overflow-scrolling: touch;
            }

            /* Prevent unwanted highlighting */
            * {
                -webkit-tap-highlight-color: transparent;
            }
        }
        
        /* Modern Membership Card Styles */
        .modal-content.membership-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: 16px;
            padding: 30px;
            margin: 0 auto;
            text-align: left;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            position: relative;
            overflow: hidden;
            transform: perspective(1000px) rotateY(0deg);
            transition: transform 0.5s ease;
        }
        
        .modal-content.membership-card:hover {
            transform: perspective(1000px) rotateY(5deg);
        }
        
        .modal-content.membership-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.05) 50%, 
                rgba(255,255,255,0) 100%);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            background: transparent;
            padding: 0;
            border: none;
        }
        
        .card-header img {
            height: 60px;
            width: auto;
            background: transparent;
            margin: 0;
        }
        
        .header-text h2 {
            font-size: 22px;
            margin: 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.95);
            background: transparent;
        }
        
        .member-info {
            margin: 25px 0;
            text-align: left;
        }
        
        .member-info h3 {
            font-size: 24px;
            margin-bottom: 25px;
            font-weight: 700;
            color: white;
            letter-spacing: 0.5px;
            text-transform: capitalize;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 14px;
            color: white;
            margin-bottom: 5px;
        }
        
        .info-row .label {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        
        .card-footer {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }
        
        .qr-section {
            text-align: center;
        }
        
        canvas.qr-code {
            width: 120px;
            height: 120px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin: 0 auto 15px;
        }
        
        .qr-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .qr-text i {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        /* Premium Card Style */
        .membership-card[data-type="premium"] {
            background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .membership-card[data-type="premium"]::before {
            background: linear-gradient(45deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.1) 50%, 
                rgba(255,255,255,0) 100%);
        }
        
        .membership-card[data-type="premium"] .header-text h2 {
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .membership-card[data-type="premium"] .info-row {
            border-bottom: 1px solid rgba(255, 255, 255, 0.25);
        }
        
        .membership-card[data-type="premium"] .qr-text {
            color: rgba(255, 255, 255, 0.9);
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Modal styling for the card */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow: auto;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease forwards;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            position: relative;
            margin: 20px;
            animation: modalSlideIn 0.4s ease-out forwards;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .close-modal:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(1.1);
        }

        .profile-settings {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
        }

        .form-group input {
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Edit Profile Modal Styles */
        .danger-btn {
            background-color: #dc3545;
            color: white;
        }
        
        .danger-btn:hover {
            background-color: #c82333;
        }
        
        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .toggle-password {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Modern Settings Modal Styles */
        .settings-modal {
            max-width: 600px;
            width: 90%;
            background: #1a1a1a;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .settings-modal .modal-header {
            background: #222;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            border-bottom: 1px solid #333;
        }

        .settings-modal .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            color: #fff;
        }

        .settings-modal .modal-body {
            padding: 20px;
        }

        .settings-section {
            background: #222;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 1.1em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            color: #888;
            font-size: 0.9em;
        }

        .info-value {
            color: #fff;
            font-weight: 500;
        }

        .modern-input {
            width: 100%;
            padding: 12px;
            background: #333;
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 0.95em;
            transition: border-color 0.3s ease;
        }

        .modern-input:focus {
            border-color: #666;
            outline: none;
        }

        .danger-zone {
            border: 1px solid #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .danger-text {
            color: #dc3545;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .primary-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .primary-btn:hover {
            background: #0056b3;
        }

        .danger-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .danger-btn:hover {
            background: #c82333;
        }

        .password-input-container {
            position: relative;
            width: 100%;
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0;
        }

        .toggle-password:hover {
            color: #888;
        }

        /* Password Strength Meter */
        .password-strength-meter {
            margin-top: 10px;
            font-size: 0.85em;
        }

        .strength-label {
            margin-bottom: 5px;
            color: #bbb;
        }

        .strength-bar-container {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-bottom: 6px;
        }

        .strength-bar {
            height: 100%;
            width: 0;
            transition: width 0.3s ease, background 0.3s ease;
            border-radius: 2px;
        }

        .strength-weak {
            width: 33%;
            background: #dc2626;
        }

        .strength-medium {
            width: 66%;
            background: #f59e0b;
        }

        .strength-strong {
            width: 100%;
            background: #16a34a;
        }

        #passwordRequirements {
            color: #888;
            font-size: 0.85em;
        }
        
        /* Coupon Card Styles */
        .coupon-container {
            text-align: center;
            padding: 10px 0;
        }
        
        .coupon-icon {
            font-size: 48px;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .coupon-icon.redeemed {
            color: #16a34a;
        }
        
        .coupon-status h3 {
            margin-bottom: 10px;
            color: #1a1a1a;
        }
        
        .coupon-status p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .coupon-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.9rem;
            background: #e3f2fd;
            color: #0d47a1;
            margin-bottom: 20px;
        }
        
        .coupon-badge.redeemed {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        #redeemCouponBtn {
            transition: all 0.3s ease;
            display: block;
            margin: 0 auto;
        }
        
        #redeemCouponBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .coupon-redeemed {
            text-align: center;
        }
        
        .coupon-redeemed h3 {
            margin-bottom: 10px;
            color: #1a1a1a;
        }
        
        .coupon-redeemed p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .redemption-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .redemption-info p {
            margin: 0;
            color: #555;
        }
        
        /* Coupon Redemption Modal */
        .redemption-modal .modal-content {
            max-width: 500px;
            padding: 30px;
            background: white;
            border-radius: 15px;
            text-align: center;
        }
        
        .redemption-modal .modal-icon {
            font-size: 60px;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .redemption-modal h2 {
            color: #1a1a1a;
            margin-bottom: 15px;
        }
        
        .redemption-modal p {
            color: #666;
            margin-bottom: 25px;
        }
        
        .redemption-modal .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .redemption-modal .confirm-btn {
            background: #16a34a;
        }
        
        .redemption-modal .confirm-btn:hover {
            background: #15803d;
        }

        /* Car models display styling */
        .car-models-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 5px 0;
        }
        
        .car-model-badge {
            background: rgba(0, 123, 255, 0.2);
            color: #fff;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .car-model-badge i {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* Address display styling */
        .address-display {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            color: #fff;
            line-height: 1.6;
            transition: all 0.3s ease;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .address-display address {
            font-style: normal;
            margin: 0;
        }
        
        .edit-info-btn {
            margin-top: 15px;
            background: transparent;
            border: 1px solid #007bff;
            color: #007bff;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-info-btn:hover {
            background: rgba(0, 123, 255, 0.1);
        }

        .form-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .address-fields {
            grid-column: 1 / -1;
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .address-fields #editStreet {
            grid-column: 1 / -1;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .icon-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .icon-btn i {
            margin-right: 6px;
        }

        #addressUpdateForm {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        /* … your existing styles … */
        .badge.upcoming {
            background: #ffca28;
            color: #1a1a1a;
            padding: 2px 6px;
            margin-left: 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            vertical-align: middle;
        }

        /* Add to existing dashboard styles */
        .status-indicators {
            display: flex;
            gap: 1.5rem;
            align-items: center;  /* Vertical centering */
            justify-content: center;  /* Horizontal centering */
            margin: 1rem 0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: #f8f9fa;
        }

        .status-icon {
            font-size: 1.2rem;
        }

        /* Ensure text alignment */
        .status-text {
            color: #333; /* Changed from white to dark grey */
            font-weight: 500;
            margin: 0;
        }

        /* If using status badges */
        .status-badge {
            color: #333 !important; /* Force text color */
            background-color: #f8f9fa;
        }

        .upcoming-events {
            position: relative;
            padding-right: 120px; /* Space for button */
        }

        .upcoming-events .btn-small {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .error-alert {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Add these styles */
        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 1.2rem;
        }

        .missing-info {
            color: #ff6b6b;
            font-style: italic;
        }

        #addressDisplay p {
            margin: 2px 0;
            line-height: 1.4;
        }

        .verified-info {
            color: #4CAF50;
            font-weight: 500;
        }

        .missing-info {
            color: #FF5252;
            background: rgba(255,82,82,0.1);
            padding: 8px 12px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .address-line {
            font-weight: 500;
            font-size: 1.1em;
        }

        .city-province {
            color: #666;
        }

        .postal-code {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
        
        /* Username display styling */
        .username-display {
            margin: 0.25rem 0 0.75rem;
            font-size: 0.95rem;
            color: #5c5e62;
        }
        
        .username-label {
            font-weight: 500;
            margin-right: 0.5rem;
        }
        
        #userUsername {
            font-family: monospace;
            background: rgba(0, 230, 118, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            color: #171a20;
        }

        /* Profile Completion Progress Bar */
        .profile-completion-status {
            margin-top: 20px;
            text-align: center;
        }
        
        .progress-container {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #ff9800, #00e676);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .profile-completion-status span {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Dashboard Page Specific Styles */
        /* Removing this style that changes the background color
        body.dashboard-page {
            background-color: #121212;
            font-family: 'Montserrat', sans-serif;
        }
        */
        
        /* Full Profile Update Section Styles */
        .full-profile-update-section {
            background: linear-gradient(145deg, rgba(76, 175, 80, 0.05) 0%, rgba(33, 150, 243, 0.05) 100%);
            border-radius: 12px;
            padding: 24px;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
        }
        
        .full-profile-update-section:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.12);
        }
        
        .profile-update-description {
            color: #e0e0e0;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .profile-update-benefits {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .benefit-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .benefit-item i {
            color: #4CAF50;
            font-size: 16px;
        }
        
        .benefit-item span {
            color: #e0e0e0;
            font-size: 0.9rem;
        }
        
        .profile-update-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: linear-gradient(90deg, #4CAF50 0%, #2196F3 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            border: none;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
            text-decoration: none;
            text-transform: none;
            letter-spacing: 0.5px;
        }
        
        .profile-update-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            background: linear-gradient(90deg, #43A047 0%, #1E88E5 100%);
        }
        
        .profile-update-btn i:last-child {
            transition: transform 0.3s ease;
        }
        
        .profile-update-btn:hover i:last-child {
            transform: translateX(4px);
        }
        
        @media (max-width: 768px) {
            .full-profile-update-section {
                padding: 20px;
            }
            
            .profile-update-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
        }

        /* Stats Grid Styling */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .stat-item:hover {
            background: rgba(0, 230, 118, 0.08);
            transform: translateY(-3px);
        }

        .stat-label {
            display: block;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }

        .stat-value {
            display: block;
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffffff;
        }

        /* Member ID specific styling - ensure it's white and visible */
        #memberId {
            color: #ffffff !important;
            font-weight: 700 !important;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Coupon Styling - ensure text is white and visible */
        .coupon-container {
            text-align: center;
            padding: 10px;
        }
        
        .coupon-icon {
            font-size: 2.5rem;
            color: #00e676;
            margin-bottom: 15px;
        }
        
        .coupon-status h3 {
            margin-top: 0;
            font-size: 1.3rem;
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .coupon-status p {
            color: rgba(255, 255, 255, 0.9) !important;
        }
        
        .coupon-badge {
            display: inline-block;
            background: rgba(0, 230, 118, 0.2);
            color: #00e676;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            margin: 15px 0;
        }
        
        .coupon-badge.redeemed {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        /* iOS Optimizations */
    </style>
    <!-- Add this in the head section -->
    <script>
    // Global Supabase initialization
    window.supabaseClient = supabase.createClient(
        'https://qhkcrrphsjpytdfqfamq.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoa2NycnBoc2pweXRkZnFmYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzMjQ4NzgsImV4cCI6MjA0OTkwMDg3OH0.S9JT_WmCWYMvSixRq1RrB1UlqXm6fix_riLFYCR3JOI',
        {
            auth: {
                persistSession: true,
                autoRefreshToken: true
            }
        }
    );
    </script>
    <script>
    // Moved and Enhanced sanitizeProfileData function
    function sanitizeProfileData(rawProfile) {
        console.log('[LOG] sanitizeProfileData received rawProfile:', JSON.stringify(rawProfile));
        const source = rawProfile || {};
        // Create a mutable copy. If source is an empty object, profile will be too.
        const profile = JSON.parse(JSON.stringify(source));

        // Ensure all critical fields exist with reasonable defaults

        // Full Name:
        profile.full_name = source.full_name || profile.full_name || '';
        profile.first_name = source.first_name || '';
        profile.last_name = source.last_name || '';
        
        // Username (user email before the @ if not provided)
        profile.username = source.username || '';
        if (!profile.username && profile.email) {
            // Extract username from email as fallback
            profile.username = profile.email.split('@')[0];
        }

        // Membership type
        profile.membership_type = source.membership_type || 'standard';

        // Member ID:
        let tempMemberId = source.member_id; 
        if (typeof tempMemberId === 'string') tempMemberId = tempMemberId.trim();
        let localStorageMemberId = localStorage.getItem('userMemberId');
        if (typeof localStorageMemberId === 'string') localStorageMemberId = localStorageMemberId.trim();
        profile.member_id = tempMemberId || localStorageMemberId || 'Not Available'; // Explicit fallback

        // Phone:
        let tempPhone = source.phone_number || source.phone; // Prefer source.phone_number or source.phone from DB
        if (typeof tempPhone === 'string') tempPhone = tempPhone.trim();
        profile.phone = tempPhone || 'Not provided';

        // Ensure membership_status is set properly
        profile.membership_status = source.membership_status || 'pending';
        
        // Set email_verified flag
        profile.email_verified = !!source.email_verified;
        
        // Email
        profile.email = source.email || '';
        
        // Created and updated timestamps
        profile.created_at = source.created_at || new Date().toISOString();
        profile.updated_at = source.updated_at || new Date().toISOString();
        
        // Car models
        profile.car_models = Array.isArray(source.car_models) ? source.car_models : [];
        
        // Date of birth
        profile.date_of_birth = source.date_of_birth || '';

        // Address fields: Now primarily working with a single full_address string
        profile.full_address = (source.full_address || '').trim();

        // First use the direct individual fields if they exist in the source data
        profile.street = source.street || '';
        profile.city = source.city || '';
        profile.province = source.province || '';
        profile.postal_code = source.postal_code || '';

        // Only try to parse the full_address if we don't have the individual components already
        if (profile.full_address && (!profile.street || !profile.city || !profile.province || !profile.postal_code)) {
            // Regex to capture: (anything for street), (city), (2-letter province), (postal code)
            // This regex assumes the province is 2 uppercase letters and postal code is A1A 1A1 format.
            // It tries to make the street part flexible to include commas.
            const addressRegex = /^(.*?),\s*([^,]+),\s*([A-Z]{2}),\s*([A-Z]\d[A-Z]\s*\d[A-Za-z]\d)$/i;
            const match = profile.full_address.match(addressRegex);

            if (match) {
                profile.street = (match[1] || '').trim();
                profile.city = (match[2] || '').trim();
                profile.province = (match[3] || '').toUpperCase().trim();
                profile.postal_code = (match[4] || '').toUpperCase().trim();
            } else {
                // Fallback for simpler comma splitting if regex doesn't match
                const parts = profile.full_address.split(',').map(part => part.trim());
                if (parts.length >= 1) profile.street = parts[0] || profile.street;
                if (parts.length >= 2) profile.city = parts[1] || profile.city;
                if (parts.length >= 3) profile.province = parts[2] || profile.province;
                if (parts.length >= 4) profile.postal_code = parts[3] || profile.postal_code;
                console.log('[sanitizeProfileData] Regex did not match, used fallback split. Parts:', parts);
            }
        }

        // If we still don't have a full_address but have the components, rebuild it
        if (!profile.full_address && profile.street && profile.city) {
            profile.full_address = `${profile.street}, ${profile.city}${profile.province ? ', ' + profile.province : ''}${profile.postal_code ? ', ' + profile.postal_code : ''}`;
        }
        
        // Keep the address object for backward compatibility
        profile.address = {
            street: profile.street,
            city: profile.city,
            province: profile.province,
            postal_code: profile.postal_code
        };

        console.log('[LOG] sanitizeProfileData returning profile:', JSON.stringify(profile));
        return profile;
    }

    // Global Supabase initialization (if not already moved higher, this is a good place)
    if (!window.supabaseClient) {
        window.supabaseClient = supabase.createClient(
            'https://qhkcrrphsjpytdfqfamq.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoa2NycnBoc2pweXRkZnFmYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzMjQ4NzgsImV4cCI6MjA0OTkwMDg3OH0.S9JT_WmCWYMvSixRq1RrB1UlqXm6fix_riLFYCR3JOI',
            {
                auth: {
                    persistSession: true,
                    autoRefreshToken: true
                }
            }
        );
    }
    </script>
</head>
<body class="dashboard-page">
    <!-- Standard Navigation -->
    <nav>
        <div class="logo">
            <a href="index.html">
                <img src="https://i.ibb.co/fkrdXZK/Logo4-white.png" 
                     alt="Blitz Tesla Club Logo" 
                     loading="lazy" 
                     width="40" 
                     height="40" 
                     style="display: block !important; width: 40px !important; height: 40px !important; border-radius: 8px !important; margin-right: 12px !important; max-width: 40px !important; max-height: 40px !important; opacity: 1 !important; visibility: visible !important; object-fit: contain !important; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2)) !important;"
                     onerror="this.onerror=null; this.src='https://i.postimg.cc/BvmtNLtB/logo.png';">
                <span style="display: inline-block !important; visibility: visible !important; opacity: 1 !important;">BLITZ T CLUB</span>
            </a>
        </div>
        <button class="menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="nav-links">
            <i class="fas fa-bars"></i>
        </button>
        <ul class="nav-links" id="nav-links">
            <!-- Navigation items will be dynamically inserted by navigation.js -->
        </ul>
    </nav>

    <!-- Dashboard Content -->
    <main class="dashboard-container">
        <!-- Welcome Header -->
        <div class="dashboard-header">
            <div class="user-welcome">
                <h1>Welcome, <span id="userFullName"></span></h1>
                <div class="username-display">
                    <span class="username-label">Username:</span>
                    <span id="userUsername"></span>
                </div>
                <div class="status-badge">
                    <span class="status-label">Membership Status:</span>
                    <span id="membershipStatus" data-status="pending"></span>
                    <span class="verification-status" id="verificationStatus"></span>
                </div>
            </div>
            <div class="quick-actions">
                <button class="btn primary-btn" id="membershipCardBtn">
                    <i class="fas fa-id-card"></i>
                    View Membership Card
                </button>
                <!-- Admin Dashboard Button - Only visible to admins -->
                <button class="btn admin-btn" id="adminDashboardBtn" style="display: none;">
                    <i class="fas fa-user-shield"></i>
                    Admin Dashboard
                </button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Profile Completion Alert -->
            <div id="profileCompletionAlert" class="dashboard-card completion-alert hidden" style="display: none !important; visibility: hidden;">
                <div class="card-header">
                    <h2><i class="fas fa-exclamation-circle"></i> Complete Your Profile</h2>
                </div>
                <div class="card-content">
                    <p>Consider completing your profile to enhance your membership experience:</p>
                    <div class="missing-info-list" id="missingInfoList">
                        <!-- Missing fields will be listed here dynamically -->
                    </div>
                    <div class="completion-actions">
                        <a href="profile-completion.html" class="btn primary-btn">
                            <i class="fas fa-user-edit"></i> Complete Profile
                        </a>
                    </div>
                </div>
            </div>

            <!-- Upcoming Events Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-calendar"></i> Upcoming Events</h2>
                    <a href="events.html" class="view-all">View All</a>
                </div>
                <div class="card-content" id="upcomingEventsList">
                    <p class="no-events">No upcoming events at this time</p>
                </div>
            </div>

            <!-- Member Stats Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-line"></i> Member Stats</h2>
                </div>
                <div class="card-content">
                    <div class="stat-grid">
                        <div class="stat-item">
                            <span class="stat-label">Member Since</span>
                            <span class="stat-value" id="memberSince">Loading...</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Member ID</span>
                            <span class="stat-value" id="memberId" style="font-family: monospace; font-weight: bold;"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Events Attended</span>
                            <span class="stat-value" id="eventsAttended">0</span>
                        </div>
                    </div>
                    
                    <!-- Remove the profile completion status section -->
                </div>
            </div>

            <!-- Quick Links Card (now before Member Coupon) -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-link"></i> Quick Links</h2>
                </div>
                <div class="card-content">
                    <div class="quick-links-grid">
                        <a href="events.html" id="registerEvent" class="quick-link-item">
                            <i class="fas fa-calendar-plus"></i>
                            <span>Register for Event</span>
                        </a>
                        <a href="javascript:void(0)" id="viewInvoices" class="quick-link-item">
                            <i class="fas fa-file-invoice"></i>
                            <span>
                              View Invoices 
                              <small class="badge upcoming">Coming Soon</small>
                            </span>
                        </a>
                        <a href="#" class="quick-link-item" id="accountSettingsBtn">
                            <i class="fas fa-cog"></i>
                            <span>Account Settings</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Member Coupon Card (now after Quick Links) -->
            <div class="dashboard-card" id="couponCard">
                <div class="card-header">
                    <h2><i class="fas fa-ticket-alt"></i> Member Coupon</h2>
                </div>
                <div class="card-content">
                    <div class="coupon-container">
                        <div class="coupon-status" id="couponStatus">
                            <div class="coupon-icon">
                                <i class="fas fa-gift"></i>
                            </div>
                            <h3 style="color: #ffffff !important;">Club Event Item Coupon</h3>
                            <p style="color: rgba(255, 255, 255, 0.9) !important;">As a valued member, you receive one coupon to redeem for an exclusive club event item.</p>
                            <div class="coupon-badge" id="couponBadge">Available</div>
                            <button class="btn primary-btn" id="redeemCouponBtn">
                                <i class="fas fa-ticket-alt"></i> Redeem Coupon
                            </button>
                        </div>
                        <div class="coupon-redeemed" id="couponRedeemed" style="display: none;">
                            <div class="coupon-icon redeemed">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3>Coupon Redeemed</h3>
                            <p>You've already redeemed your club event item coupon.</p>
                            <div class="coupon-badge redeemed">Redeemed</div>
                            <div class="redemption-info">
                                <p>Redeemed on: <span id="redemptionDate">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer></footer>
    
    <!-- JotForm Chatbot Widget -->
    <script src='https://cdn.jotfor.ms/agent/embedjs/0197a4f8c2107841a0d93e4272525cea385d/embed.js?skipWelcome=1&maximizable=1'></script>
    
    <!-- Global Footer -->
    <script src="footer.js"></script>
</body>
</html> 