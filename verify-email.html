<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Verify Email - Blitz T Club</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/BvmtNLtB/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="login-page">
    <nav>
        <div class="logo">
            <a href="index.html">
                <img src="https://i.ibb.co/fkrdXZK/Logo4-white.png" alt="Blitz Tesla Club Logo" loading="lazy" width="50" height="50">
                <span>BLITZ T CLUB</span>
            </a>
        </div>
        <div class="menu-toggle">
            <i class="fas fa-bars"></i>
        </div>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="events.html">Events</a></li>
            <li><a href="gallery.html">Gallery</a></li>
            <li><a href="executive.html">Executives</a></li>
            <li><a href="news.html">News</a></li>
            <li><a href="register.html">Join Us</a></li>
            <li><a href="login.html">Login</a></li>
        </ul>
    </nav>

    <main class="login-container">
        <div class="login-box verify-box">
            <div class="login-header">
                <img src="https://i.postimg.cc/BvmtNLtB/logo.png" alt="Blitz Tesla Club Logo" class="login-logo">
                <h2>Verifying Your Email</h2>
                <p id="verification-status-text">Verifying your membership status...</p>
            </div>

            <div class="verification-progress" id="verification-progress">
                <div class="progress-container">
                    <div class="progress-bar"></div>
                </div>
            </div>

            <div class="verify-content" id="verification-content">
                <div class="verify-icon">
                    <i class="fas fa-spinner fa-spin" id="verification-icon"></i>
                </div>
                <p class="verify-message" id="verification-message">
                    Please wait while we verify your email address...
                </p>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>Quick Links</h3>
                <div class="footer-links">
                    <a href="index.html">Home</a>
                    <a href="events.html">Events</a>
                    <a href="gallery.html">Gallery</a>
                    <a href="contact.html">Contact</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Member Area</h3>
                <div class="footer-links">
                    <a href="login.html">Login</a>
                    <a href="register.html">Register</a>
                    <a href="sponsors.html">Our Sponsors</a>
                    <a href="#member-benefits">Member Benefits</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Legal</h3>
                <div class="footer-links">
                    <a href="privacy.html">Privacy Policy</a>
                    <a href="terms.html">Terms of Service</a>
                    <a href="about.html">About Us</a>
                </div>
            </div>

            <div class="footer-section">
                <h3>Connect With Us</h3>
                <div class="footer-social">
                    <a href="https://x.com/BlitzTClub" target="_blank" aria-label="Follow us on X">
                        <i class="fa-brands fa-square-x-twitter"></i>
                    </a>
                    <a href="https://www.instagram.com/blitztclub/" target="_blank" aria-label="Follow us on Instagram">
                        <i class="fab fa-instagram"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <p>Â© 2024 Blitz T Club. All rights reserved.</p>
            <p class="powered-by">
                Website powered by <a href="http://www.summitpixels.com" target="_blank">SummitPixels</a>
            </p>
        </div>
    </footer>

    <style>
        .login-box.verify-box {
            max-width: 600px;
            text-align: center;
        }

        .verify-icon {
            font-size: 60px;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .verify-content {
            padding: 20px;
        }

        .verify-message {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .verify-email {
            background: rgba(76, 175, 80, 0.1);
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin: 20px 0;
            word-break: break-all;
        }

        .verify-actions {
            margin: 30px 0;
        }

        .resend-btn {
            background: transparent;
            border: 2px solid #4CAF50;
            color: #4CAF50;
            padding: 10px 20px;
            margin-bottom: 15px;
        }

        .resend-btn:hover {
            background: #4CAF50;
            color: white;
        }

        .timer {
            font-size: 14px;
            color: #999;
        }

        .verify-help {
            margin-top: 30px;
            font-size: 14px;
            color: #999;
        }

        .verification-progress {
            margin: 20px 0;
        }
        
        .progress-container {
            background-color: #333;
            border-radius: 10px;
            height: 10px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar {
            background-color: #4CAF50;
            height: 100%;
            width: 0%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .success-icon {
            color: #4CAF50;
        }
        
        .error-icon {
            color: #f44336;
        }

        .verify-actions button {
            margin: 0 10px;
        }

        .retry-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }
        
        .continue-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Supabase client
            window.supabaseClient = supabase.createClient(
                'https://qhkcrrphsjpytdfqfamq.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoa2NycnBoc2pweXRkZnFmYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzMjQ4NzgsImV4cCI6MjA0OTkwMDg3OH0.S9JT_WmCWYMvSixRq1RrB1UlqXm6fix_riLFYCR3JOI',
                {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true
                    }
                }
            );

            // Helper function to update UI
            function updateUI(status, message, icon, progress = 0) {
                document.getElementById('verification-status-text').textContent = status;
                document.getElementById('verification-message').textContent = message;
                
                const iconElement = document.getElementById('verification-icon');
                iconElement.className = icon;
                
                document.querySelector('.progress-bar').style.width = `${progress}%`;
            }

            // Helper function to get URL parameters
            function getQueryParam(param) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(param);
            }

            // Helper function to get hash parameters
            function getHashParam(param) {
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                return hashParams.get(param);
            }

            // Helper function to show success UI
            function showSuccess() {
                updateUI(
                    "Email Verified Successfully!", 
                    "Your email has been verified and your membership is now active.", 
                    "fas fa-check-circle success-icon", 
                    100
                );
                
                // Add continue button
                const content = document.getElementById('verification-content');
                content.innerHTML += `<div class="verify-actions">
                    <button onclick="window.location.href='dashboard.html?verified=true'" class="continue-btn">
                        <i class="fas fa-arrow-right"></i> Continue to Dashboard
                    </button>
                </div>`;
                
                // Clean up verification data
                localStorage.removeItem('verificationToken');
                localStorage.removeItem('tokenExpiry');
                localStorage.removeItem('pendingVerificationEmail');
            }

            // Helper function to update profile
            async function updateUserProfile(userId, userEmail, userName = null) {
                try {
                    console.log('Attempting to update profile for user:', userId);
                    
                    // Check if profile exists
                    const { data: existingProfile, error: fetchError } = await window.supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('id', userId)
                        .maybeSingle();

                    if (fetchError) {
                        console.error('Error fetching profile:', fetchError);
                        console.error('Error details:', {
                            message: fetchError.message,
                            code: fetchError.code,
                            details: fetchError.details
                        });
                    }

                    console.log('Profile lookup result:', existingProfile || 'No profile found');

                    // Prepare full name if not provided
                    let fullName = userName;
                    if (!fullName && userEmail) {
                        const emailName = userEmail.split('@')[0];
                        const nameParts = emailName.split(/[.-_]/);
                        const firstName = nameParts[0] ? nameParts[0].charAt(0).toUpperCase() + nameParts[0].slice(1) : '';
                        const lastName = nameParts[1] ? nameParts[1].charAt(0).toUpperCase() + nameParts[1].slice(1) : '';
                        if (firstName && lastName) {
                            fullName = `${firstName} ${lastName}`;
                        } else {
                            fullName = 'Member';
                        }
                    }

                    if (existingProfile) {
                        // Update existing profile
                        const { data: updateData, error: updateError } = await window.supabaseClient
                            .from('profiles')
                            .update({
                                membership_status: 'active',
                                email_verified: true,
                                verification_token: null,
                                verification_sent_at: null,
                                status: 'active', // for backward compatibility
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', userId)
                            .select('*');
                            
                        if (updateError) {
                            console.error('Error updating profile:', updateError);
                            console.error('Error details:', {
                                message: updateError.message,
                                code: updateError.code,
                                details: updateError.details
                            });
                            
                            // Try upsert as fallback
                            console.log('Attempting profile update with upsert...');
                            const { data: upsertData, error: upsertError } = await window.supabaseClient
                                .from('profiles')
                                .upsert({
                                    id: userId,
                                    email: userEmail,
                                    full_name: existingProfile.full_name || fullName,
                                    membership_status: 'active',
                                    email_verified: true,
                                    status: 'active',
                                    updated_at: new Date().toISOString()
                                }, { onConflict: 'id' })
                                .select('id, email, membership_status');
                            
                            if (upsertError) {
                                console.error('Upsert profile failed:', upsertError);
                                throw new Error(`Could not update profile (${upsertError.code}): ${upsertError.message}`);
                            }
                            
                            console.log('Profile successfully updated via upsert:', upsertData);
                            return true;
                        } else {
                            console.log('Profile successfully updated:', updateData);
                            return true;
                        }
                    } else {
                        // No profile exists yet, we need to create one with minimal fields
                        console.log('Creating new profile for user:', userId);
                        
                        const { data: insertData, error: insertError } = await window.supabaseClient
                            .from('profiles')
                            .insert({
                                id: userId,
                                email: userEmail,
                                full_name: fullName,
                                membership_status: 'active',
                                email_verified: true,
                                status: 'active',
                                role: 'member',
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            })
                            .select('id, email, membership_status');
                        
                        if (insertError) {
                            console.error('Failed to create profile:', insertError);
                            console.error('Error details:', {
                                message: insertError.message,
                                code: insertError.code,
                                details: insertError.details
                            });
                            throw new Error(`Could not create profile (${insertError.code}): ${insertError.message}`);
                        }
                        
                        console.log('Created new profile:', insertData);
                        return true;
                    }
                } catch (error) {
                    console.error('Error updating user profile:', error);
                    return false;
                }
            }

            try {
                updateUI(
                    "Verifying your email...", 
                    "We're processing your verification request.", 
                    "fas fa-spinner fa-spin", 
                    30
                );
                
                console.log("URL hash:", window.location.hash);
                console.log("URL search params:", window.location.search);
                
                // Check for email confirmation link directly from Supabase
                // This is the standard format Supabase uses for email confirmation
                const confirmType = getQueryParam('type');
                const confirmToken = getQueryParam('token');
                const source = getQueryParam('source');
                
                // Check for Supabase auth token in hash (OAuth or magic link format)
                const accessToken = getHashParam('access_token');
                const refreshToken = getHashParam('refresh_token');
                const hashType = getHashParam('type');
                
                // Check for custom token from our system
                const customToken = getQueryParam('token');
                const tokenFromStorage = localStorage.getItem('verificationToken');

                // CASE 1: Handle direct Supabase email confirmation
                if ((confirmType === 'signup' || confirmType === 'email_change') && confirmToken) {
                    console.log('Found Supabase email confirmation link');
                    updateUI(
                        "Supabase email confirmation detected", 
                        "Processing your verification from email...", 
                        "fas fa-spinner fa-spin", 
                        50
                    );
                    
                    try {
                        // Use the verification token directly with Supabase
                        const { error } = await window.supabaseClient.auth.verifyOtp({
                            token: confirmToken,
                            type: confirmType
                        });
                        
                        if (error) {
                            console.error('OTP verification error:', error);
                            throw error;
                        }
                        
                        // Get the current user after verification
                        const { data: { user }, error: userError } = await window.supabaseClient.auth.getUser();
                        
                        if (userError || !user) {
                            console.error('Could not get user after verification:', userError);
                            throw new Error('Could not get user after verification');
                        }
                        
                        console.log('User authenticated after verification:', user.id);
                        
                        // Update the user's profile
                        const profileUpdated = await updateUserProfile(
                            user.id, 
                            user.email, 
                            user.user_metadata?.full_name
                        );
                        
                        if (profileUpdated) {
                            showSuccess();
                        } else {
                            throw new Error('Failed to update user profile');
                        }
                    } catch (error) {
                        console.error('Error with Supabase email confirmation:', error);
                        throw error;
                    }
                }
                // CASE 2: Handle Supabase auth token in hash (from magic link or OAuth)
                else if (accessToken) {
                    console.log('Found Supabase access token in URL:', accessToken?.substring(0, 5) + '...');
                    console.log('Verification type:', hashType);
                    
                    updateUI(
                        "Supabase verification detected", 
                        "Processing your verification...", 
                        "fas fa-spinner fa-spin", 
                        50
                    );

                    try {
                        // Set session with the token
                        const { data, error } = await window.supabaseClient.auth.setSession({
                            access_token: accessToken,
                            refresh_token: refreshToken
                        });
                        
                        if (error) {
                            console.error('Session error:', error);
                            throw error;
                        }
                        
                        // Get user info
                        const user = data.user;
                        
                        if (!user || !user.id) {
                            throw new Error('User authentication failed. Could not retrieve user ID.');
                        }
                        
                        console.log('User authenticated:', user.id);
                        console.log('User metadata:', user.user_metadata);
                        console.log('Email verified:', user.email_confirmed_at ? 'Yes' : 'No');
                        
                        // Update the user's profile
                        const profileUpdated = await updateUserProfile(
                            user.id, 
                            user.email, 
                            user.user_metadata?.full_name
                        );
                        
                        if (profileUpdated) {
                            showSuccess();
                        } else {
                            throw new Error('Failed to update user profile');
                        }
                    } catch (error) {
                        console.error('Error with Supabase verification:', error);
                        updateUI(
                            "Verification Failed", 
                            `We couldn't verify your email: ${error.message}. Please try again or contact support.`, 
                            "fas fa-times-circle error-icon", 
                            100
                        );
                        
                        // Add retry button
                        const content = document.getElementById('verification-content');
                        content.innerHTML += `<div class="verify-actions">
                            <button onclick="window.location.href='verification-sent.html'" class="retry-btn">
                                <i class="fas fa-redo"></i> Try Again
                            </button>
                        </div>`;
                    }
                }
                // CASE 3: Handle our custom token (from FormSubmit email)
                else if (customToken && tokenFromStorage && customToken === tokenFromStorage) {
                    console.log('Found matching custom token in URL and storage');
                    updateUI(
                        "Token verification in progress", 
                        "Verifying your token...", 
                        "fas fa-spinner fa-spin", 
                        50
                    );
                    
                    // Check if token is expired
                    const tokenExpiry = localStorage.getItem('tokenExpiry');
                    if (tokenExpiry && new Date() > new Date(tokenExpiry)) {
                        throw new Error('Verification token has expired');
                    }
                    
                    // Get the user email from storage
                    const userEmail = localStorage.getItem('pendingVerificationEmail');
                    if (!userEmail) {
                        throw new Error('User email not found');
                    }
                    
                    // Try to get current user session
                    try {
                        const { data: sessionData } = await window.supabaseClient.auth.getSession();
                        let userId;
                        
                        if (sessionData?.session?.user) {
                            userId = sessionData.session.user.id;
                            console.log('User already logged in:', userId);
                        }
                        
                        // If no session, try to find the user by email
                        if (!userId) {
                            const { data: profiles, error: profilesError } = await window.supabaseClient
                                .from('profiles')
                                .select('id, email')
                                .eq('email', userEmail)
                                .maybeSingle();
                            
                            if (profilesError) {
                                console.warn('Could not find profile by email:', profilesError);
                                throw new Error('Could not find your profile. Please try logging in first.');
                            } else if (profiles) {
                                userId = profiles.id;
                                console.log('Found user ID by email lookup:', userId);
                            } else {
                                throw new Error('No profile found with this email. Please register first.');
                            }
                        }
                        
                        if (!userId) {
                            throw new Error('Could not determine user ID. Please try logging in first.');
                        }
                        
                        // Update the user's profile
                        const profileUpdated = await updateUserProfile(userId, userEmail);
                        
                        if (profileUpdated) {
                            showSuccess();
                        } else {
                            throw new Error('Failed to update user profile');
                        }
                    } catch (error) {
                        console.error('Error processing custom token:', error);
                        throw error;
                    }
                }
                else {
                    // No valid token found
                    if (customToken && !tokenFromStorage) {
                        console.log('Token in URL but not in storage');
                        throw new Error('This verification link is not valid for your current device. Please try the verification link on the device where you initiated the verification.');
                    } else if (!customToken && tokenFromStorage) {
                        console.log('Token in storage but not in URL');
                        throw new Error('No verification token found in the URL. Please use the exact link sent to your email.');
                    } else {
                        console.log('No token found anywhere');
                        throw new Error('No verification token found. Please request a new verification email.');
                    }
                }
            } catch (error) {
                console.error('Verification process error:', error);
                updateUI(
                    "Verification Failed", 
                    `We couldn't verify your email: ${error.message}`, 
                    "fas fa-times-circle error-icon", 
                    100
                );
                
                // Add retry button
                const content = document.getElementById('verification-content');
                content.innerHTML += `<div class="verify-actions">
                    <button onclick="window.location.href='verification-sent.html'" class="retry-btn">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                </div>`;
            }
        });
    </script>
</body>
</html> 