<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dashboard - Blitz Tesla Club</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/BvmtNLtB/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        /* iOS Optimizations */
        @supports (-webkit-touch-callout: none) {
            .dashboard-container {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }

            .dashboard-header {
                margin-top: env(safe-area-inset-top);
            }

            nav {
                padding-top: env(safe-area-inset-top);
            }

            footer {
                padding-bottom: env(safe-area-inset-bottom);
            }

            /* Prevent text size adjustment */
            body {
                -webkit-text-size-adjust: none;
            }

            /* Improve touch targets */
            .nav-links a,
            .quick-actions button,
            .quick-link-item,
            .resend-btn {
                min-height: 44px;
                padding: 12px;
            }

            /* Smooth scrolling */
            .dashboard-container {
                -webkit-overflow-scrolling: touch;
            }

            /* Prevent unwanted highlighting */
            * {
                -webkit-tap-highlight-color: transparent;
            }
        }
    </style>
</head>
<body class="dashboard-page">
    <!-- Standard Navigation -->
    <nav>
        <div class="logo">
            <a href="/">
                <img src="https://i.ibb.co/fkrdXZK/Logo4-white.png" alt="Blitz Tesla Club Logo">
                <span>BLITZ TESLA CLUB</span>
            </a>
        </div>
        <div class="menu-toggle">
            <i class="fas fa-bars"></i>
        </div>
        <ul class="nav-links">
            <li><a href="dashboard.html" class="active">
                <i class="fas fa-home"></i>Dashboard
            </a></li>
            <li><a href="events.html">Events</a></li>
            <li><a href="gallery.html">Gallery</a></li>
            <li><a href="executive.html">Executives</a></li>
            <li><a href="news.html">News</a></li>
            <li><a href="#" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>Logout
            </a></li>
        </ul>
    </nav>

    <!-- Dashboard Content -->
    <main class="dashboard-container">
        <!-- Welcome Header -->
        <div class="dashboard-header">
            <div class="user-welcome">
                <h1>Welcome, <span id="userFullName"></span></h1>
                <div class="status-badge">
                    <span class="status-label">Membership Status:</span>
                    <span id="membershipStatus" data-status="pending"></span>
                    <span class="verification-status" id="verificationStatus"></span>
                </div>
            </div>
            <div class="quick-actions">
                <button class="btn primary-btn" id="editProfileBtn">
                    <i class="fas fa-user-edit"></i>
                    Edit Profile
                </button>
                <button class="btn primary-btn" id="membershipCardBtn">
                    <i class="fas fa-id-card"></i>
                    View Membership Card
                </button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Upcoming Events Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-calendar"></i> Upcoming Events</h2>
                    <a href="events.html" class="view-all">View All</a>
                </div>
                <div class="card-content" id="upcomingEventsList">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </div>
            </div>

            <!-- Member Stats Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-line"></i> Member Stats</h2>
                </div>
                <div class="card-content">
                    <div class="stat-grid">
                        <div class="stat-item">
                            <span class="stat-label">Member Since</span>
                            <span class="stat-value" id="memberSince">Loading...</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Member ID</span>
                            <span class="stat-value" id="memberId" style="font-family: monospace; font-weight: bold;"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Events Attended</span>
                            <span class="stat-value" id="eventsAttended">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Links Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-link"></i> Quick Links</h2>
                </div>
                <div class="card-content">
                    <div class="quick-links-grid">
                        <a href="#" class="quick-link-item">
                            <i class="fas fa-calendar-plus"></i>
                            <span>Register for Event</span>
                        </a>
                        <a href="#" class="quick-link-item">
                            <i class="fas fa-file-invoice"></i>
                            <span>View Invoices</span>
                        </a>
                        <a href="#" class="quick-link-item">
                            <i class="fas fa-cog"></i>
                            <span>Account Settings</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Standard Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>Quick Links</h3>
                <div class="footer-links">
                    <a href="index.html">Home</a>
                    <a href="events.html">Events</a>
                    <a href="gallery.html">Gallery</a>
                    <a href="contact.html">Contact</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Member Area</h3>
                <div class="footer-links">
                    <a href="sponsors.html">Our Sponsors</a>
                    <a href="#member-benefits">Member Benefits</a>
                    <a href="#" id="footerLogoutBtn">Logout</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Legal</h3>
                <div class="footer-links">
                    <a href="privacy.html">Privacy Policy</a>
                    <a href="terms.html">Terms of Service</a>
                    <a href="about.html">About Us</a>
                </div>
            </div>

            <div class="footer-section">
                <h3>Connect With Us</h3>
                <div class="footer-social">
                    <a href="https://x.com/BlitzTClub" target="_blank" aria-label="Follow us on X">
                        <i class="fa-brands fa-square-x-twitter"></i>
                    </a>
                    <a href="https://www.instagram.com/blitztclub/" target="_blank" aria-label="Follow us on Instagram">
                        <i class="fab fa-instagram"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <p>Â© 2024 Blitz Tesla Club. All rights reserved.</p>
            <p class="powered-by">
                Website powered by <a href="http://www.summitpixels.com" target="_blank">SummitPixels</a>
            </p>
        </div>
    </footer>

    <!-- Keep your existing script -->
    <script>
        // Function to generate random token
        function generateToken(length = 32) {
            const array = new Uint8Array(length);
            crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }
        
        // Initialize Supabase client
        const supabaseUrl = 'https://qhkcrrphsjpytdfqfamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoa2NycnBoc2pweXRkZnFmYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzMjQ4NzgsImV4cCI6MjA0OTkwMDg3OH0.S9JT_WmCWYMvSixRq1RrB1UlqXm6fix_riLFYCR3JOI';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        document.addEventListener('DOMContentLoaded', async () => {
            // Check if user is logged in
            const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
            
            console.log('Session:', session);
            
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            // Declare profile variable in outer scope
            let profile;

            try {
                // Get user profile
                const { data: userData, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();

                console.log('Profile query result:', { profile: userData, profileError });

                if (!userData && !profileError) {
                    // If profile doesn't exist, create one
                    const { data: newProfile, error: insertError } = await supabaseClient
                        .from('profiles')
                        .insert([{
                            id: session.user.id,
                            email: session.user.email,
                            full_name: session.user.user_metadata.full_name || 'Member',
                            username: session.user.email.split('@')[0].replace(/[^a-zA-Z0-9]/g, ''),
                            membership_status: 'pending',
                            membership_type: 'standard',
                            member_id: `BTC${Date.now().toString().slice(-6)}`
                        }])
                        .select()
                        .single();

                    if (insertError) {
                        console.error('Insert error:', insertError);
                        throw insertError;
                    }
                    profile = newProfile;
                } else {
                    profile = userData;
                }

                // Store registration date in a variable
                const formattedDate = profile.created_at ? 
                    new Date(profile.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'Not Available';

                // Update user info
                document.getElementById('userFullName').textContent = profile.full_name;
                const statusElement = document.getElementById('membershipStatus');
                statusElement.textContent = profile.membership_status.charAt(0).toUpperCase() + 
                    profile.membership_status.slice(1);
                statusElement.dataset.status = profile.membership_status;

                // Update member ID display
                const memberIdElement = document.getElementById('memberId');
                memberIdElement.textContent = profile.member_id || 'Not Assigned';
                memberIdElement.style.color = profile.membership_type === 'premium' ? '#9333ea' : '#0369a1';

                // Update member since date
                const memberSinceElement = document.getElementById('memberSince');
                memberSinceElement.textContent = formattedDate;

                // Get upcoming events
                const { data: events, error: eventsError } = await supabaseClient
                    .from('events')
                    .select('*')
                    .gt('event_date', new Date().toISOString())
                    .order('event_date', { ascending: true })
                    .limit(3);

                if (eventsError) throw eventsError;

                // Update events list
                const eventsList = document.getElementById('upcomingEventsList');
                if (events && events.length > 0) {
                    eventsList.innerHTML = events.map(event => `
                        <div class="event-item">
                            <h3>${event.title}</h3>
                            <p>${event.description}</p>
                            <span>${new Date(event.event_date).toLocaleDateString()}</span>
                        </div>
                    `).join('');
                } else {
                    eventsList.innerHTML = '<p>No upcoming events</p>';
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                alert(`Failed to load dashboard data: ${error.message || 'Unknown error'}`);
            }

            // Handle logout
            const logoutButtons = document.querySelectorAll('#logoutBtn, #footerLogoutBtn');
            logoutButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) {
                        console.error('Error signing out:', error);
                    }
                    localStorage.removeItem('supabase.auth.token');
                    sessionStorage.removeItem('supabase.auth.token');
                    window.location.href = 'login.html';
                });
            });

            // Handle mobile menu
            const menuToggle = document.querySelector('.menu-toggle');
            const navLinks = document.querySelector('.nav-links');
            const body = document.body;
            if (menuToggle && navLinks) {
                menuToggle.addEventListener('click', () => {
                    navLinks.classList.toggle('active');
                    body.classList.toggle('nav-open');
                });

                // Close menu when clicking a link
                navLinks.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        navLinks.classList.remove('active');
                        body.classList.remove('nav-open');
                    });
                });
            }

            // Add this after profile data is loaded
            const membershipCardBtn = document.getElementById('membershipCardBtn');
            const modal = document.getElementById('membershipCardModal');
            const closeModal = document.querySelector('.close-modal');

            membershipCardBtn.addEventListener('click', () => {
                // Format date for card display
                const formattedDate = profile.created_at ? 
                    new Date(profile.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'Not Available';

                // Update card info
                document.getElementById('cardFullName').textContent = profile.full_name;
                document.getElementById('cardMemberId').textContent = profile.member_id;
                document.getElementById('cardMemberSince').textContent = formattedDate;
                document.getElementById('cardMembershipStatus').textContent = 
                    profile.membership_type.charAt(0).toUpperCase() + profile.membership_type.slice(1);

                // Set card style based on membership type
                const cardElement = document.querySelector('.membership-card');
                cardElement.dataset.type = profile.membership_type;

                // Generate QR code
                const qrData = JSON.stringify({
                    id: profile.id,
                    memberId: profile.member_id,
                    type: profile.membership_type,
                    name: profile.full_name,
                    since: formattedDate,
                    verified: true
                });
                
                const qrCanvas = document.getElementById('memberQRCode');
                // Clear previous QR code if any
                const context = qrCanvas.getContext('2d');
                context.clearRect(0, 0, qrCanvas.width, qrCanvas.height);
                
                QRCode.toCanvas(qrCanvas, qrData, {
                    width: 120,
                    margin: 0,
                    color: {
                        dark: '#171a20',
                        light: '#ffffff'
                    }
                });

                modal.classList.add('show');
            });

            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });

            // In your existing profile update code
            const statusElement = document.getElementById('membershipStatus');
            const verificationStatus = document.getElementById('verificationStatus');
            
            if (profile.membership_status === 'pending') {
                // Generate verification token
                const verificationToken = generateToken();
                
                // Update verification token in profile
                await supabaseClient
                    .from('profiles')
                    .update({ verification_token: verificationToken })
                    .eq('id', profile.id);
                
                verificationStatus.innerHTML = `
                    <span class="badge warning">
                        <i class="fas fa-envelope"></i>
                        Please verify your email
                        <form action="https://formsubmit.co/${profile.email}" method="POST" style="display: inline;">
                            <input type="hidden" name="_to" value="${profile.email}">
                            <input type="hidden" name="_captcha" value="false">
                            <input type="hidden" name="_template" value="box">
                            <input type="hidden" name="_cc" value="info@blitztclub.com">
                            <input type="hidden" name="_subject" value="Verify Your Blitz Tesla Club Membership">
                            <input type="hidden" name="_next" value="https://www.blitztclub.com/verification-sent.html">
                            <input type="hidden" name="_replyto" value="${profile.email}">
                            <input type="hidden" name="_from" value="Blitz Tesla Club <info@blitztclub.com>">
                            <input type="hidden" name="_autoresponse" value="Thank you for verifying your email. Your Blitz Tesla Club membership will be activated shortly.">
                            <input type="hidden" name="message" value="
                                <div style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;'>
                                    <img src='https://i.postimg.cc/BvmtNLtB/logo.png' alt='Blitz Tesla Club Logo' style='width: 150px; margin: 20px auto; display: block;'>
                                    <h1 style='color: #171a20; text-align: center;'>Welcome to Blitz Tesla Club!</h1>
                                    <p style='text-align: center; color: #666;'>Please verify your email to activate your membership.</p>
                                    <div style='text-align: center; margin: 30px 0;'>
                                        <p style='margin-bottom: 20px;'>Your Member ID: <strong>${profile.member_id}</strong></p>
                                        <a href='https://www.blitztclub.com/verify-email?token=${verificationToken}' 
                                           style='background: #171a20; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; display: inline-block;'>
                                            Click Here to Verify Your Email
                                        </a>
                                    </div>
                                    <div style='margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;'>
                                        <p style='color: #171a20; margin-bottom: 10px;'><strong>Next Steps:</strong></p>
                                        <ol style='color: #666; text-align: left; margin-left: 20px;'>
                                            <li>Click the verification button above</li>
                                            <li>Your membership will be activated instantly</li>
                                            <li>Access your digital membership card</li>
                                            <li>Start enjoying member benefits</li>
                                        </ol>
                                    </div>
                                    <p style='color: #666; font-size: 14px; text-align: center;'>
                                        If you didn't request this email, please ignore it.
                                    </p>
                                </div>
                            ">
                            <button type="submit" class="resend-btn">
                                <i class="fas fa-redo"></i> Resend
                            </button>
                        </form>
                    </span>
                `;
            } else if (profile.membership_status === 'active') {
                verificationStatus.innerHTML = `
                    <span class="badge success">
                        <i class="fas fa-check-circle"></i>
                        Email verified
                    </span>
                `;
            }
        });
    </script>

    <!-- Membership Card Modal -->
    <div id="membershipCardModal" class="modal">
        <div class="modal-content membership-card">
            <div class="card-front">
                <div class="card-header">
                    <img src="https://i.ibb.co/fkrdXZK/Logo4-white.png" alt="Blitz Tesla Club Logo">
                    <div class="header-text">
                        <h2>Blitz Membership Card</h2>
                        <span class="card-type" id="cardType"></span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="member-photo">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="member-info">
                        <h3 id="cardFullName"></h3>
                        <div class="info-row">
                            <span class="label">Member ID:</span>
                            <span id="cardMemberId"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">Member Since:</span>
                            <span id="cardMemberSince"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">Status:</span>
                            <span id="cardMembershipStatus"></span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="qr-section">
                            <canvas class="qr-code" id="memberQRCode"></canvas>
                            <div class="qr-text">
                                <i class="fas fa-qrcode"></i>
                                <small>Scan to verify membership</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 