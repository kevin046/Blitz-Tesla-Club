<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dashboard - Blitz T Club</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/BvmtNLtB/logo.png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/BvmtNLtB/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="navigation.js" defer></script>
    <script>
        // Add a global direct logout function that can be called from anywhere
        window.performLogout = async function() {
            console.log('Direct logout function called');
            try {
                // Try to sign out through Supabase
                if (window.supabaseClient) {
                    await window.supabaseClient.auth.signOut()
                        .catch(e => console.error('Error during signOut call:', e));
                }
            } catch (error) {
                console.error('Critical error during logout attempt:', error);
            } finally {
                // Always clear storage and redirect regardless of errors
                console.log('Clearing storage and redirecting to login');
                localStorage.removeItem('supabase.auth.token');
                sessionStorage.removeItem('supabase.auth.token');
                
                // Clear any other auth-related storage that might exist
                try {
                    for (let key in localStorage) {
                        if (key.includes('supabase') || key.includes('auth') || key.includes('token')) {
                            localStorage.removeItem(key);
                        }
                    }
                    for (let key in sessionStorage) {
                        if (key.includes('supabase') || key.includes('auth') || key.includes('token')) {
                            sessionStorage.removeItem(key);
                        }
                    }
                } catch (e) {
                    console.error('Error clearing storage:', e);
                }
                
                // Force redirect to login page
                window.location.href = 'login.html';
            }
        };
        
        // Only keep necessary script elements for dashboard functionality, removing any mobile menu customizations
        
        // Calculate viewport height for mobile browsers (fix iOS issues)
        function setViewportHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        // Set the height on page load
        window.addEventListener('load', setViewportHeight);
        // Update height on resize and orientation change
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', setViewportHeight);
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
            background-color: #171a20;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }
        
        /* Special handling for mobile menu open state to prevent split screen */
        body.nav-open {
            overflow: hidden !important;
            position: fixed !important;
            width: 100% !important;
            height: 100% !important;
            touch-action: none !important;
        }
        
        .dashboard-page main {
            flex: 1;
            padding: 20px;
            z-index: 1;
        }
        
        /* iOS Optimizations */
        @supports (-webkit-touch-callout: none) {
            .dashboard-container {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }

            .dashboard-header {
                margin-top: env(safe-area-inset-top);
            }

            nav {
                padding-top: env(safe-area-inset-top);
            }

            footer {
                padding-bottom: env(safe-area-inset-bottom);
            }

            /* Prevent text size adjustment */
            body {
                -webkit-text-size-adjust: none;
            }

            /* Improve touch targets */
            .nav-links a,
            .quick-actions button,
            .quick-link-item,
            .resend-btn {
                min-height: 44px;
                padding: 12px;
            }

            /* Smooth scrolling */
            .dashboard-container {
                -webkit-overflow-scrolling: touch;
            }

            /* Prevent unwanted highlighting */
            * {
                -webkit-tap-highlight-color: transparent;
            }
        }
        
        /* Modern Membership Card Styles */
        .modal-content.membership-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: 16px;
            padding: 30px;
            margin: 0 auto;
            text-align: left;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            position: relative;
            overflow: hidden;
            transform: perspective(1000px) rotateY(0deg);
            transition: transform 0.5s ease;
        }
        
        .modal-content.membership-card:hover {
            transform: perspective(1000px) rotateY(5deg);
        }
        
        .modal-content.membership-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.05) 50%, 
                rgba(255,255,255,0) 100%);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            background: transparent;
            padding: 0;
            border: none;
        }
        
        .card-header img {
            height: 60px;
            width: auto;
            background: transparent;
            margin: 0;
        }
        
        .header-text h2 {
            font-size: 22px;
            margin: 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.95);
            background: transparent;
        }
        
        .member-info {
            margin: 25px 0;
            text-align: left;
        }
        
        .member-info h3 {
            font-size: 24px;
            margin-bottom: 25px;
            font-weight: 700;
            color: white;
            letter-spacing: 0.5px;
            text-transform: capitalize;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 14px;
            color: white;
            margin-bottom: 5px;
        }
        
        .info-row .label {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        
        .card-footer {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }
        
        .qr-section {
            text-align: center;
        }
        
        canvas.qr-code {
            width: 120px;
            height: 120px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin: 0 auto 15px;
        }
        
        .qr-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .qr-text i {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        /* Premium Card Style */
        .membership-card[data-type="premium"] {
            background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .membership-card[data-type="premium"]::before {
            background: linear-gradient(45deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.1) 50%, 
                rgba(255,255,255,0) 100%);
        }
        
        .membership-card[data-type="premium"] .header-text h2 {
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .membership-card[data-type="premium"] .info-row {
            border-bottom: 1px solid rgba(255, 255, 255, 0.25);
        }
        
        .membership-card[data-type="premium"] .qr-text {
            color: rgba(255, 255, 255, 0.9);
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Modal styling for the card */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow: auto;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease forwards;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            position: relative;
            margin: 20px;
            animation: modalSlideIn 0.4s ease-out forwards;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .close-modal:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(1.1);
        }

        .profile-settings {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
        }

        .form-group input {
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Edit Profile Modal Styles */
        .danger-btn {
            background-color: #dc3545;
            color: white;
        }
        
        .danger-btn:hover {
            background-color: #c82333;
        }
        
        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .toggle-password {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Modern Settings Modal Styles */
        .settings-modal {
            max-width: 600px;
            width: 90%;
            background: #1a1a1a;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .settings-modal .modal-header {
            background: #222;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            border-bottom: 1px solid #333;
        }

        .settings-modal .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            color: #fff;
        }

        .settings-modal .modal-body {
            padding: 20px;
        }

        .settings-section {
            background: #222;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 1.1em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            color: #888;
            font-size: 0.9em;
        }

        .info-value {
            color: #fff;
            font-weight: 500;
        }

        .modern-input {
            width: 100%;
            padding: 12px;
            background: #333;
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 0.95em;
            transition: border-color 0.3s ease;
        }

        .modern-input:focus {
            border-color: #666;
            outline: none;
        }

        .danger-zone {
            border: 1px solid #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .danger-text {
            color: #dc3545;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .primary-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .primary-btn:hover {
            background: #0056b3;
        }

        .danger-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .danger-btn:hover {
            background: #c82333;
        }

        .password-input-container {
            position: relative;
            width: 100%;
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0;
        }

        .toggle-password:hover {
            color: #888;
        }

        /* Password Strength Meter */
        .password-strength-meter {
            margin-top: 10px;
            font-size: 0.85em;
        }

        .strength-label {
            margin-bottom: 5px;
            color: #bbb;
        }

        .strength-bar-container {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-bottom: 6px;
        }

        .strength-bar {
            height: 100%;
            width: 0;
            transition: width 0.3s ease, background 0.3s ease;
            border-radius: 2px;
        }

        .strength-weak {
            width: 33%;
            background: #dc2626;
        }

        .strength-medium {
            width: 66%;
            background: #f59e0b;
        }

        .strength-strong {
            width: 100%;
            background: #16a34a;
        }

        #passwordRequirements {
            color: #888;
            font-size: 0.85em;
        }
        
        /* Coupon Card Styles */
        .coupon-container {
            text-align: center;
            padding: 10px 0;
        }
        
        .coupon-icon {
            font-size: 48px;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .coupon-icon.redeemed {
            color: #16a34a;
        }
        
        .coupon-status h3 {
            margin-bottom: 10px;
            color: #1a1a1a;
        }
        
        .coupon-status p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .coupon-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.9rem;
            background: #e3f2fd;
            color: #0d47a1;
            margin-bottom: 20px;
        }
        
        .coupon-badge.redeemed {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        #redeemCouponBtn {
            transition: all 0.3s ease;
            display: block;
            margin: 0 auto;
        }
        
        #redeemCouponBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .coupon-redeemed {
            text-align: center;
        }
        
        .coupon-redeemed h3 {
            margin-bottom: 10px;
            color: #1a1a1a;
        }
        
        .coupon-redeemed p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .redemption-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .redemption-info p {
            margin: 0;
            color: #555;
        }
        
        /* Coupon Redemption Modal */
        .redemption-modal .modal-content {
            max-width: 500px;
            padding: 30px;
            background: white;
            border-radius: 15px;
            text-align: center;
        }
        
        .redemption-modal .modal-icon {
            font-size: 60px;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .redemption-modal h2 {
            color: #1a1a1a;
            margin-bottom: 15px;
        }
        
        .redemption-modal p {
            color: #666;
            margin-bottom: 25px;
        }
        
        .redemption-modal .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .redemption-modal .confirm-btn {
            background: #16a34a;
        }
        
        .redemption-modal .confirm-btn:hover {
            background: #15803d;
        }

        /* Car models display styling */
        .car-models-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 5px 0;
        }
        
        .car-model-badge {
            background: rgba(0, 123, 255, 0.2);
            color: #fff;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .car-model-badge i {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* Address display styling */
        .address-display {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            color: #fff;
            line-height: 1.6;
            transition: all 0.3s ease;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .address-display address {
            font-style: normal;
            margin: 0;
        }
        
        .edit-info-btn {
            margin-top: 15px;
            background: transparent;
            border: 1px solid #007bff;
            color: #007bff;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-info-btn:hover {
            background: rgba(0, 123, 255, 0.1);
        }

        .form-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .address-fields {
            grid-column: 1 / -1;
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .address-fields #editStreet {
            grid-column: 1 / -1;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .icon-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .icon-btn i {
            margin-right: 6px;
        }

        #addressUpdateForm {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        /* … your existing styles … */
        .badge.upcoming {
            background: #ffca28;
            color: #1a1a1a;
            padding: 2px 6px;
            margin-left: 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            vertical-align: middle;
        }

        /* Add to existing dashboard styles */
        .status-indicators {
            display: flex;
            gap: 1.5rem;
            align-items: center;  /* Vertical centering */
            justify-content: center;  /* Horizontal centering */
            margin: 1rem 0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: #f8f9fa;
        }

        .status-icon {
            font-size: 1.2rem;
        }

        /* Ensure text alignment */
        .status-text {
            color: #333; /* Changed from white to dark grey */
            font-weight: 500;
            margin: 0;
        }

        /* If using status badges */
        .status-badge {
            color: #333 !important; /* Force text color */
            background-color: #f8f9fa;
        }

        .upcoming-events {
            position: relative;
            padding-right: 120px; /* Space for button */
        }

        .upcoming-events .btn-small {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .error-alert {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Add these styles */
        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 1.2rem;
        }

        .missing-info {
            color: #ff6b6b;
            font-style: italic;
        }

        #addressDisplay p {
            margin: 2px 0;
            line-height: 1.4;
        }

        .verified-info {
            color: #4CAF50;
            font-weight: 500;
        }

        .missing-info {
            color: #FF5252;
            background: rgba(255,82,82,0.1);
            padding: 8px 12px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .address-line {
            font-weight: 500;
            font-size: 1.1em;
        }

        .city-province {
            color: #666;
        }

        .postal-code {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
    </style>
    <!-- Add this in the head section -->
    <script>
    // Global Supabase initialization
    window.supabaseClient = supabase.createClient(
        'https://qhkcrrphsjpytdfqfamq.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoa2NycnBoc2pweXRkZnFmYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzMjQ4NzgsImV4cCI6MjA0OTkwMDg3OH0.S9JT_WmCWYMvSixRq1RrB1UlqXm6fix_riLFYCR3JOI'
    );
    </script>
</head>
<body class="dashboard-page">
    <!-- Standard Navigation -->
    <nav>
        <div class="logo">
            <a href="index.html">
                <img src="https://i.ibb.co/fkrdXZK/Logo4-white.png" alt="Blitz Tesla Club Logo" loading="lazy" width="50" height="50">
                <span>BLITZ T CLUB</span>
            </a>
        </div>
        <div class="menu-toggle" aria-label="Toggle navigation menu">
            <i class="fas fa-bars"></i>
        </div>
        <ul class="nav-links">
            <!-- Navigation items will be dynamically inserted by navigation.js -->
        </ul>
    </nav>

    <!-- Dashboard Content -->
    <main class="dashboard-container">
        <!-- Welcome Header -->
        <div class="dashboard-header">
            <div class="user-welcome">
                <h1>Welcome, <span id="userFullName"></span></h1>
                <div class="status-badge">
                    <span class="status-label">Membership Status:</span>
                    <span id="membershipStatus" data-status="pending"></span>
                    <span class="verification-status" id="verificationStatus"></span>
                </div>
            </div>
            <div class="quick-actions">
                <button class="btn primary-btn" id="membershipCardBtn">
                    <i class="fas fa-id-card"></i>
                    View Membership Card
                </button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Upcoming Events Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-calendar"></i> Upcoming Events</h2>
                    <a href="events.html" class="view-all">View All</a>
                </div>
                <div class="card-content" id="upcomingEventsList">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </div>
            </div>

            <!-- Member Stats Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-line"></i> Member Stats</h2>
                </div>
                <div class="card-content">
                    <div class="stat-grid">
                        <div class="stat-item">
                            <span class="stat-label">Member Since</span>
                            <span class="stat-value" id="memberSince">Loading...</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Member ID</span>
                            <span class="stat-value" id="memberId" style="font-family: monospace; font-weight: bold;"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Events Attended</span>
                            <span class="stat-value" id="eventsAttended">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coupon Redemption Card -->
            <div class="dashboard-card" id="couponCard">
                <div class="card-header">
                    <h2><i class="fas fa-ticket-alt"></i> Member Coupon</h2>
                </div>
                <div class="card-content">
                    <div class="coupon-container">
                        <div class="coupon-status" id="couponStatus">
                            <div class="coupon-icon">
                                <i class="fas fa-gift"></i>
                            </div>
                            <h3>Club Event Item Coupon</h3>
                            <p>As a valued member, you receive one coupon to redeem for an exclusive club event item.</p>
                            <div class="coupon-badge" id="couponBadge">Available</div>
                            <button class="btn primary-btn" id="redeemCouponBtn">
                                <i class="fas fa-ticket-alt"></i> Redeem Coupon
                            </button>
                        </div>
                        <div class="coupon-redeemed" id="couponRedeemed" style="display: none;">
                            <div class="coupon-icon redeemed">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3>Coupon Redeemed</h3>
                            <p>You've already redeemed your club event item coupon.</p>
                            <div class="coupon-badge redeemed">Redeemed</div>
                            <div class="redemption-info">
                                <p>Redeemed on: <span id="redemptionDate">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Links Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-link"></i> Quick Links</h2>
                </div>
                <div class="card-content">
                    <div class="quick-links-grid">
                        <a href="events.html" id="registerEvent" class="quick-link-item">
                            <i class="fas fa-calendar-plus"></i>
                            <span>Register for Event</span>
                        </a>
                        <a href="javascript:void(0)" id="viewInvoices" class="quick-link-item">
                            <i class="fas fa-file-invoice"></i>
                            <span>
                              View Invoices 
                              <small class="badge upcoming">Coming Soon</small>
                            </span>
                        </a>
                        <a href="#" class="quick-link-item" id="accountSettingsBtn">
                            <i class="fas fa-cog"></i>
                            <span>Account Settings</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Standard Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>BLITZ T CLUB</h3>
                <p>Empowering the future of sustainable transportation through innovation and community.</p>
            </div>
            
            <div class="footer-section">
                <h3>Quick Links</h3>
                <div class="footer-links">
                    <a href="index.html">Home</a>
                    <a href="events.html">Events</a>
                    <a href="gallery.html">Gallery</a>
                    <a href="contact.html">Contact</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Member Area</h3>
                <div class="footer-links">
                    <a href="sponsors.html">Our Sponsors</a>
                    <a href="#member-benefits">Member Benefits</a>
                    <a href="#" id="footerLogoutBtn">Logout</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Legal</h3>
                <div class="footer-links">
                    <a href="privacy.html">Privacy Policy</a>
                    <a href="terms.html">Terms of Service</a>
                    <a href="about.html">About Us</a>
                </div>
            </div>

            <div class="footer-section">
                <h3>Connect With Us</h3>
                <div class="footer-social">
                    <a href="https://x.com/BlitzTClub" target="_blank" aria-label="Follow us on X">
                        <i class="fa-brands fa-square-x-twitter"></i>
                    </a>
                    <a href="https://www.instagram.com/blitztclub/" target="_blank" aria-label="Follow us on Instagram">
                        <i class="fab fa-instagram"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <p>© 2024 Blitz T Club. All rights reserved.</p>
            <p class="powered-by">
                Website powered by <a href="http://www.summitpixels.com" target="_blank">SummitPixels</a>
            </p>
        </div>
    </footer>

    <!-- Keep your existing script -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Check for any pending account deletion requests
            const pendingDeletion = localStorage.getItem('pendingAccountDeletion');
            const deletionTime = localStorage.getItem('deletionRequestTime');
            
            if (pendingDeletion && navigator.onLine && window.location.protocol !== 'file:') {
                console.log('Found pending account deletion request from:', deletionTime);
                
                try {
                    // Check if we're on localhost or a deployed server
                    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                    const apiUrl = isLocalhost
                        ? 'http://localhost:3000/api/cleanup-orphaned-users'
                        : '/api/cleanup-orphaned-users';
                    
                    console.log('Processing pending deletion via API:', apiUrl);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: pendingDeletion
                        })
                    });
                    
                    if (response.ok) {
                        console.log('Successfully processed pending account deletion');
                        // Clear the pending deletion
                        localStorage.removeItem('pendingAccountDeletion');
                        localStorage.removeItem('deletionRequestTime');
                    } else {
                        console.warn('Could not process pending deletion - will try again later');
                    }
                } catch (error) {
                    console.error('Error processing pending deletion:', error);
                }
            }
            
            // Initialize navigation first - let the navigation.js handle all menu functionality
            console.log('Waiting for navigation.js to initialize...');
            
            // Check if user is logged in
            const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
            
            console.log('Session:', session);
            
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

                // Get user profile
                const { data: userData, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                .eq('email', session.user.email)
                    .single();

            console.log('Fetching profile for email:', session.user.email);
                console.log('Profile query result:', { profile: userData, profileError });

            let profile;

            if (profileError && profileError.code === 'PGRST116') {
                // Profile doesn't exist, create one
                console.log('No profile found, creating new profile...');
                
                // Generate sequential member ID
                const memberId = `BTC${String(userData.id).padStart(4, '0').slice(-4)}`;
                
                const { data: newProfile, error: createError } = await supabaseClient
                        .from('profiles')
                    .insert([
                        {
                            id: session.user.id,
                            email: session.user.email,
                            full_name: session.user.user_metadata?.full_name || session.user.email.split('@')[0],
                            username: session.user.email.split('@')[0],
                            membership_status: 'pending',
                            membership_type: 'standard',
                            member_id: memberId,
                            created_at: new Date().toISOString()
                        }
                    ])
                        .select()
                        .single();

                if (createError) {
                    console.error('Error creating profile:', createError);
                    throw createError;
                }

                console.log('New profile created:', newProfile);
                    profile = newProfile;
            } else if (profileError) {
                console.error('Error fetching profile:', profileError);
                throw profileError;
                } else {
                    profile = userData;
                }

            // Make profile available globally for other functions
            window.userProfile = profile;

            console.log('Using profile:', profile);

            // Update user info
            document.getElementById('userFullName').textContent = profile.full_name || 'Member';
            const statusElement = document.getElementById('membershipStatus');
            if (statusElement) {
                statusElement.textContent = profile.membership_status ? 
                    profile.membership_status.charAt(0).toUpperCase() + profile.membership_status.slice(1) : 
                    'Pending';
                statusElement.dataset.status = profile.membership_status || 'pending';
            }

            // Update member stats
            const memberSince = document.getElementById('memberSince');
            if (memberSince) {
                memberSince.textContent = profile.created_at ? 
                    new Date(profile.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'Not Available';
            }

            const memberId = document.getElementById('memberId');
            if (memberId) {
                // Check multiple sources for member ID in order of preference
                const storedMemberId = localStorage.getItem('userMemberId');
                const displayMemberId = profile.member_id || 
                                       session.user.user_metadata?.member_id || 
                                       storedMemberId || 
                                       'Not Available';
                
                console.log('Member ID sources:', {
                    profile: profile.member_id,
                    metadata: session.user.user_metadata?.member_id,
                    localStorage: storedMemberId
                });
                
                // Set the member ID on the profile if it's missing but available elsewhere
                if (!profile.member_id && (session.user.user_metadata?.member_id || storedMemberId)) {
                    const memberId = session.user.user_metadata?.member_id || storedMemberId;
                    console.log('Updating missing profile member_id with:', memberId);
                    
                    // Update the profile with the member ID
                    supabaseClient
                        .from('profiles')
                        .update({ 
                            member_id: memberId,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', session.user.id)
                        .then(response => {
                            if (response.error) {
                                console.error('Error updating profile with member ID:', response.error);
                            } else {
                                console.log('Profile updated with member ID:', memberId);
                            }
                        });
                }
                
                memberId.textContent = displayMemberId;
            }

            const eventsAttended = document.getElementById('eventsAttended');
            if (eventsAttended) {
                eventsAttended.textContent = profile.events_attended || '0';
            }

            // Function to update status display
            const updateStatusDisplay = async () => {
                try {
                    // Fetch latest profile data from Supabase using email only
                    const { data: latestProfile, error: profileError } = await supabaseClient
                        .from('profiles')
                    .select('*')
                        .eq('email', session.user.email)
                        .single();

                    if (profileError) {
                        console.error('Error fetching latest profile:', profileError);
                        return;
                    }

                    if (!latestProfile) {
                        console.warn('No profile data found');
                        return;
                    }

                    console.log('Latest profile data:', latestProfile);

                    const verificationStatus = document.getElementById('verificationStatus');
                    const statusElement = document.getElementById('membershipStatus');

                    if (!verificationStatus || !statusElement) {
                        console.warn('Status elements not found');
                        return;
                    }

                    // Use the latest profile data
                    if (latestProfile.membership_status === 'active') {
                        verificationStatus.innerHTML = `
                            <span class="badge success">
                                <i class="fas fa-check-circle"></i>
                                Email verified
                            </span>
                        `;
                        statusElement.textContent = 'Active';
                        statusElement.className = 'status-active';
                } else {
                        verificationStatus.innerHTML = `
                            <span class="badge warning">
                                <i class="fas fa-envelope"></i>
                                Please verify your email
                                <button id="resendVerification" class="resend-btn">
                                    <i class="fas fa-redo"></i> Resend Verification
                                </button>
                            </span>
                        `;
                        statusElement.textContent = 'Pending';
                        statusElement.className = 'status-pending';
                    }

                    // Update the global profile data
                    window.userProfile = latestProfile;
            } catch (error) {
                    console.error('Error updating status display:', error);
                }
            };

            // Initial status update
            await updateStatusDisplay();

            // Add periodic status check
            setInterval(updateStatusDisplay, 30000);

            // Handle logout - KEEP THIS OUTSIDE OF TRY/CATCH BLOCKS
            const logoutButtons = document.querySelectorAll('#logoutBtn, #footerLogoutBtn');
            logoutButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Call our direct logout function
                    window.performLogout();
                });
            });

            // Add this after profile data is loaded
            const membershipCardBtn = document.getElementById('membershipCardBtn');
            const modal = document.getElementById('membershipCardModal');
            const closeModalBtn = document.querySelector('.close-modal');

            membershipCardBtn.addEventListener('click', () => {
                // Format date for card display
                const formattedDate = profile.created_at ? 
                    new Date(profile.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'Not Available';

                // Get the member ID from all possible sources
                const storedMemberId = localStorage.getItem('userMemberId');
                const cardMemberId = profile.member_id || 
                                  session.user.user_metadata?.member_id || 
                                  storedMemberId || 
                                  'Not Available';
                
                console.log('Member ID for card display:', {
                    profileId: profile.member_id,
                    metadataId: session.user.user_metadata?.member_id,
                    localStorageId: storedMemberId,
                    using: cardMemberId
                });

                // Update card info
                document.getElementById('cardFullName').textContent = profile.full_name;
                document.getElementById('cardMemberId').textContent = cardMemberId;
                document.getElementById('cardMemberSince').textContent = formattedDate;
                document.getElementById('cardMembershipStatus').textContent = 
                    profile.membership_type.charAt(0).toUpperCase() + profile.membership_type.slice(1);

                // Set card style based on membership type
                const cardElement = document.querySelector('.membership-card');
                cardElement.dataset.type = profile.membership_type;

                // Generate QR code
                const qrData = JSON.stringify({
                    id: profile.id,
                    memberId: cardMemberId,
                    type: profile.membership_type,
                    name: profile.full_name,
                    since: formattedDate,
                    verified: true
                });
                
                const qrCanvas = document.getElementById('memberQRCode');
                // Clear previous QR code if any
                const context = qrCanvas.getContext('2d');
                context.clearRect(0, 0, qrCanvas.width, qrCanvas.height);
                
                QRCode.toCanvas(qrCanvas, qrData, {
                    width: 120,
                    margin: 0,
                    color: {
                        dark: '#171a20',
                        light: '#ffffff'
                    }
                });

                modal.classList.add('show');
            });

            // Close modal when clicking the X button
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                    modal.classList.remove('show');
                });
            }

            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });

            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('show')) {
                    modal.classList.remove('show');
                }
            });

            // Handle account settings
            const accountSettingsBtn = document.getElementById('accountSettingsBtn');
            const editProfileModal = document.getElementById('editProfileModal');
            const modalEditProfileForm = document.getElementById('modalEditProfileForm');
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');
            
            // Show modal when Account Settings link is clicked
            accountSettingsBtn.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Populate account information
                document.getElementById('modalUserEmail').textContent = profile.email;
                document.getElementById('modalMemberId').textContent = profile.member_id;
                document.getElementById('modalMemberSince').textContent = profile.created_at ? 
                    new Date(profile.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'Not Available';
                document.getElementById('modalMembershipStatus').textContent = 
                    profile.membership_status.charAt(0).toUpperCase() + profile.membership_status.slice(1);
                
                // Populate new fields
                // Phone number
                document.getElementById('modalPhoneNumber').textContent = profile.phone_number || 'Not provided';
                
                // Date of birth
                if (profile.date_of_birth) {
                    // Parse date in local timezone
                    const [year, month, day] = profile.date_of_birth.split('-');
                    const dobDate = new Date(year, month - 1, day);
                    
                    // Format with ordinal suffix
                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                    const dateString = dobDate.toLocaleDateString('en-US', options);
                    const dayWithSuffix = dateString.replace(/(\d+),/, (_, day) => {
                        return getOrdinalSuffix(day) + ',';
                    });
                    
                    document.getElementById('modalDateOfBirth').textContent = dayWithSuffix;
                } else {
                    document.getElementById('modalDateOfBirth').textContent = 'Not provided';
                }
                
                // Car models
                const carModelsContainer = document.getElementById('modalCarModels');
                carModelsContainer.innerHTML = '';
                
                if (profile.car_models && Array.isArray(profile.car_models) && profile.car_models.length > 0) {
                    profile.car_models.forEach(model => {
                        const badge = document.createElement('div');
                        badge.className = 'car-model-badge';
                        badge.innerHTML = `<i class="fas fa-car"></i> ${model}`;
                        carModelsContainer.appendChild(badge);
                    });
                } else {
                    carModelsContainer.innerHTML = '<p>No Tesla models provided</p>';
                }
                
                // Address
                const addressContainer = document.getElementById('modalAddress');
                
                if (profile.address) {
                    try {
                        const addr = profile.address;
                        addressContainer.innerHTML = `
                            <address>
                                ${addr.street}<br>
                                ${addr.city}, ${addr.province}<br>
                                ${addr.postal_code}<br>
                                Canada
                            </address>
                        `;
                    } catch(e) {
                        // Fallback for old format
                        addressContainer.innerHTML = profile.address;
                    }
                } else {
                    addressContainer.innerHTML = `
                        <p>No address provided</p>
                        <button type="button" class="edit-info-btn" id="editProfileInfoBtn">
                            <i class="fas fa-pencil-alt"></i> Add Information
                        </button>
                    `;
                }
                
                // Add handler for edit info button
                const editInfoBtn = document.getElementById('editProfileInfoBtn');
                if (editInfoBtn) {
                    editInfoBtn.addEventListener('click', () => {
                        // Close the current modal
                        editProfileModal.style.display = 'none';
                        // Redirect to profile completion page
                        window.location.href = 'profile-completion.html';
                    });
                }
                
                editProfileModal.style.display = 'block';
            });
            
            // Close modal when clicking the X - FIXED to use modal-specific close button
            const editProfileCloseBtn = editProfileModal.querySelector('.close-modal');
            if (editProfileCloseBtn) {
                editProfileCloseBtn.addEventListener('click', () => {
                    editProfileModal.style.display = 'none';
                });
            }
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === editProfileModal) {
                    editProfileModal.style.display = 'none';
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && editProfileModal.classList.contains('show')) {
                    editProfileModal.style.display = 'none';
                }
            });

            // Handle password update
            modalEditProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const currentPassword = document.getElementById('modalCurrentPassword').value;
                const newPassword = document.getElementById('modalNewPassword').value;
                const confirmPassword = document.getElementById('modalConfirmPassword').value;
                
                if (!currentPassword) {
                    alert('Please enter your current password');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }
                
                // Password validation
                if (newPassword.length < 8) {
                    alert('Password must be at least 8 characters long');
                    return;
                }
                
                const submitButton = modalEditProfileForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                submitButton.disabled = true;
                
                try {
                    // First verify the current password by signing in
                    const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({
                        email: window.userProfile.email,
                        password: currentPassword
                    });
                    
                    if (signInError) {
                        throw new Error('Current password is incorrect');
                    }
                    
                    // Update password using Supabase auth
                    const { error } = await supabaseClient.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (error) throw error;
                    
                    // Show success message
                    alert('Password updated successfully');
                    
                    // Reset form and close modal
                    modalEditProfileForm.reset();
                    editProfileModal.style.display = 'none';
                    
                    // Optionally force re-login
                    if (confirm('Your password has been updated successfully. For security reasons, would you like to log out and sign in with your new password?')) {
                        await supabaseClient.auth.signOut();
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('Error updating password:', error);
                    
                    // Show specific error message based on the error
                    if (error.message.includes('Password should be at least')) {
                        alert('Password must be at least 8 characters long');
                    } else if (error.message.includes('expired')) {
                        alert('Your session has expired. Please log in again to change your password.');
                        await supabaseClient.auth.signOut();
                        window.location.href = 'login.html';
                    } else if (error.message.includes('incorrect')) {
                        alert('Current password is incorrect');
                    } else {
                        alert('Failed to update password: ' + error.message);
                    }
                } finally {
                    // Restore button state
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                }
            });
            
            // Handle account deletion
            deleteAccountBtn.addEventListener('click', async () => {
                // Safety confirmation
                const confirmDelete = confirm("Are you sure you want to delete your account? This action cannot be undone.");
                if (!confirmDelete) return;
                
                // Get confirmation through text entry
                const deletePrompt = prompt("To confirm deletion, please type 'delete'");
                if (deletePrompt?.toLowerCase() !== 'delete') {
                    alert("Account deletion cancelled. Please type 'delete' to confirm.");
                    return;
                }
                
                try {
                    // Show loading state
                    deleteAccountBtn.disabled = true;
                    deleteAccountBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                    
                    // Get the current user and profile
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    if (!user) {
                        alert("You must be logged in to delete your account.");
                        deleteAccountBtn.disabled = false;
                        deleteAccountBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete Account';
                        return;
                    }
                    
                    console.log(`Deleting account for user: ${user.id}`);
                    
                    // Step 1: Delete profile data first (this part works)
                    const { error: profileError } = await supabaseClient
                    .from('profiles')
                        .delete()
                        .eq('id', user.id);

                if (profileError) {
                        console.error("Error deleting profile:", profileError);
                        throw new Error(`Failed to delete profile data: ${profileError.message}`);
                    }
                    
                console.log("Profile data deleted successfully");
                
                    // Step 2: Delete any related data (with better error handling)
                    try {
                        const { error: regError } = await supabaseClient
                            .from('event_registrations')
                            .delete()
                            .eq('user_id', user.id);
                            
                        if (regError && !regError.message?.includes('not found')) {
                            console.warn("Error deleting event registrations:", regError);
                        } else {
                            console.log("Event registrations deleted or none found");
                        }
                    } catch (err) {
                        console.log("Event registrations table may not exist:", err.message);
                    }
                    
                    // Step 3: Tell the user what happened - be honest about limitations
                    alert(
                        "Your profile data has been deleted, but your account will remain in our authentication system. " +
                        "You will be signed out now. If you need complete removal from our systems, please contact our support team."
                    );
                    
                    // Step 4: Sign out the user
                    await supabaseClient.auth.signOut();
                    
                    // Step 5: Clear storage
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    // Redirect to homepage
                    window.location.href = 'index.html';
                    
                } catch (error) {
                    console.error("Error during account deletion:", error);
                    
                    // Reset button state
                    deleteAccountBtn.disabled = false;
                    deleteAccountBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete Account';
                    
                    // Show error
                    alert(`There was an error deleting your account: ${error.message}`);
                }
            });
            
            // Password visibility toggle
            document.querySelectorAll('.toggle-password').forEach(button => {
                button.addEventListener('click', function() {
                    const input = this.previousElementSibling;
                    const icon = this.querySelector('i');
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                } else {
                        input.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            });

            // Password strength meter
            const passwordInput = document.getElementById('modalNewPassword');
            const strengthMeter = document.querySelector('.password-strength-meter');
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');

            passwordInput.addEventListener('input', function() {
                const password = this.value;
                
                // Show strength meter only if password has some value
                if (password.length > 0) {
                    strengthMeter.style.display = 'block';
                } else {
                    strengthMeter.style.display = 'none';
                    return;
                }
                
                // Calculate password strength
                let strength = 0;
                
                // Basic requirements
                if (password.length >= 8) strength += 1; // Length
                if (/[A-Z]/.test(password)) strength += 1; // Uppercase
                if (/[a-z]/.test(password)) strength += 1; // Lowercase
                if (/[0-9]/.test(password)) strength += 1; // Numbers
                if (/[^A-Za-z0-9]/.test(password)) strength += 1; // Special chars
                
                // Update strength indicator
                strengthBar.className = 'strength-bar';
                
                if (strength < 3) {
                    strengthBar.classList.add('strength-weak');
                    strengthText.textContent = 'Weak';
                    strengthText.style.color = '#dc3545';
                } else if (strength < 5) {
                    strengthBar.classList.add('strength-medium');
                    strengthText.textContent = 'Medium';
                    strengthText.style.color = '#ffc107';
                } else {
                    strengthBar.classList.add('strength-strong');
                    strengthText.textContent = 'Strong';
                    strengthText.style.color = '#28a745';
                }
            });

            // Check if coming from verification success
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('verified') === 'true') {
                await updateStatusDisplay();
                // Clear the URL parameters
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            if (profile.membership_status === 'pending') {
                verificationStatus.innerHTML = `
                    <span class="badge warning">
                        <i class="fas fa-envelope"></i>
                        Please verify your email
                        <button id="resendVerification" class="resend-btn">
                            <i class="fas fa-redo"></i> Resend Verification
                        </button>
                    </span>
                `;

                // Add click handler for resend button
                const resendBtn = document.getElementById('resendVerification');
                resendBtn.addEventListener('click', async () => {
                    try {
                        // Generate verification token
                        const verificationToken = crypto.randomUUID();
                        console.log('Generated token:', verificationToken);

                        // Store token temporarily in localStorage
                        localStorage.setItem('verificationToken', verificationToken);
                        localStorage.setItem('tokenExpiry', new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString());

                        // Get base URL for verification link
                        const baseUrl = window.location.href.split('/').slice(0, -1).join('/');
                        const verificationUrl = `${baseUrl}/verify-email.html?token=${verificationToken}`;

                        // Send verification email using FormSubmit
                        const formData = new FormData();
                        formData.append('email', profile.email);
                        formData.append('_captcha', 'false');
                        formData.append('_template', 'box');
                        formData.append('_subject', 'Verify Your Blitz T Club Membership');
                        formData.append('_autoresponse', 'Thank you for verifying your email. Your Blitz T Club membership will be activated shortly.');
                        formData.append('message', `Welcome to Blitz T Club!

Member ID: ${profile.member_id}

Please click the link below to verify your email and activate your membership:
${verificationUrl}

Important Notes:
- This verification link will expire in 24 hours
- Please verify on the same device you're currently using
- After verification, your membership will be activated instantly

Next Steps:
1. Click the verification link above
2. Your membership will be activated instantly
3. Access your digital membership card
4. Start enjoying member benefits

If you can't click the link, copy and paste this URL into your browser:
${verificationUrl}

If you didn't request this email, please ignore it.

Best regards,
Blitz T Club Team`);

                        // Send the verification email
                        const emailResponse = await fetch(`https://formsubmit.co/ajax/${profile.email}`, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json'
                            },
                            body: formData
                        });

                        if (!emailResponse.ok) {
                            const responseText = await emailResponse.text();
                            console.error('FormSubmit response:', responseText);
                            throw new Error('Failed to send verification email');
                        }

                        // Store verification data in localStorage
                        localStorage.setItem('pendingVerificationEmail', profile.email);
                        localStorage.setItem('pendingMemberId', profile.member_id);
                        localStorage.setItem('registrationTime', new Date().toISOString());

                        // Redirect to verification sent page
                        window.location.href = 'verification-sent.html';

                    } catch (error) {
                        console.error('Error sending verification:', error);
                        alert('Failed to send verification email. Please try again.');
                    }
                });
            }

            // Initialize coupon status if needed
            async function initializeCouponStatus() {
                try {
                    // Only proceed if all required DOM elements are found
                    if (!couponStatus || !couponRedeemed || !redeemCouponBtn || !redemptionDate || 
                        !redemptionModal || !cancelRedemptionBtn || !confirmRedemptionBtn) {
                        console.warn('Some coupon elements not found, skipping coupon initialization');
                        return;
                    }

                    // Check if coupon_redeemed exists in profile data
                    if (profile.coupon_redeemed === undefined) {
                        console.log('Coupon feature not fully set up in the database');
                        
                        // Try to update the profile with the field if it's missing
                        try {
                            // Initialize coupon_redeemed field to false (for existing users)
                            const { error: updateError } = await supabaseClient
                                .from('profiles')
                                .update({ coupon_redeemed: false })
                                .eq('id', session.user.id);
                            
                            if (updateError) {
                                if (updateError.message && updateError.message.includes('column "coupon_redeemed" does not exist')) {
                                    console.error('Coupon column does not exist in the database:', updateError);
                                    throw new Error('Database schema needs to be updated for coupon feature');
                                } else {
                                    console.error('Error updating coupon status:', updateError);
                                }
                            } else {
                                // Update was successful, so update local profile data
                                profile.coupon_redeemed = false;
                                console.log('Successfully initialized coupon_redeemed field');
                            }
                        } catch (error) {
                            console.error('Error initializing coupon status:', error);
                            // For admin users, show an alert about the missing column
                            if (profile.email && (profile.email.includes('admin') || profile.email === 'linkevin046@gmail.com')) {
                                alert('Admin notice: The coupon_redeemed column is missing in the profiles table. Please run the SQL to add it.');
                            }
                        }
                    }
                    
                    updateCouponDisplay();
                } catch (error) {
                    console.error('Error initializing coupon status:', error);
                }
            }

            // Handle coupon redemption functionality - WRAP IN TRY/CATCH
            try {
                const couponStatus = document.getElementById('couponStatus');
                const couponRedeemed = document.getElementById('couponRedeemed');
                const couponBadge = document.getElementById('couponBadge');
                const redeemCouponBtn = document.getElementById('redeemCouponBtn');
                const redemptionDate = document.getElementById('redemptionDate');
                const redemptionModal = document.getElementById('redemptionModal');
                const cancelRedemptionBtn = document.getElementById('cancelRedemptionBtn');
                const confirmRedemptionBtn = document.getElementById('confirmRedemptionBtn');
                
                // Update coupon display based on redemption status
                function updateCouponDisplay() {
                    if (profile.coupon_redeemed) {
                        couponStatus.style.display = 'none';
                        couponRedeemed.style.display = 'block';
                        
                        // Display redemption date if available
                        if (profile.coupon_redeemed_at) {
                            const formattedDate = new Date(profile.coupon_redeemed_at).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                            redemptionDate.textContent = formattedDate;
                        } else {
                            redemptionDate.textContent = 'Not available';
                        }
                    } else {
                        couponStatus.style.display = 'block';
                        couponRedeemed.style.display = 'none';
                    }
                }
                
                // Initialize coupon status
                if (couponStatus && couponRedeemed && redeemCouponBtn) {
                    await initializeCouponStatus();
                    
                    // Handle redeem button click
                    redeemCouponBtn.addEventListener('click', () => {
                        // Show redemption confirmation modal
                        redemptionModal.classList.add('show');
                    });
                    
                    // Close modal when clicking the cancel button
                    cancelRedemptionBtn.addEventListener('click', () => {
                        redemptionModal.classList.remove('show');
                    });
                    
                    // Close modal when clicking the X button
                    redemptionModal.querySelector('.close-modal').addEventListener('click', () => {
                        redemptionModal.classList.remove('show');
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                        if (e.target === redemptionModal) {
                            redemptionModal.classList.remove('show');
                        }
                    });
                    
                    // Handle redemption confirmation
                    confirmRedemptionBtn.addEventListener('click', async () => {
                        try {
                            // Disable button to prevent multiple clicks
                            confirmRedemptionBtn.disabled = true;
                            confirmRedemptionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                            
                            // Get latest profile info to ensure we have accurate data
                            const { data: latestProfile, error: profileError } = await supabaseClient
                                .from('profiles')
                                .select('*')
                                .eq('id', session.user.id)
                                .single();
                            
                            if (profileError) {
                                throw new Error('Failed to fetch profile data: ' + profileError.message);
                            }
                            
                            // Check if coupon_redeemed exists in the profile, if not it means the column hasn't been added
                            if (latestProfile.coupon_redeemed === undefined) {
                                throw new Error('Coupon feature is not available. Please contact the administrator.');
                            }
                            
                            // Double-check if coupon has already been redeemed
                            if (latestProfile.coupon_redeemed === true) {
                                alert('Your coupon has already been redeemed.');
                                redemptionModal.classList.remove('show');
                    return;
                }
                
                            // Update profile to mark coupon as redeemed
                            const redemptionTimestamp = new Date().toISOString();
                            const { error: updateError } = await supabaseClient
                                .from('profiles')
                                .update({ 
                                    coupon_redeemed: true,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', session.user.id);  // Use id instead of uid
                            
                            if (updateError) {
                                // If the update fails because the column doesn't exist, provide a meaningful error
                                if (updateError.message && updateError.message.includes('column "coupon_redeemed" does not exist')) {
                                    throw new Error('Coupon feature is not fully set up. The database needs to be updated.');
                        } else {
                                    throw new Error('Failed to update redemption status: ' + updateError.message);
                                }
                            }
                            
                            // Update local profile data
                            profile.coupon_redeemed = true;
                            profile.coupon_redeemed_at = redemptionTimestamp;
                            
                            // Update display
                            updateCouponDisplay();
                            
                            // Close modal
                            redemptionModal.classList.remove('show');
                            
                            // Show success message
                            alert('Coupon redeemed successfully! You can collect your club event item at the next event.');
                            
                } catch (error) {
                            console.error('Error redeeming coupon:', error);
                            alert('Error redeeming coupon: ' + error.message);
                        } finally {
                            // Reset button state
                            confirmRedemptionBtn.disabled = false;
                            confirmRedemptionBtn.innerHTML = '<i class="fas fa-check"></i> Confirm Redemption';
                        }
                    });
                }
            } catch (error) {
                console.error('Error initializing coupon redemption functionality:', error);
                // This ensures that even if the coupon feature fails, it doesn't break other features
            }

            // Remove duplicate session declaration and use existing session
            if (session?.user) {
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select(`
                        id,
                        phone,
                        street,
                        city,
                        province,
                        postal_code,
                        updated_at
                    `)
                    .eq('id', session.user.id)
                    .single();

                const requiredFields = ['first_name', 'last_name', 'phone', 'street', 'city', 'province', 'postal_code'];
                const isComplete = requiredFields.every(field => profile?.[field]?.trim() !== '');

                if (!isComplete) {
                    sessionStorage.setItem('returnPath', window.location.pathname);
                    window.location.href = '/update-profile.html?mandatory=true';
                    window.history.replaceState(null, null, window.location.href);
                }
            }
        });
    </script>

    <!-- Membership Card Modal -->
    <div id="membershipCardModal" class="modal">
        <div class="modal-content membership-card">
            <button class="close-modal">&times;</button>
                <div class="card-header">
                    <div class="header-text">
                    <h2>Blitz T Club</h2>
                    </div>
                <img src="https://i.ibb.co/fkrdXZK/Logo4-white.png" alt="Blitz Tesla Club Logo">
                    </div>
                    <div class="member-info">
                        <h3 id="cardFullName"></h3>
                        <div class="info-row">
                    <span class="label">Member ID</span>
                            <span id="cardMemberId"></span>
                        </div>
                        <div class="info-row">
                    <span class="label">Member Since</span>
                            <span id="cardMemberSince"></span>
                        </div>
                        <div class="info-row">
                    <span class="label">Status</span>
                            <span id="cardMembershipStatus"></span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="qr-section">
                            <canvas class="qr-code" id="memberQRCode"></canvas>
                            <div class="qr-text">
                                <i class="fas fa-qrcode"></i>
                                <small>Scan to verify membership</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Settings Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content settings-modal">
            <div class="modal-header">
                <h2><i class="fas fa-user-cog"></i> Account Settings</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Account Info Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-info-circle"></i> Account Information</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Email</span>
                            <span class="info-value" id="modalUserEmail"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Member ID</span>
                            <span class="info-value" id="modalMemberId"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Member Since</span>
                            <span class="info-value" id="modalMemberSince"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Membership Status</span>
                            <span class="info-value" id="modalMembershipStatus"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Phone Number</span>
                            <span class="info-value" id="modalPhoneNumber"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Date of Birth</span>
                            <span class="info-value" id="modalDateOfBirth"></span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-car"></i> Your Tesla Models</h3>
                    <div class="car-models-list" id="modalCarModels">
                        <!-- Car models will be inserted here dynamically -->
                    </div>
                </div>
                
                <!-- Address Display Section -->
                <div class="settings-section">
                    <div class="section-header">
                        <h3><i class="fas fa-home"></i> Home Address</h3>
                        <button class="btn icon-btn" id="editAddressBtn">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    
                    <div class="address-content">
                        <div class="address-display" id="modalAddress">
                            <!-- Dynamic content will load here -->
                        </div>
                        
                        <form id="addressUpdateForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="editStreet">Street Address</label>
                                    <input type="text" id="editStreet" name="street" required
                                           class="modern-input" placeholder="123 Main St">
                                </div>
                                
                                <div class="form-group">
                                    <label for="editCity">City</label>
                                    <input type="text" id="editCity" name="city" required
                                           class="modern-input" placeholder="Toronto">
                                </div>

                                <div class="form-group">
                                    <label for="editProvince">Province</label>
                                    <select id="editProvince" name="province" required class="modern-input">
                                        <option value="">Select Province</option>
                                        <option value="ON">Ontario</option>
                                        <option value="BC">British Columbia</option>
                                        <!-- Add other provinces -->
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="editPostalCode">Postal Code</label>
                                    <input type="text" id="editPostalCode" name="postal_code" required
                                           class="modern-input" placeholder="A1A 1A1" 
                                           pattern="[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Password Change Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-key"></i> Change Password</h3>
                    <form id="modalEditProfileForm">
                        <!-- Add hidden username field for accessibility -->
                        <input type="hidden" id="modalUsername" name="username" autocomplete="username">
                <div class="form-group">
                            <label for="modalCurrentPassword">Current Password</label>
                    <div class="password-input-container">
                                <input type="password" id="modalCurrentPassword" name="currentPassword" 
                                    placeholder="Enter current password" autocomplete="current-password"
                                    class="modern-input">
                        <button type="button" class="toggle-password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                            <label for="modalNewPassword">New Password</label>
                    <div class="password-input-container">
                                <input type="password" id="modalNewPassword" name="newPassword" 
                                    placeholder="Enter new password" autocomplete="new-password"
                                    class="modern-input">
                                <button type="button" class="toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="password-strength-meter" style="display: none;">
                                <div class="strength-label">Password strength: <span id="strengthText">Weak</span></div>
                                <div class="strength-bar-container">
                                    <div class="strength-bar" id="strengthBar"></div>
                                </div>
                                <small id="passwordRequirements">Use at least 8 characters, including uppercase, lowercase letters, and numbers</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="modalConfirmPassword">Confirm Password</label>
                            <div class="password-input-container">
                                <input type="password" id="modalConfirmPassword" name="confirmPassword" 
                                    placeholder="Confirm new password" autocomplete="new-password"
                                    class="modern-input">
                        <button type="button" class="toggle-password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="button-group">
                            <button type="submit" class="btn primary-btn">
                                <i class="fas fa-save"></i> Update Password
                    </button>
                </div>
            </form>
                </div>

                <!-- Danger Zone Section -->
                <div class="settings-section danger-zone">
                    <h3><i class="fas fa-exclamation-triangle"></i> Danger Zone</h3>
                    <p class="danger-text">Once you delete your account, there is no going back. Please be certain.</p>
                    <button type="button" class="btn danger-btn" id="deleteAccountBtn">
                        <i class="fas fa-trash-alt"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add event listener to ensure consistent menu initialization -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Ensuring mobile menu consistency across pages');
            
            // Force consistent class names to match index.html
            document.body.classList.remove('nav-open');
            
            const navLinks = document.querySelector('.nav-links');
            if (navLinks) {
                navLinks.classList.remove('active');
            }
            
            // Re-initialize navigation if available
            if (typeof window.initializeNavigation === 'function') {
                setTimeout(function() {
                    window.initializeNavigation();
                }, 100);
            }
        });
    </script>
    
    <!-- Coupon Redemption Modal -->
    <div id="redemptionModal" class="modal redemption-modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <div class="modal-icon">
                <i class="fas fa-ticket-alt"></i>
            </div>
            <h2>Redeem Your Club Event Item Coupon</h2>
            <p>Are you sure you want to redeem your coupon for an exclusive club event item? This action cannot be undone.</p>
            <div class="redemption-details">
                <p>You'll be able to collect your item at the next club event.</p>
                <p>Please show your membership card at the event to claim your item.</p>
            </div>
            <div class="button-group">
                <button class="btn primary-btn" id="cancelRedemptionBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn primary-btn confirm-btn" id="confirmRedemptionBtn">
                    <i class="fas fa-check"></i> Confirm Redemption
                </button>
            </div>
        </div>
    </div>

    <!-- Add this after the password change handler -->
    <script>
        // Wrap event listener in null check
        const profileForm = document.getElementById('profileUpdateForm');
        if (profileForm) {
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Get current session
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    alert('Session expired - please login again');
                    window.location.href = 'login.html';
                    return;
                }

                const formData = {
                    first_name: document.getElementById('editFirstName').value.trim(),
                    last_name: document.getElementById('editLastName').value.trim(),
                    phone: document.getElementById('editPhone').value.trim(),
                    street: document.getElementById('editStreet').value.trim(),
                    city: document.getElementById('editCity').value.trim(),
                    province: document.getElementById('editProvince').value,
                    postal_code: document.getElementById('editPostalCode').value.toUpperCase().trim()
                };

                // Basic validation
                if (!formData.first_name || !formData.last_name) {
                    alert('Please enter both first and last name');
                    return;
                }

                if (!/^\d{10}$/.test(formData.phone)) {
                    alert('Please enter a valid 10-digit phone number');
                    return;
                }

                if (!/^[A-Z]\d[A-Z] \d[A-Z]\d$/.test(formData.postal_code)) {
                    alert('Please enter a valid postal code (A1A 1A1 format)');
                    return;
                }

                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    const { error } = await supabaseClient
                        .from('profiles')
                        .update({
                            street: formData.street,
                            city: formData.city,
                            province: formData.province,
                            postal_code: formData.postal_code,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', user.id);

                    if (error) throw error;

                    // Update local profile data
                    Object.assign(window.userProfile, formData);
                    
                    // Check if all mandatory fields are now complete
                    const requiredFields = ['first_name', 'last_name', 'phone', 'street', 'city', 'province', 'postal_code'];
                    const isComplete = requiredFields.every(field => formData[field]?.trim() !== '');
                    
                    if (isComplete) {
                        // Remove mandatory update requirement
                        sessionStorage.removeItem('returnPath');
                        window.history.replaceState(null, null, window.location.pathname);
                    }

                    alert('Profile updated successfully!');
                    // Refresh displayed data
                    updateProfileDisplay();
                } catch (error) {
                    console.error('Profile update error:', error);
                    alert('Error updating profile: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                }
            });
        }

        // Add this function to update displayed profile info
        function updateProfileDisplay() {
            const profile = window.userProfile || {};
            
            // Phone Number Display
            const phoneDisplay = document.getElementById('modalPhoneNumber');
            phoneDisplay.innerHTML = profile.phone !== 'Not provided' 
                ? `<span class="verified-info">${profile.phone}</span>`
                : `<span class="missing-info">Not provided</span>`;

            // Address Display
            const addressContainer = document.getElementById('modalAddress');
            if (validateAddress(profile)) {
                addressContainer.innerHTML = `
                    <div class="address-display">
                        ${profile.street ? `<p class="address-line">${profile.street}</p>` : ''}
                        ${profile.city || profile.province ? `
                            <p class="city-province">
                                ${[profile.city, profile.province].filter(Boolean).join(', ')}
                            </p>` : ''}
                        ${profile.postal_code ? `<p class="postal-code">${profile.postal_code}</p>` : ''}
                    </div>
                `;
            } else {
                addressContainer.innerHTML = `
                    <div class="missing-info">
                        <i class="fas fa-exclamation-triangle"></i>
                        Please complete your address information
                    </div>
                `;
            }
        }
    </script>

    <!-- Address editing functionality -->
    <script>
        // Safe event listener initialization
        function initAddressEditing() {
            const editAddressBtn = document.getElementById('editAddressBtn');
            
            if (editAddressBtn) {
                editAddressBtn.addEventListener('click', () => {
                    // Show the form and hide the display
                    document.getElementById('addressUpdateForm').style.display = 'block';
                    document.getElementById('modalAddress').style.display = 'none';
                    
                    const profile = window.userProfile;
                    const address = profile.address || {};
                    
                    // Populate form fields
                    document.getElementById('editStreet').value = window.userProfile?.street || '';
                    document.getElementById('editCity').value = window.userProfile?.city || '';
                    document.getElementById('editProvince').value = window.userProfile?.province || '';
                    document.getElementById('editPostalCode').value = window.userProfile?.postal_code || '';
                });
            } else {
                console.error('CRITICAL: Edit address button missing from DOM');
                // Create button dynamically as fallback
                const newBtn = document.createElement('button');
                newBtn.id = 'editAddressBtn';
                newBtn.className = 'btn icon-btn';
                newBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
                newBtn.onclick = () => {
                    document.getElementById('addressUpdateForm').style.display = 'block';
                    document.getElementById('modalAddress').style.display = 'none';
                };
                document.querySelector('.section-header').appendChild(newBtn);
            }
        }

        // Initialize cancel button
        function initCancelButton() {
            const cancelEditBtn = document.getElementById('cancelEditAddress');
            
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('addressUpdateForm').style.display = 'none';
                    document.getElementById('modalAddress').style.display = 'block';
                });
            }
        }

        // Initialize form submission
        function initAddressFormSubmission() {
            const addressForm = document.getElementById('addressUpdateForm');
            
            if (addressForm) {
                addressForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    try {
                        const { data: { user } } = await supabaseClient.auth.getUser();
                        if (!user) throw new Error('User not authenticated');

                        const formData = {
                            address: {
                                street: document.getElementById('editStreet').value.trim(),
                                city: document.getElementById('editCity').value.trim(),
                                province: document.getElementById('editProvince').value,
                                postal_code: document.getElementById('editPostalCode').value
                                    .toUpperCase()
                                    .replace(/\s/g, '')
                                    .replace(/([A-Z]\d[A-Z])(\d[A-Z]\d)/, '$1 $2')
                            }
                        };

                        // Validation checks
                        if (!formData.address.street || !formData.address.city || 
                            !formData.address.province || !formData.address.postal_code) {
                            alert('Please fill all address fields');
                            return;
                        }

                        const { error } = await supabaseClient
                            .from('profiles')
                            .update({ address: formData.address })
                            .eq('id', user.id);

                        if (error) throw error;

                        // Update local profile and refresh display
                        window.userProfile.address = formData.address;
                        updateProfileDisplay();
                        
                        // Show success and hide form
                        alert('Address updated successfully!');
                        document.getElementById('addressUpdateForm').style.display = 'none';
                        document.getElementById('modalAddress').style.display = 'block';

                    } catch (error) {
                        console.error('Address update failed:', error);
                        alert('Error saving address: ' + error.message);
                    }
                });
            }
        }

        // Initialize all address components when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // First try
            initAddressEditing();
            initCancelButton();
            initAddressFormSubmission();
            
            // Periodic check for 5 seconds
            const interval = setInterval(() => {
                if(document.getElementById('editAddressBtn')) {
                    initAddressEditing();
                    clearInterval(interval);
                }
            }, 200);
            
            setTimeout(() => clearInterval(interval), 5000);
        });
     </script>

    <!-- Move this script block BEFORE any code that uses getOrdinalSuffix -->
    <script>
        // Add the getOrdinalSuffix function here
        function getOrdinalSuffix(day) {
            const dayNum = parseInt(day);
            if (dayNum > 3 && dayNum < 21) return day + 'th';
            switch (dayNum % 10) {
                case 1: return day + 'st';
                case 2: return day + 'nd';
                case 3: return day + 'rd';
                default: return day + 'th';
            }
        }

        function updateProfileDisplay() {
            // ... existing code ...
        }
    </script>

    <!-- Replace the existing address-related scripts with this -->
    <script>
        // Replace the existing address-related scripts with this
        function initAddressComponents() {
            // Create button if missing
            if (!document.getElementById('editAddressBtn')) {
                const btnHTML = `
                    <button class="btn icon-btn" id="editAddressBtn">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                `;
                const header = document.querySelector('.settings-section .section-header');
                if (header) header.insertAdjacentHTML('beforeend', btnHTML);
            }

            // Initialize event listeners
            const initAddressEditing = () => {
                // Required elements
                const elements = {
                    btn: document.getElementById('editAddressBtn'),
                    form: document.getElementById('addressUpdateForm'),
                    display: document.getElementById('modalAddress'),
                    street: document.getElementById('editStreet'),
                    city: document.getElementById('editCity'),
                    province: document.getElementById('editProvince'),
                    postalCode: document.getElementById('editPostalCode')
                };

                // Validate all elements exist
                if (Object.values(elements).some(el => !el)) {
                    console.error('Missing address elements:', 
                        Object.entries(elements)
                            .filter(([_, el]) => !el)
                            .map(([name]) => name)
                    );
                    return;
                }

                // Initialize only once
                if (!elements.btn._initialized) {
                    elements.btn._initialized = true;
                    
                    elements.btn.addEventListener('click', () => {
                        // Toggle visibility
                        elements.form.style.display = 'block';
                        elements.display.style.display = 'none';
                        
                        // Populate form fields
                        elements.street.value = window.userProfile?.street || '';
                        elements.city.value = window.userProfile?.city || '';
                        elements.province.value = window.userProfile?.province || '';
                        elements.postalCode.value = window.userProfile?.postal_code || '';
                    });
                }
            };

            // Initialize with retries
            const initWithRetry = (attempt = 0) => {
                if (attempt > 5) return;
                initAddressEditing();
                if (!document.getElementById('editAddressBtn')) {
                    setTimeout(() => initWithRetry(attempt + 1), 300);
                }
            };

            initWithRetry();
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initAddressComponents);
    </script>

    <!-- Add this at the BOTTOM of the file before closing body tag -->
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Initialize Supabase first
        if (!window.supabaseClient) {
            window.supabaseClient = supabase.createClient(
                'https://qhkcrrphsjpytdfqfamq.supabase.co',
                'your-anon-key',
                {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true
                    }
                }
            );
        }

        // Then initialize dashboard
        initializeDashboard();
    });
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const invoicesLink = document.getElementById('viewInvoices');
        if (invoicesLink) {
          invoicesLink.addEventListener('click', e => {
            e.preventDefault();
            alert('The "View Invoices" feature is coming soon!');
          });
        }
      });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) return;

        // Fetch event registrations
        const { data: registrations } = await supabaseClient
            .from('event_registrations')
            .select('event_id, events(status)')
            .eq('user_id', user.data.user.id);

        // Count attended events (status = 'completed')
        const attended = registrations.filter(r => r.events?.status === 'completed').length;
        safeTextUpdate('eventsAttended', attended);

        // Count upcoming events (status = 'upcoming')
        const upcoming = registrations.filter(r => r.events?.status === 'upcoming').length;
        safeTextUpdate('upcomingEvents', upcoming);
    });
    </script>

    <script>
    async function initializeDashboard() {
        try {
            // ... existing auth checks ...

            // Initialize UI components in order
            initializeProfileSection();
            await loadUserEvents();
            updateEventStats();

        } catch (error) {
            handleDashboardError(error);
        }
    }
    </script>

    <script>
    async function generateSequentialMemberId() {
        const { count } = await window.supabaseClient
            .from('profiles')
            .select('*', { count: 'exact', head: true });
        
        return `BTC${String(count + 1).padStart(5, '0')}`; // Removed dash and fixed to 5 digits
    }
    </script>

    <!-- Replace email-based queries with UUID-based -->
    <script>
    document.querySelectorAll('[data-profile]').forEach(element => {
        supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', window.user.id)  // Use UUID instead of email
            .single()
            .then(({ data }) => {
                element.textContent = data?.full_name || 'Member';
            });
    });
    </script>

    <script>
    function handleDashboardError(error) {
        console.error('Dashboard Error:', error);
        const errorContainer = document.getElementById('errorNotification');
        if (errorContainer) {
            errorContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${error.message || 'An unexpected error occurred'}
                </div>`;
            errorContainer.style.display = 'block';
            setTimeout(() => errorContainer.style.display = 'none', 5000);
        }
        if (error.message.includes('401')) window.location.href = 'login.html';
    }
    </script>

    <!-- Wrap all textContent updates in null checks -->
    <script>
    function safeTextUpdate(elementId, text) {
        const el = document.getElementById(elementId);
        if (el) {
            el.textContent = text || ''; // Handle undefined/null
            el.style.visibility = text ? 'visible' : 'hidden';
        }
    }
    </script>

    <script>
    function initializeProfileSection() {
        const elements = {
            profileName: document.getElementById('profileName'),
            userFullName: document.getElementById('userFullName'),
            memberId: document.getElementById('memberId'),
            membershipStatus: document.getElementById('membershipStatus'),
            memberSince: document.getElementById('memberSince'),
            phoneNumber: document.getElementById('profilePhone'),
            streetAddress: document.getElementById('profileStreet'),
            cityProvince: document.getElementById('profileCityProvince'),
            postalCode: document.getElementById('profilePostalCode')
        };

        if (!window.userProfile) return;

        // Update text content safely
        safeTextUpdate('profileName', window.userProfile.full_name || 'Member');
        safeTextUpdate('userFullName', window.userProfile.full_name || '');
        safeTextUpdate('memberId', window.userProfile.member_id || '');
        safeTextUpdate('profilePhone', window.userProfile.phone || 'Not provided');
        safeTextUpdate('profileStreet', window.userProfile.street || 'Not provided');
        
        // Combine city and province
        const cityProvince = [window.userProfile.city, window.userProfile.province]
            .filter(Boolean).join(', ');
        safeTextUpdate('profileCityProvince', cityProvince || 'Not provided');
        
        safeTextUpdate('profilePostalCode', window.userProfile.postal_code || 'Not provided');
    }
    </script>

    <script>
    async function loadUserEvents() {
        try {
            if (!window.userProfile?.id) {
                await new Promise(resolve => setTimeout(resolve, 500));
                if (!window.userProfile?.id) {
                    throw new Error('User profile initialization delayed');
                }
            }
            const eventsContainer = document.getElementById('upcomingEventsList');
            if (eventsContainer) {
                eventsContainer.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>';
            }

            if (!window.userProfile?.id) {
                throw new Error('User profile not initialized');
            }

            const { data: events, error } = await window.supabaseClient
                .from('user_events')
                .select('*')
                .eq('user_id', window.userProfile.id);

            if (error) throw error;
            
            if (eventsContainer) {
                eventsContainer.innerHTML = events.length > 0 
                    ? events.map(event => `
                        <div class="event-item">
                            <i class="fas fa-calendar-day"></i>
                            <div class="event-details">
                                <h3>${event.name}</h3>
                                <p>${new Date(event.date).toLocaleDateString()}</p>
                            </div>
                        </div>
                    `).join('')
                    : '<p class="no-events">No upcoming events found</p>';
            }
        } catch (error) {
            handleDashboardError(error);
        }
    }
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof loadUserEvents === 'function') {
            loadUserEvents();
        } else {
            console.error('loadUserEvents function not defined');
        }
    });
    </script>

    <script>
    async function updateEventStats() {
        try {
            const { data: registrations } = await window.supabaseClient
                .from('event_registrations')
                .select('event_id, events(status)')
                .eq('user_id', window.userProfile.id);

            const attended = registrations.filter(r => r.events?.status === 'completed').length;
            const upcoming = registrations.filter(r => r.events?.status === 'upcoming').length;
            
            safeTextUpdate('eventsAttended', attended);
            safeTextUpdate('upcomingEvents', upcoming);
        } catch (error) {
            console.error('Event stats error:', error);
        }
    }
    </script>

    <script>
    function checkProfileCompletion() {
        const completionStatus = document.getElementById('profileCompletionStatus');
        const accountSettingsBtn = document.getElementById('accountSettingsBtn');
        
        if (window.userProfile) {
            // Check required fields
            const requiredFields = [
                'phone',
                'street', 
                'city',
                'province',
                'postal_code'
            ];
            
            const completedFields = requiredFields.filter(field => 
                window.userProfile[field] && window.userProfile[field].trim() !== ''
            );

            const completionPercentage = Math.round(
                (completedFields.length / requiredFields.length) * 100
            );

            completionStatus.innerHTML = `
                <div class="progress-container">
                    <div class="progress-bar" style="width: ${completionPercentage}%"></div>
                </div>
                <span>Profile ${completionPercentage}% Complete</span>
            `;

            // Only show account settings when profile is 100% complete
            if (accountSettingsBtn) {
                accountSettingsBtn.style.display = completionPercentage === 100 ? 'flex' : 'none';
                accountSettingsBtn.style.visibility = completionPercentage === 100 ? 'visible' : 'hidden';
            }
        }
    }
    </script>

    <script>
    async function loadAndUpdateProfile() {
        try {
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();

            if (error) throw error;
            
            // Initialize with proper defaults
            window.userProfile = {
                ...profile,
                phone: profile.phone || 'Not provided',
                street: profile.street || 'Not provided',
                city: profile.city || 'Not provided',
                province: profile.province || 'Not provided',
                postal_code: profile.postal_code || 'Not provided'
            };

            initializeProfileSection();
            checkProfileCompletion();
            updateAddressDisplay();
        } catch (error) {
            handleDashboardError(error);
        }
    }
    </script>

    <!-- Add this error boundary at the end of your script -->
    <script>
    window.addEventListener('error', (event) => {
        const error = event.error || event;
        console.error('Global Error:', error);
        
        const errorDisplay = document.getElementById('errorNotification');
        if (errorDisplay) {
            errorDisplay.querySelector('.error-message').textContent = 
                `Error: ${error.message || 'Unknown error occurred'}`;
            errorDisplay.style.display = 'flex';
            setTimeout(() => errorDisplay.style.display = 'none', 5000);
        }
        
        if (error.message.includes('auth')) {
            window.location.href = 'login.html';
        }
    });
    </script>

    <!-- Add at the end of body -->
    <div id="errorNotification" class="error-alert" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span class="error-message"></span>
    </div>

    <style>
    .error-alert {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #ff4444;
        color: white;
        padding: 15px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    </style>

    <!-- Enhanced address initialization with validation -->
    <script>
    function initAddressComponents() {
        const elements = {
            street: document.getElementById('editStreet'),
            city: document.getElementById('editCity'),
            province: document.getElementById('editProvince'),
            postalCode: document.getElementById('editPostalCode'),
            form: document.getElementById('addressUpdateForm')
        };

        // Validate elements exist
        const missing = Object.entries(elements)
            .filter(([_, el]) => !el)
            .map(([name]) => name);

        if (missing.length > 0) {
            console.error('Missing address elements:', missing);
            return;
        }

        // Initialize with actual profile data
        const updateForm = () => {
            elements.street.value = window.userProfile?.street || '';
            elements.city.value = window.userProfile?.city || '';
            elements.province.value = window.userProfile?.province || '';
            elements.postalCode.value = window.userProfile?.postal_code || '';
        };

        document.getElementById('editAddressBtn').addEventListener('click', updateForm);
        document.addEventListener('profile:updated', updateForm);
    }

    // Initialize with retry logic
    function initWithRetry(attempt = 0) {
        try {
            initAddressComponents();
        } catch (error) {
            if (attempt < 3) {
                setTimeout(() => initWithRetry(attempt + 1), 500);
            } else {
                console.error('Failed to initialize address components after 3 attempts');
            }
        }
    }

    // Call initialization after DOM load
    document.addEventListener('DOMContentLoaded', initWithRetry);
    </script>

    <script>
    // When loading profile data
    function sanitizeProfileData(profile) {
        return {
            ...profile,
            phone: profile?.phone || 'Not provided',
            street: profile?.street || '',
            city: profile?.city || '',
            province: profile?.province || '',
            postal_code: profile?.postal_code || ''
        };
    }

    // Usage
    window.userProfile = sanitizeProfileData(rawProfileData);
    </script>

    <!-- Add this validation function -->
    <script>
    // Add this validation function
    function validateAddress(profile) {
        if (!profile) return false;
        return profile.street && profile.street.length > 5 &&
               profile.city && profile.city.length > 2 &&
               profile.province && profile.province.length === 2 &&
               profile.postal_code && /^[A-Z]\d[A-Z]\s?\d[A-Z]\d$/.test(profile.postal_code);
    }

    // Usage in display logic:
    const hasValidAddress = validateAddress(window.userProfile);
    </script>

    <script>
    // Update the validation call
    function updateAddressDisplay() {
        if (!window.userProfile) return;
        
        const hasValidAddress = validateAddress(window.userProfile);
        // Rest of your display logic
    }
    </script>

    <!-- Add this in DOMContentLoaded event listener -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize address components
        initAddressComponents();
        
        // Verify all elements exist
        const requiredElements = [
            '#editStreet', '#editCity', 
            '#editProvince', '#editPostalCode',
            '#modalPhoneNumber', '#modalAddress'
        ];
        
        requiredElements.forEach(selector => {
            if (!document.querySelector(selector)) {
                console.error(`Missing required element: ${selector}`);
            }
        });
    });
    </script>
</body>
</html> 