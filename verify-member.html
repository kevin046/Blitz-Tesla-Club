<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Blitz T Club - Member Verification</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-width: 480px;
            width: 100%;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 40px 30px 30px;
            text-align: center;
            position: relative;
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            color: #ffffff;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            color: #b0b0b0;
            font-size: 14px;
            font-weight: 400;
        }

        .content {
            padding: 30px;
        }

        .member-card {
            background: #f8fafc;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
        }

        .member-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .member-name {
            font-size: 20px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .member-id {
            font-size: 14px;
            color: #718096;
            margin-bottom: 16px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-verified {
            background: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-error {
            background: #fee2e2;
            color: #dc2626;
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
            display: none;
        }

        .vendor-section {
            background: #f8fafc;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e2e8f0;
        }

        .vendor-section h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 16px;
            text-align: center;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s ease;
            background: #ffffff;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .deal-form {
            display: none;
            background: #f8fafc;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e2e8f0;
            margin-top: 20px;
        }

        .deal-form h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 20px;
            text-align: center;
        }

        .deal-options {
            margin-bottom: 24px;
        }

        .deal-option {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .deal-option:hover {
            border-color: #667eea;
            background: #f8fafc;
        }

        .deal-option input[type="checkbox"] {
            margin-right: 16px;
            width: 20px;
            height: 20px;
            accent-color: #667eea;
        }

        .deal-option-content {
            flex: 1;
        }

        .deal-option-title {
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 4px;
        }

        .deal-option-desc {
            font-size: 14px;
            color: #6b7280;
        }

        .deal-option-price {
            font-weight: 600;
            color: #059669;
            font-size: 16px;
        }

        .custom-items {
            margin-bottom: 20px;
        }

        .custom-item-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }

        .custom-item-row input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .custom-item-row input:focus {
            outline: none;
            border-color: #667eea;
        }

        .remove-btn {
            background: #ef4444;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-custom-btn {
            background: #f3f4f6;
            color: #374151;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 12px;
            width: 100%;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .add-custom-btn:hover {
            border-color: #667eea;
            background: #f8fafc;
        }

        .deal-summary {
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .deal-summary-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .deal-summary-total {
            font-size: 24px;
            font-weight: 700;
            color: #059669;
        }

        .confirmation {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: 500;
            display: none;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: #6b7280;
            font-size: 14px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .vendor-message {
            text-align: center;
            font-size: 14px;
            margin-top: 12px;
            min-height: 20px;
        }

        .vendor-message.error {
            color: #dc2626;
        }

        .vendor-message.success {
            color: #059669;
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
                border-radius: 16px;
            }
            
            .header {
                padding: 30px 20px 20px;
            }
            
            .content {
                padding: 20px;
            }
            
            .member-card,
            .vendor-section,
            .deal-form {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://i.ibb.co/fkrdXZK/Logo4-white.png" alt="Blitz T Club" class="logo">
            <h1>Member Verification</h1>
            <p>Verify member status and log vendor deals</p>
        </div>
        
        <div class="content">
            <!-- Error Message -->
            <div id="errorMessage" class="error-message"></div>
            
            <!-- Member Information -->
            <div class="member-card">
                <div class="member-info">
                    <div id="memberName" class="member-name">Loading...</div>
                    <div id="memberId" class="member-id"></div>
                    <div id="memberStatus" class="status-badge status-pending">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Verifying...</span>
                    </div>
                </div>
            </div>
            
            <!-- Vendor Login Section -->
            <div id="vendorSection" class="vendor-section" style="display: none;">
                <h3><i class="fas fa-user-shield"></i> Vendor Access</h3>
                <div class="input-group">
                    <label for="vendorPassword">Enter Vendor Password</label>
                    <input type="password" id="vendorPassword" class="input-field" placeholder="Enter password">
                </div>
                <button id="vendorLoginBtn" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i>
                    Vendor Login
                </button>
                <div id="vendorMessage" class="vendor-message"></div>
            </div>
            
            <!-- Deal Form -->
            <div id="dealForm" class="deal-form">
                <h3><i class="fas fa-tags"></i> EE Auto Group Deal</h3>
                
                <div class="deal-options" id="dealOptions">
                    <div class="deal-option">
                        <input type="checkbox" data-type="driver_regular" data-label="Driver & Passenger (Regular)" data-price="100">
                        <div class="deal-option-content">
                            <div class="deal-option-title">Driver & Passenger (Regular)</div>
                            <div class="deal-option-desc">Driver & Passenger Side Windows (Regular Film)</div>
                        </div>
                        <div class="deal-option-price">$100</div>
                    </div>
                    
                    <div class="deal-option">
                        <input type="checkbox" data-type="driver_ceramic" data-label="Driver & Passenger (IR Ceramic)" data-price="150">
                        <div class="deal-option-content">
                            <div class="deal-option-title">Driver & Passenger (IR Ceramic)</div>
                            <div class="deal-option-desc">Driver & Passenger Side Windows (IR Ceramic)</div>
                        </div>
                        <div class="deal-option-price">$150</div>
                    </div>
                    
                    <div class="deal-option">
                        <input type="checkbox" data-type="windshield_regular" data-label="Windshield (Regular)" data-price="130">
                        <div class="deal-option-content">
                            <div class="deal-option-title">Windshield (Regular)</div>
                            <div class="deal-option-desc">Windshield (Regular Film)</div>
                        </div>
                        <div class="deal-option-price">$130</div>
                    </div>
                    
                    <div class="deal-option">
                        <input type="checkbox" data-type="all_regular" data-label="All Except Windshield/Sunroof (Regular)" data-price="200">
                        <div class="deal-option-content">
                            <div class="deal-option-title">All Except Windshield/Sunroof (Regular)</div>
                            <div class="deal-option-desc">All Except Windshield/Sunroof (Regular Film)</div>
                        </div>
                        <div class="deal-option-price">$200</div>
                    </div>
                    
                    <div class="deal-option">
                        <input type="checkbox" data-type="all_ceramic" data-label="All Except Windshield/Sunroof (IR Ceramic)" data-price="270">
                        <div class="deal-option-content">
                            <div class="deal-option-title">All Except Windshield/Sunroof (IR Ceramic)</div>
                            <div class="deal-option-desc">All Except Windshield/Sunroof (IR Ceramic)</div>
                        </div>
                        <div class="deal-option-price">$270</div>
                    </div>
                    
                    <div class="deal-option">
                        <input type="checkbox" data-type="best_package" data-label="Best Film Package (IR Ceramic, All Except Sunroof)" data-price="400">
                        <div class="deal-option-content">
                            <div class="deal-option-title">Best Film Package</div>
                            <div class="deal-option-desc">IR Ceramic, All Except Sunroof</div>
                        </div>
                        <div class="deal-option-price">$400</div>
                    </div>
                </div>
                
                <div class="custom-items" id="customItems"></div>
                <button type="button" class="add-custom-btn" id="addCustomBtn">
                    <i class="fas fa-plus"></i> Add Custom Item
                </button>
                
                <div class="deal-summary" id="dealSummary">
                    <div class="deal-summary-label">Total Amount</div>
                    <div class="deal-summary-total">$0</div>
                </div>
                
                <button type="submit" class="btn btn-primary" id="submitDealBtn">
                    <i class="fas fa-check"></i>
                    Submit Deal
                </button>
            </div>
            
            <!-- Confirmation Message -->
            <div id="confirmationMsg" class="confirmation"></div>
        </div>
    </div>

    <!-- Supabase Script -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // Configuration
        const SUPABASE_URL = 'https://qhkcrrphsjpytdfqfamq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoa2NycnBoc2pweXRkZnFmYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzMjQ4NzgsImV4cCI6MjA0OTkwMDg3OH0.S9JT_WmCWYMvSixRq1RrB1UlqXm6fix_riLFYCR3JOI';
        const VENDOR_PASSWORD = 'eeauto2024';
        const VENDOR_ID = 'ee-auto-uuid';
        const VENDOR_NAME = 'EE Auto';

        // Global variables
        let supabase;
        let currentMemberId = null;
        let vendorLoggedIn = false;

        document.addEventListener('DOMContentLoaded', async () => {
            initializeSupabase();
            const urlParams = new URLSearchParams(window.location.search);
            const memberUuid = urlParams.get('member_id');
            if (memberUuid) {
                // Fetch the member's profile to get the human-readable member_id
                let memberIdString = '';
                try {
                    const { data, error } = await window.supabaseClient
                        .from('profiles')
                        .select('member_id')
                        .eq('id', memberUuid)
                        .single();
                    if (!error && data && data.member_id) {
                        memberIdString = data.member_id;
                    }
                } catch (e) {
                    console.error('Could not fetch member_id string for scan log:', e);
                }
                await logQrScan(memberUuid, memberIdString);
                fetchMemberInfo(memberUuid);
            } else {
                displayError('No Member ID Provided', 'This page requires a member ID to function. Please scan a valid QR code.');
            }
        });

        function initializeSupabase() {
            if (window.supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } else {
                displayError('Initialization Error', 'Could not connect to the verification service. Please try again later.');
                console.error('Supabase client is not available.');
            }
        }
        
        async function logQrScan(memberUuid, memberIdString) {
            if (!window.supabaseClient) return;
            // Gather extra info (optional)
            const deviceInfo = navigator.userAgent || '';
            const scanData = {
                member_id: memberUuid, // UUID from URL
                member_id_string: memberIdString, // Human-readable member ID
                vendor_id: 'EE Auto Group',
                device_info: deviceInfo // Optional: add this column to your table if you want to store it
            };
            console.log('Logging scan to Supabase:', scanData); // Debug log
            try {
                const { error } = await window.supabaseClient
                    .from('qr_code_scans')
                    .insert(scanData);
                if (error) {
                    console.error('Failed to log QR scan:', error);
                } else {
                    console.log('QR scan logged for member:', memberUuid, memberIdString);
                }
            } catch (e) {
                console.error('Exception during scan logging:', e);
            }
        }

        async function fetchMemberInfo(memberUuid) {
            if (!supabase) {
                displayError('Service Unavailable', 'Cannot fetch member information at this time.');
                return;
            }

            // Show loading state
            document.getElementById('memberCard').innerHTML = '<p>Loading member info...</p>';

            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', memberUuid)
                .single();

            if (error || !data) {
                displayError('Member Not Found', 'The provided member ID is invalid. Please ensure the QR code is correct.');
                return;
            }
            
            displayMemberInfo(data);
        }

        function displayMemberInfo(profile) {
            const memberCard = document.getElementById('memberCard');
            const statusClass = profile.membership_status === 'active' ? 'status-verified' : 'status-pending';
            
            // Update member display
            document.getElementById('memberName').textContent = profile.full_name || 'Unnamed Member';
            document.getElementById('memberId').textContent = profile.member_id ? `Member ID: ${profile.member_id}` : '';
            
            // Update status
            updateMemberStatus(profile.membership_status === 'active' ? 'Verified Member' : 'Not Verified', statusClass, profile.membership_status === 'active' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle');
            
            if (profile.membership_status === 'active') {
                showVendorSection();
            } else {
                showError('Member Not Verified', 'This member has not completed verification.');
            }
        }

        // Update member status display
        function updateMemberStatus(text, className, iconClass) {
            const statusElement = document.getElementById('memberStatus');
            statusElement.className = `status-badge ${className}`;
            statusElement.innerHTML = `<i class="${iconClass}"></i><span>${text}</span>`;
        }

        // Show vendor section
        function showVendorSection() {
            document.getElementById('vendorSection').style.display = 'block';
        }

        // Show error message
        function showError(title, message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.innerHTML = `<strong>${title}</strong><br>${message}`;
            errorElement.style.display = 'block';
        }

        // Hide error message
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Set up event listeners
        function setupEventListeners() {
            // Vendor login
            document.getElementById('vendorLoginBtn').addEventListener('click', handleVendorLogin);
            
            // Enter key in password field
            document.getElementById('vendorPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleVendorLogin();
                }
            });
            
            // Deal form events
            document.getElementById('dealOptions').addEventListener('change', updateDealSummary);
            document.getElementById('addCustomBtn').addEventListener('click', addCustomItem);
            document.getElementById('submitDealBtn').addEventListener('click', submitDeal);
        }

        // Handle vendor login
        function handleVendorLogin() {
            const password = document.getElementById('vendorPassword').value.trim();
            const messageElement = document.getElementById('vendorMessage');
            
            if (!password) {
                showVendorMessage('Please enter a password.', 'error');
                return;
            }
            
            if (password.toLowerCase() === 'eeauto') {
                // Redirect to tracking page with member ID
                const urlParams = new URLSearchParams(window.location.search);
                const memberId = urlParams.get('member_id');
                if (memberId) {
                    window.location.href = `ee-auto-tracking.html?member_id=${encodeURIComponent(memberId)}`;
                } else {
                    window.location.href = 'ee-auto-tracking.html';
                }
                return;
            }
            
            if (password.toLowerCase() === VENDOR_PASSWORD.toLowerCase()) {
                vendorLoggedIn = true;
                document.getElementById('vendorSection').style.display = 'none';
                document.getElementById('dealForm').style.display = 'block';
                showVendorMessage('Login successful!', 'success');
            } else {
                showVendorMessage('Incorrect password.', 'error');
            }
        }

        // Show vendor message
        function showVendorMessage(message, type) {
            const messageElement = document.getElementById('vendorMessage');
            messageElement.textContent = message;
            messageElement.className = `vendor-message ${type}`;
        }

        // Add custom item
        function addCustomItem() {
            const customItemsContainer = document.getElementById('customItems');
            const row = document.createElement('div');
            row.className = 'custom-item-row';
            row.innerHTML = `
                <input type="text" class="custom-desc" placeholder="Description" style="flex: 2;">
                <input type="number" class="custom-price" placeholder="Price" min="0" step="0.01" style="flex: 1;">
                <button type="button" class="remove-btn" onclick="this.parentElement.remove(); updateDealSummary();">
                    <i class="fas fa-times"></i>
                </button>
            `;
            customItemsContainer.appendChild(row);
        }

        // Update deal summary
        function updateDealSummary() {
            let total = 0;
            const selectedDeals = [];
            const customItems = [];
            
            // Calculate selected deals
            document.querySelectorAll('.deal-option input[type="checkbox"]').forEach((checkbox, index) => {
                if (checkbox.checked) {
                    const dealOption = checkbox.closest('.deal-option');
                    const price = parseFloat(checkbox.dataset.price);
                    const label = checkbox.dataset.label;
                    selectedDeals.push({ type: checkbox.dataset.type, label, price });
                    total += price;
                }
            });
            
            // Calculate custom items
            document.querySelectorAll('.custom-item-row').forEach(row => {
                const desc = row.querySelector('.custom-desc').value.trim();
                const price = parseFloat(row.querySelector('.custom-price').value);
                if (desc && !isNaN(price) && price > 0) {
                    customItems.push({ desc, price });
                    total += price;
                }
            });
            
            // Update display
            document.getElementById('dealSummary').innerHTML = `
                <div class="deal-summary-label">Total Amount</div>
                <div class="deal-summary-total">$${total.toFixed(2)}</div>
            `;
            
            return { total, selectedDeals, customItems };
        }

        // Submit deal
        async function submitDeal() {
            const { total, selectedDeals, customItems } = updateDealSummary();
            
            if (selectedDeals.length === 0 && customItems.length === 0) {
                alert('Please select at least one deal or add a custom item.');
                return;
            }
            
            const submitBtn = document.getElementById('submitDealBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            try {
                const { error } = await supabase
                    .from('vendor_deals')
                    .insert({
                        member_id: currentMemberId,
                        vendor_id: VENDOR_ID,
                        vendor_name: VENDOR_NAME,
                        deal_type: 'window_tint',
                        deal_details: selectedDeals,
                        total_price: total,
                        custom_items: customItems,
                        created_at: new Date().toISOString(),
                        created_by: VENDOR_ID
                    });
                
                if (error) {
                    throw error;
                }
                
                // Show success message
                document.getElementById('dealForm').style.display = 'none';
                const confirmationElement = document.getElementById('confirmationMsg');
                confirmationElement.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <strong>Deal Successfully Logged!</strong><br>
                    Thank you, EE Auto. The deal has been recorded for this member.
                `;
                confirmationElement.style.display = 'block';
                
            } catch (error) {
                console.error('Error submitting deal:', error);
                alert('Failed to log deal: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Submit Deal';
            }
        }
    </script>
</body>
</html> 