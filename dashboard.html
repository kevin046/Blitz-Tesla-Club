<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dashboard - Blitz T Club</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/BvmtNLtB/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="navigation.js"></script>
    <style>
        /* iOS Optimizations */
        @supports (-webkit-touch-callout: none) {
            .dashboard-container {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }

            .dashboard-header {
                margin-top: env(safe-area-inset-top);
            }

            nav {
                padding-top: env(safe-area-inset-top);
            }

            footer {
                padding-bottom: env(safe-area-inset-bottom);
            }

            /* Prevent text size adjustment */
            body {
                -webkit-text-size-adjust: none;
            }

            /* Improve touch targets */
            .nav-links a,
            .quick-actions button,
            .quick-link-item,
            .resend-btn {
                min-height: 44px;
                padding: 12px;
            }

            /* Smooth scrolling */
            .dashboard-container {
                -webkit-overflow-scrolling: touch;
            }

            /* Prevent unwanted highlighting */
            * {
                -webkit-tap-highlight-color: transparent;
            }
        }

        /* Modern Membership Card Styles */
        .modal-content.membership-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: 16px;
            padding: 30px;
            margin: 0 auto;
            text-align: left;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            position: relative;
            overflow: hidden;
            transform: perspective(1000px) rotateY(0deg);
            transition: transform 0.5s ease;
        }
        
        .modal-content.membership-card:hover {
            transform: perspective(1000px) rotateY(5deg);
        }
        
        .modal-content.membership-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.05) 50%, 
                rgba(255,255,255,0) 100%);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            background: transparent;
            padding: 0;
            border: none;
        }
        
        .card-header img {
            height: 60px;
            width: auto;
            background: transparent;
            margin: 0;
        }
        
        .header-text h2 {
            font-size: 22px;
            margin: 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.95);
            background: transparent;
        }
        
        .member-info {
            margin: 25px 0;
            text-align: left;
        }
        
        .member-info h3 {
            font-size: 24px;
            margin-bottom: 25px;
            font-weight: 700;
            color: white;
            letter-spacing: 0.5px;
            text-transform: capitalize;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 14px;
            color: white;
            margin-bottom: 5px;
        }
        
        .info-row .label {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        
        .card-footer {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }
        
        .qr-section {
            text-align: center;
        }
        
        canvas.qr-code {
            width: 120px;
            height: 120px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin: 0 auto 15px;
        }
        
        .qr-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .qr-text i {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        /* Premium Card Style */
        .membership-card[data-type="premium"] {
            background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .membership-card[data-type="premium"]::before {
            background: linear-gradient(45deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.1) 50%, 
                rgba(255,255,255,0) 100%);
        }
        
        .membership-card[data-type="premium"] .header-text h2 {
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .membership-card[data-type="premium"] .info-row {
            border-bottom: 1px solid rgba(255, 255, 255, 0.25);
        }
        
        .membership-card[data-type="premium"] .qr-text {
            color: rgba(255, 255, 255, 0.9);
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Modal styling for the card */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow: auto;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease forwards;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            position: relative;
            margin: 20px;
            animation: modalSlideIn 0.4s ease-out forwards;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .close-modal:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(1.1);
        }

        .profile-settings {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
        }

        .form-group input {
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Edit Profile Modal Styles */
        .danger-btn {
            background-color: #dc3545;
            color: white;
        }
        
        .danger-btn:hover {
            background-color: #c82333;
        }
        
        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .toggle-password {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Modern Settings Modal Styles */
        .settings-modal {
            max-width: 600px;
            width: 90%;
            background: #1a1a1a;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .settings-modal .modal-header {
            background: #222;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            border-bottom: 1px solid #333;
        }

        .settings-modal .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            color: #fff;
        }

        .settings-modal .modal-body {
            padding: 20px;
        }

        .settings-section {
            background: #222;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 1.1em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            color: #888;
            font-size: 0.9em;
        }

        .info-value {
            color: #fff;
            font-weight: 500;
        }

        .modern-input {
            width: 100%;
            padding: 12px;
            background: #333;
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 0.95em;
            transition: border-color 0.3s ease;
        }

        .modern-input:focus {
            border-color: #666;
            outline: none;
        }

        .danger-zone {
            border: 1px solid #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .danger-text {
            color: #dc3545;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .primary-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .primary-btn:hover {
            background: #0056b3;
        }

        .danger-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .danger-btn:hover {
            background: #c82333;
        }

        .password-input-container {
            position: relative;
            width: 100%;
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0;
        }

        .toggle-password:hover {
            color: #888;
        }

        /* Password Strength Meter */
        .password-strength-meter {
            margin-top: 10px;
            font-size: 0.85em;
        }

        .strength-label {
            margin-bottom: 5px;
            color: #bbb;
        }

        .strength-bar-container {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-bottom: 6px;
        }

        .strength-bar {
            height: 100%;
            width: 0;
            transition: width 0.3s ease, background 0.3s ease;
            border-radius: 2px;
        }

        .strength-weak {
            width: 33%;
            background: #dc2626;
        }

        .strength-medium {
            width: 66%;
            background: #f59e0b;
        }

        .strength-strong {
            width: 100%;
            background: #16a34a;
        }

        #passwordRequirements {
            color: #888;
            font-size: 0.85em;
        }
    </style>
</head>
<body class="dashboard-page">
    <!-- Standard Navigation -->
    <nav>
        <div class="logo">
            <a href="index.html">
                <img src="https://i.ibb.co/fkrdXZK/Logo4-white.png" alt="Blitz Tesla Club Logo" loading="lazy" width="50" height="50">
                <span>BLITZ T CLUB</span>
            </a>
        </div>
        <div class="menu-toggle" aria-label="Toggle navigation menu">
            <i class="fas fa-bars"></i>
        </div>
        <ul class="nav-links">
            <!-- Navigation items will be dynamically inserted by navigation.js -->
        </ul>
    </nav>

    <!-- Dashboard Content -->
    <main class="dashboard-container">
        <!-- Welcome Header -->
        <div class="dashboard-header">
            <div class="user-welcome">
                <h1>Welcome, <span id="userFullName"></span></h1>
                <div class="status-badge">
                    <span class="status-label">Membership Status:</span>
                    <span id="membershipStatus" data-status="pending"></span>
                    <span class="verification-status" id="verificationStatus"></span>
                </div>
            </div>
            <div class="quick-actions">
                <button class="btn primary-btn" id="membershipCardBtn">
                    <i class="fas fa-id-card"></i>
                    View Membership Card
                </button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Upcoming Events Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-calendar"></i> Upcoming Events</h2>
                    <a href="events.html" class="view-all">View All</a>
                </div>
                <div class="card-content" id="upcomingEventsList">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </div>
            </div>

            <!-- Member Stats Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-line"></i> Member Stats</h2>
                </div>
                <div class="card-content">
                    <div class="stat-grid">
                        <div class="stat-item">
                            <span class="stat-label">Member Since</span>
                            <span class="stat-value" id="memberSince">Loading...</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Member ID</span>
                            <span class="stat-value" id="memberId" style="font-family: monospace; font-weight: bold;"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Events Attended</span>
                            <span class="stat-value" id="eventsAttended">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Links Card -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-link"></i> Quick Links</h2>
                </div>
                <div class="card-content">
                    <div class="quick-links-grid">
                        <a href="#" class="quick-link-item">
                            <i class="fas fa-calendar-plus"></i>
                            <span>Register for Event</span>
                        </a>
                        <a href="#" class="quick-link-item">
                            <i class="fas fa-file-invoice"></i>
                            <span>View Invoices</span>
                        </a>
                        <a href="#" class="quick-link-item" id="accountSettingsBtn">
                            <i class="fas fa-cog"></i>
                            <span>Account Settings</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Standard Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>BLITZ T CLUB</h3>
                <p>Empowering the future of sustainable transportation through innovation and community.</p>
            </div>
            
            <div class="footer-section">
                <h3>Quick Links</h3>
                <div class="footer-links">
                    <a href="index.html">Home</a>
                    <a href="events.html">Events</a>
                    <a href="gallery.html">Gallery</a>
                    <a href="contact.html">Contact</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Member Area</h3>
                <div class="footer-links">
                    <a href="sponsors.html">Our Sponsors</a>
                    <a href="#member-benefits">Member Benefits</a>
                    <a href="#" id="footerLogoutBtn">Logout</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Legal</h3>
                <div class="footer-links">
                    <a href="privacy.html">Privacy Policy</a>
                    <a href="terms.html">Terms of Service</a>
                    <a href="about.html">About Us</a>
                </div>
            </div>

            <div class="footer-section">
                <h3>Connect With Us</h3>
                <div class="footer-social">
                    <a href="https://x.com/BlitzTClub" target="_blank" aria-label="Follow us on X">
                        <i class="fa-brands fa-square-x-twitter"></i>
                    </a>
                    <a href="https://www.instagram.com/blitztclub/" target="_blank" aria-label="Follow us on Instagram">
                        <i class="fab fa-instagram"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <p>© 2024 Blitz T Club. All rights reserved.</p>
            <p class="powered-by">
                Website powered by <a href="http://www.summitpixels.com" target="_blank">SummitPixels</a>
            </p>
        </div>
    </footer>

    <!-- Keep your existing script -->
    <script>
        // Function to generate random token
        function generateToken(length = 32) {
            const array = new Uint8Array(length);
            crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }

        // Function to generate sequential member ID
        async function generateSequentialMemberId() {
            try {
                // Get the latest member ID from the database
                const { data: profiles, error } = await supabaseClient
                    .from('profiles')
                    .select('member_id')
                    .not('member_id', 'is', null)
                    .order('member_id', { ascending: false })
                    .limit(1);

                if (error) {
                    console.error('Error fetching latest member ID:', error);
                    // Return a timestamp-based ID as fallback
                    return `BTC${Date.now().toString().slice(-6)}`;
                }

                let nextNumber = 1; // Default start number

                if (profiles && profiles.length > 0 && profiles[0].member_id) {
                    // Extract the number from the latest member ID (format: BTC#####)
                    const lastNumber = parseInt(profiles[0].member_id.replace('BTC', ''), 10);
                    if (!isNaN(lastNumber)) {
                        nextNumber = lastNumber + 1;
                    }
                }

                // Format the new member ID with leading zeros
                const memberId = `BTC${nextNumber.toString().padStart(5, '0')}`;
                console.log('Generated sequential member ID:', memberId);
                return memberId;
            } catch (error) {
                console.error('Error generating member ID:', error);
                // Return a timestamp-based ID as fallback
                return `BTC${Date.now().toString().slice(-6)}`;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Check for any pending account deletion requests
            const pendingDeletion = localStorage.getItem('pendingAccountDeletion');
            const deletionTime = localStorage.getItem('deletionRequestTime');
            
            if (pendingDeletion && navigator.onLine && window.location.protocol !== 'file:') {
                console.log('Found pending account deletion request from:', deletionTime);
                
                try {
                    // Check if we're on localhost or a deployed server
                    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                    const apiUrl = isLocalhost
                        ? 'http://localhost:3000/api/cleanup-orphaned-users'
                        : '/api/cleanup-orphaned-users';
                    
                    console.log('Attempting to process pending deletion via API:', apiUrl);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: pendingDeletion
                        })
                    });
                    
                    if (response.ok) {
                        console.log('Successfully processed pending account deletion');
                        // Clear the pending deletion
                        localStorage.removeItem('pendingAccountDeletion');
                        localStorage.removeItem('deletionRequestTime');
                    } else {
                        console.warn('Could not process pending deletion - will try again later');
                    }
                } catch (error) {
                    console.error('Error processing pending deletion:', error);
                }
            }
            
            // Initialize navigation first
            await initializeNavigation();

            // Check if user is logged in
            const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
            
            console.log('Session:', session);
            
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            // Get user profile
            const { data: userData, error: profileError } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('email', session.user.email)
                .single();

            console.log('Fetching profile for email:', session.user.email);
            console.log('Profile query result:', { profile: userData, profileError });

            let profile;

            if (profileError && profileError.code === 'PGRST116') {
                // Profile doesn't exist, create one
                console.log('No profile found, creating new profile...');
                
                // Generate sequential member ID
                const memberId = await generateSequentialMemberId();
                
                const { data: newProfile, error: createError } = await supabaseClient
                    .from('profiles')
                    .insert([
                        {
                            id: session.user.id,
                            email: session.user.email,
                            full_name: session.user.user_metadata?.full_name || session.user.email.split('@')[0],
                            username: session.user.email.split('@')[0],
                            membership_status: 'pending',
                            membership_type: 'standard',
                            member_id: memberId,
                            created_at: new Date().toISOString()
                        }
                    ])
                    .select()
                    .single();

                if (createError) {
                    console.error('Error creating profile:', createError);
                    throw createError;
                }

                console.log('New profile created:', newProfile);
                profile = newProfile;
            } else if (profileError) {
                console.error('Error fetching profile:', profileError);
                throw profileError;
            } else {
                profile = userData;
            }

            // Make profile available globally for other functions
            window.userProfile = profile;

            console.log('Using profile:', profile);

            // Update user info
            document.getElementById('userFullName').textContent = profile.full_name || 'Member';
            const statusElement = document.getElementById('membershipStatus');
            if (statusElement) {
                statusElement.textContent = profile.membership_status ? 
                    profile.membership_status.charAt(0).toUpperCase() + profile.membership_status.slice(1) : 
                    'Pending';
                statusElement.dataset.status = profile.membership_status || 'pending';
            }

            // Update member stats
            const memberSince = document.getElementById('memberSince');
            if (memberSince) {
                memberSince.textContent = profile.created_at ? 
                    new Date(profile.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'Not Available';
            }

            const memberId = document.getElementById('memberId');
            if (memberId) {
                // Check multiple sources for member ID in order of preference
                const storedMemberId = localStorage.getItem('userMemberId');
                const displayMemberId = profile.member_id || 
                                       session.user.user_metadata?.member_id || 
                                       storedMemberId || 
                                       'Not Available';
                
                console.log('Member ID sources:', {
                    profile: profile.member_id,
                    metadata: session.user.user_metadata?.member_id,
                    localStorage: storedMemberId
                });
                
                // Set the member ID on the profile if it's missing but available elsewhere
                if (!profile.member_id && (session.user.user_metadata?.member_id || storedMemberId)) {
                    const memberId = session.user.user_metadata?.member_id || storedMemberId;
                    console.log('Updating missing profile member_id with:', memberId);
                    
                    // Update the profile with the member ID
                    supabaseClient
                        .from('profiles')
                        .update({ 
                            member_id: memberId,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', session.user.id)
                        .then(response => {
                            if (response.error) {
                                console.error('Error updating profile with member ID:', response.error);
                            } else {
                                console.log('Profile updated with member ID:', memberId);
                            }
                        });
                }
                
                memberId.textContent = displayMemberId;
            }

            const eventsAttended = document.getElementById('eventsAttended');
            if (eventsAttended) {
                eventsAttended.textContent = profile.events_attended || '0';
            }

            // Function to update status display
            const updateStatusDisplay = async () => {
                try {
                    // Fetch latest profile data from Supabase using email only
                    const { data: latestProfile, error: profileError } = await supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('email', session.user.email)
                        .single();

                    if (profileError) {
                        console.error('Error fetching latest profile:', profileError);
                        return;
                    }

                    if (!latestProfile) {
                        console.warn('No profile data found');
                        return;
                    }

                    console.log('Latest profile data:', latestProfile);

                    const verificationStatus = document.getElementById('verificationStatus');
                    const statusElement = document.getElementById('membershipStatus');

                    if (!verificationStatus || !statusElement) {
                        console.warn('Status elements not found');
                        return;
                    }

                    // Use the latest profile data
                    if (latestProfile.membership_status === 'active') {
                        verificationStatus.innerHTML = `
                            <span class="badge success">
                                <i class="fas fa-check-circle"></i>
                                Email verified
                            </span>
                        `;
                        statusElement.textContent = 'Active';
                        statusElement.className = 'status-active';
                    } else {
                        verificationStatus.innerHTML = `
                            <span class="badge warning">
                                <i class="fas fa-envelope"></i>
                                Please verify your email
                                <button id="resendVerification" class="resend-btn">
                                    <i class="fas fa-redo"></i> Resend Verification
                                </button>
                            </span>
                        `;
                        statusElement.textContent = 'Pending';
                        statusElement.className = 'status-pending';
                    }

                    // Update the global profile data
                    window.userProfile = latestProfile;
                } catch (error) {
                    console.error('Error updating status display:', error);
                }
            };

            // Initial status update
            await updateStatusDisplay();

            // Add periodic status check
            setInterval(updateStatusDisplay, 30000);

            // Handle logout
            const logoutButtons = document.querySelectorAll('#logoutBtn, #footerLogoutBtn');
            logoutButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) {
                        console.error('Error signing out:', error);
                    }
                    localStorage.removeItem('supabase.auth.token');
                    sessionStorage.removeItem('supabase.auth.token');
                    window.location.href = 'login.html';
                });
            });

            // Handle mobile menu
            const menuToggle = document.querySelector('.menu-toggle');
            const navLinks = document.querySelector('.nav-links');
            const body = document.body;
            if (menuToggle && navLinks) {
                menuToggle.addEventListener('click', () => {
                    navLinks.classList.toggle('active');
                    body.classList.toggle('nav-open');
                });

                // Close menu when clicking a link
                navLinks.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        navLinks.classList.remove('active');
                        body.classList.remove('nav-open');
                    });
                });
            }

            // Add this after profile data is loaded
            const membershipCardBtn = document.getElementById('membershipCardBtn');
            const modal = document.getElementById('membershipCardModal');
            const closeModalBtn = document.querySelector('.close-modal');

            membershipCardBtn.addEventListener('click', () => {
                // Format date for card display
                const formattedDate = profile.created_at ? 
                    new Date(profile.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'Not Available';

                // Get the member ID from all possible sources
                const storedMemberId = localStorage.getItem('userMemberId');
                const cardMemberId = profile.member_id || 
                                  session.user.user_metadata?.member_id || 
                                  storedMemberId || 
                                  'Not Available';
                
                console.log('Member ID for card display:', {
                    profileId: profile.member_id,
                    metadataId: session.user.user_metadata?.member_id,
                    localStorageId: storedMemberId,
                    using: cardMemberId
                });

                // Update card info
                document.getElementById('cardFullName').textContent = profile.full_name;
                document.getElementById('cardMemberId').textContent = cardMemberId;
                document.getElementById('cardMemberSince').textContent = formattedDate;
                document.getElementById('cardMembershipStatus').textContent = 
                    profile.membership_type.charAt(0).toUpperCase() + profile.membership_type.slice(1);

                // Set card style based on membership type
                const cardElement = document.querySelector('.membership-card');
                cardElement.dataset.type = profile.membership_type;

                // Generate QR code
                const qrData = JSON.stringify({
                    id: profile.id,
                    memberId: cardMemberId,
                    type: profile.membership_type,
                    name: profile.full_name,
                    since: formattedDate,
                    verified: true
                });
                
                const qrCanvas = document.getElementById('memberQRCode');
                // Clear previous QR code if any
                const context = qrCanvas.getContext('2d');
                context.clearRect(0, 0, qrCanvas.width, qrCanvas.height);
                
                QRCode.toCanvas(qrCanvas, qrData, {
                    width: 120,
                    margin: 0,
                    color: {
                        dark: '#171a20',
                        light: '#ffffff'
                    }
                });

                modal.classList.add('show');
            });

            // Close modal when clicking the X button
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                    modal.classList.remove('show');
                });
            }

            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });

            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('show')) {
                    modal.classList.remove('show');
                }
            });

            // Handle account settings
            const accountSettingsBtn = document.getElementById('accountSettingsBtn');
            const editProfileModal = document.getElementById('editProfileModal');
            const modalEditProfileForm = document.getElementById('modalEditProfileForm');
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');
            
            // Show modal when Account Settings link is clicked
            accountSettingsBtn.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Populate account information
                document.getElementById('modalUserEmail').textContent = profile.email;
                document.getElementById('modalMemberId').textContent = profile.member_id;
                document.getElementById('modalMemberSince').textContent = profile.created_at ? 
                    new Date(profile.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'Not Available';
                document.getElementById('modalMembershipStatus').textContent = 
                    profile.membership_status.charAt(0).toUpperCase() + profile.membership_status.slice(1);
                
                editProfileModal.style.display = 'block';
            });
            
            // Close modal when clicking the X
            document.querySelector('.close-modal').addEventListener('click', () => {
                editProfileModal.style.display = 'none';
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === editProfileModal) {
                    editProfileModal.style.display = 'none';
                }
            });
            
            // Handle password update
            modalEditProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const currentPassword = document.getElementById('modalCurrentPassword').value;
                const newPassword = document.getElementById('modalNewPassword').value;
                const confirmPassword = document.getElementById('modalConfirmPassword').value;
                
                if (!currentPassword) {
                    alert('Please enter your current password');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }
                
                // Password validation
                if (newPassword.length < 8) {
                    alert('Password must be at least 8 characters long');
                    return;
                }
                
                const submitButton = modalEditProfileForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                submitButton.disabled = true;
                
                try {
                    // First verify the current password by signing in
                    const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({
                        email: window.userProfile.email,
                        password: currentPassword
                    });
                    
                    if (signInError) {
                        throw new Error('Current password is incorrect');
                    }
                    
                    // Update password using Supabase auth
                    const { error } = await supabaseClient.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (error) throw error;
                    
                    // Show success message
                    alert('Password updated successfully');
                    
                    // Reset form and close modal
                    modalEditProfileForm.reset();
                    editProfileModal.style.display = 'none';
                    
                    // Optionally force re-login
                    if (confirm('Your password has been updated successfully. For security reasons, would you like to log out and sign in with your new password?')) {
                        await supabaseClient.auth.signOut();
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('Error updating password:', error);
                    
                    // Show specific error message based on the error
                    if (error.message.includes('Password should be at least')) {
                        alert('Password must be at least 8 characters long');
                    } else if (error.message.includes('expired')) {
                        alert('Your session has expired. Please log in again to change your password.');
                        await supabaseClient.auth.signOut();
                        window.location.href = 'login.html';
                    } else if (error.message.includes('incorrect')) {
                        alert('Current password is incorrect');
                    } else {
                        alert('Failed to update password: ' + error.message);
                    }
                } finally {
                    // Restore button state
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                }
            });
            
            // Handle account deletion
            deleteAccountBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                    return;
                }
                
                // Double confirmation with password for security
                const confirmPassword = prompt("Please enter your password to confirm account deletion:");
                if (!confirmPassword) {
                    return; // User canceled the password prompt
                }
                
                try {
                    // Verify password before proceeding
                    const { error: signInError } = await supabaseClient.auth.signInWithPassword({
                        email: profile.email,
                        password: confirmPassword
                    });
                    
                    if (signInError) {
                        console.error('Password verification failed:', signInError);
                        alert('Incorrect password. Account deletion canceled.');
                        return;
                    }
                    
                    // Show loading state
                    deleteAccountBtn.disabled = true;
                    deleteAccountBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                    
                    console.log('Deleting account for user:', profile.id);

                    // First delete the profile
                    const { error: profileError } = await supabaseClient
                        .from('profiles')
                        .delete()
                        .eq('id', profile.id);

                    if (profileError) {
                        console.error('Error deleting profile:', profileError);
                        // Continue with deletion process even if profile deletion fails
                    }

                    try {
                        // Determine if we're running from file protocol
                        const isFileProtocol = window.location.protocol === 'file:';
                        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                        
                        // If running from file:// protocol, we need to handle this differently
                        if (isFileProtocol) {
                            console.log('Running from file protocol - implementing direct user deletion');
                            
                            // Step 1: Delete all user-related data in Supabase database
                            // Delete any events the user registered for (if you have an events table)
                            const { error: eventsError } = await supabaseClient
                                .from('event_registrations')
                                .delete()
                                .eq('user_id', profile.id);
                            
                            if (eventsError) {
                                console.warn('Error deleting event registrations:', eventsError);
                                // Continue anyway as this is not critical
                            }
                            
                            // Step 2: Use the appropriate Supabase auth method that works with client-side permissions
                            // This will work with the client's own token since they're deleting their own account
                            console.log('Deleting user account from Supabase Auth');
                            const { error: deleteUserError } = await supabaseClient.auth.updateUser({
                                data: { deleted: true, deletion_time: new Date().toISOString() }
                            });
                            
                            if (deleteUserError) {
                                console.error('Error updating user metadata for deletion:', deleteUserError);
                                // Continue with the process as we've already deleted the profile
                            } else {
                                console.log('User metadata updated to mark account as deleted');
                            }
                            
                            // Step 3: Since we can't fully delete the auth account client-side,
                            // we'll add a server-side deletion request to a queue
                            try {
                                // Store deletion request in localStorage for future sync
                                localStorage.setItem('pendingAccountDeletion', profile.id);
                                localStorage.setItem('deletionRequestTime', new Date().toISOString());
                                console.log('Queued account for server-side deletion on next online session');
                            } catch (storageError) {
                                console.warn('Could not queue deletion request:', storageError);
                            }
                        } else {
                            // Regular web server environment - use API endpoint
                            const apiUrl = isLocalhost
                                ? 'http://localhost:3000/api/cleanup-orphaned-users'
                                : '/api/cleanup-orphaned-users';
                            
                            console.log('Using API endpoint for account deletion:', apiUrl);
                            
                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    user_id: profile.id
                                })
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error || 'Failed to delete account completely');
                            }
                        }

                        // Sign out and clear storage regardless of method used
                        await supabaseClient.auth.signOut();
                        localStorage.removeItem('supabase.auth.token');
                        sessionStorage.removeItem('supabase.auth.token');
                        
                        // We keep the pendingAccountDeletion item if it exists
                        const pendingDeletion = localStorage.getItem('pendingAccountDeletion');
                        const deletionTime = localStorage.getItem('deletionRequestTime');
                        
                        localStorage.clear();
                        sessionStorage.clear();
                        
                        // Restore the pending deletion info if it exists
                        if (pendingDeletion) {
                            localStorage.setItem('pendingAccountDeletion', pendingDeletion);
                            localStorage.setItem('deletionRequestTime', deletionTime);
                        }

                        // Show success message and redirect
                        alert('Your account has been successfully deleted. You will now be redirected to the homepage.');
                        window.location.href = 'index.html';
                    } catch (error) {
                        console.error('Error deleting account:', error);
                        
                        // Special handling for local development/testing
                        if (window.location.protocol === 'file:') {
                            const continueAnyway = confirm('We encountered an issue while deleting your account. Your profile data has been deleted, but your auth account may need to be removed next time you\'re online. Would you like to sign out now?');
                            
                            if (continueAnyway) {
                                // Just sign out
                                await supabaseClient.auth.signOut();
                                localStorage.clear();
                                sessionStorage.clear();
                                window.location.href = 'index.html';
                                return;
                            }
                        } else {
                            alert('Failed to delete account completely. Please try again or contact support.');
                        }
                        
                        // Reset button state
                        deleteAccountBtn.disabled = false;
                        deleteAccountBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete Account';
                    }
                } catch (error) {
                    console.error('Error deleting account:', error);
                    alert('Failed to delete account completely. Please try again or contact support.');
                    // Reset button state
                    deleteAccountBtn.disabled = false;
                    deleteAccountBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete Account';
                }
            });
            
            // Password visibility toggle
            document.querySelectorAll('.toggle-password').forEach(button => {
                button.addEventListener('click', function() {
                    const input = this.previousElementSibling;
                    const icon = this.querySelector('i');
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        input.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            });

            // Password strength meter
            const passwordInput = document.getElementById('modalNewPassword');
            const strengthMeter = document.querySelector('.password-strength-meter');
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');

            passwordInput.addEventListener('input', function() {
                const password = this.value;
                
                // Show strength meter only if password has some value
                if (password.length > 0) {
                    strengthMeter.style.display = 'block';
                } else {
                    strengthMeter.style.display = 'none';
                    return;
                }
                
                // Calculate password strength
                let strength = 0;
                
                // Basic requirements
                if (password.length >= 8) strength += 1; // Length
                if (/[A-Z]/.test(password)) strength += 1; // Uppercase
                if (/[a-z]/.test(password)) strength += 1; // Lowercase
                if (/[0-9]/.test(password)) strength += 1; // Numbers
                if (/[^A-Za-z0-9]/.test(password)) strength += 1; // Special chars
                
                // Update strength indicator
                strengthBar.className = 'strength-bar';
                
                if (strength < 3) {
                    strengthBar.classList.add('strength-weak');
                    strengthText.textContent = 'Weak';
                    strengthText.style.color = '#dc3545';
                } else if (strength < 5) {
                    strengthBar.classList.add('strength-medium');
                    strengthText.textContent = 'Medium';
                    strengthText.style.color = '#ffc107';
                } else {
                    strengthBar.classList.add('strength-strong');
                    strengthText.textContent = 'Strong';
                    strengthText.style.color = '#28a745';
                }
            });

            // Check if coming from verification success
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('verified') === 'true') {
                await updateStatusDisplay();
                // Clear the URL parameters
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            if (profile.membership_status === 'pending') {
                verificationStatus.innerHTML = `
                    <span class="badge warning">
                        <i class="fas fa-envelope"></i>
                        Please verify your email
                        <button id="resendVerification" class="resend-btn">
                            <i class="fas fa-redo"></i> Resend Verification
                        </button>
                    </span>
                `;

                // Add click handler for resend button
                const resendBtn = document.getElementById('resendVerification');
                resendBtn.addEventListener('click', async () => {
                    try {
                        // Generate verification token
                        const verificationToken = crypto.randomUUID();
                        console.log('Generated token:', verificationToken);

                        // Store token temporarily in localStorage
                        localStorage.setItem('verificationToken', verificationToken);
                        localStorage.setItem('tokenExpiry', new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString());

                        // Get base URL for verification link
                        const baseUrl = window.location.href.split('/').slice(0, -1).join('/');
                        const verificationUrl = `${baseUrl}/verify-email.html?token=${verificationToken}`;

                        // Send verification email using FormSubmit
                        const formData = new FormData();
                        formData.append('email', profile.email);
                        formData.append('_captcha', 'false');
                        formData.append('_template', 'box');
                        formData.append('_subject', 'Verify Your Blitz T Club Membership');
                        formData.append('_autoresponse', 'Thank you for verifying your email. Your Blitz T Club membership will be activated shortly.');
                        formData.append('message', `Welcome to Blitz T Club!

Member ID: ${profile.member_id}

Please click the link below to verify your email and activate your membership:
${verificationUrl}

Important Notes:
- This verification link will expire in 24 hours
- Please verify on the same device you're currently using
- After verification, your membership will be activated instantly

Next Steps:
1. Click the verification link above
2. Your membership will be activated instantly
3. Access your digital membership card
4. Start enjoying member benefits

If you can't click the link, copy and paste this URL into your browser:
${verificationUrl}

If you didn't request this email, please ignore it.

Best regards,
Blitz T Club Team`);

                        // Send the verification email
                        const emailResponse = await fetch(`https://formsubmit.co/ajax/${profile.email}`, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json'
                            },
                            body: formData
                        });

                        if (!emailResponse.ok) {
                            const responseText = await emailResponse.text();
                            console.error('FormSubmit response:', responseText);
                            throw new Error('Failed to send verification email');
                        }

                        // Store verification data in localStorage
                        localStorage.setItem('pendingVerificationEmail', profile.email);
                        localStorage.setItem('pendingMemberId', profile.member_id);
                        localStorage.setItem('registrationTime', new Date().toISOString());

                        // Redirect to verification sent page
                        window.location.href = 'verification-sent.html';

                    } catch (error) {
                        console.error('Error sending verification:', error);
                        alert('Failed to send verification email. Please try again.');
                    }
                });
            }
        });
    </script>

    <!-- Membership Card Modal -->
    <div id="membershipCardModal" class="modal">
        <div class="modal-content membership-card">
            <button class="close-modal">&times;</button>
            <div class="card-header">
                <div class="header-text">
                    <h2>Blitz T Club</h2>
                </div>
                <img src="https://i.ibb.co/fkrdXZK/Logo4-white.png" alt="Blitz Tesla Club Logo">
            </div>
            <div class="member-info">
                <h3 id="cardFullName"></h3>
                <div class="info-row">
                    <span class="label">Member ID</span>
                    <span id="cardMemberId"></span>
                </div>
                <div class="info-row">
                    <span class="label">Member Since</span>
                    <span id="cardMemberSince"></span>
                </div>
                <div class="info-row">
                    <span class="label">Status</span>
                    <span id="cardMembershipStatus"></span>
                </div>
            </div>
            <div class="card-footer">
                <div class="qr-section">
                    <canvas class="qr-code" id="memberQRCode"></canvas>
                    <div class="qr-text">
                        <i class="fas fa-qrcode"></i>
                        <small>Scan to verify membership</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Settings Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content settings-modal">
            <div class="modal-header">
                <h2><i class="fas fa-user-cog"></i> Account Settings</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Account Info Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-info-circle"></i> Account Information</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Email</span>
                            <span class="info-value" id="modalUserEmail"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Member ID</span>
                            <span class="info-value" id="modalMemberId"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Member Since</span>
                            <span class="info-value" id="modalMemberSince"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Membership Status</span>
                            <span class="info-value" id="modalMembershipStatus"></span>
                        </div>
                    </div>
                </div>

                <!-- Password Change Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-key"></i> Change Password</h3>
                    <form id="modalEditProfileForm">
                        <!-- Add hidden username field for accessibility -->
                        <input type="hidden" id="modalUsername" name="username" autocomplete="username">
                        <div class="form-group">
                            <label for="modalCurrentPassword">Current Password</label>
                            <div class="password-input-container">
                                <input type="password" id="modalCurrentPassword" name="currentPassword" 
                                    placeholder="Enter current password" autocomplete="current-password"
                                    class="modern-input">
                                <button type="button" class="toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="modalNewPassword">New Password</label>
                            <div class="password-input-container">
                                <input type="password" id="modalNewPassword" name="newPassword" 
                                    placeholder="Enter new password" autocomplete="new-password"
                                    class="modern-input">
                                <button type="button" class="toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="password-strength-meter" style="display: none;">
                                <div class="strength-label">Password strength: <span id="strengthText">Weak</span></div>
                                <div class="strength-bar-container">
                                    <div class="strength-bar" id="strengthBar"></div>
                                </div>
                                <small id="passwordRequirements">Use at least 8 characters, including uppercase, lowercase letters, and numbers</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="modalConfirmPassword">Confirm Password</label>
                            <div class="password-input-container">
                                <input type="password" id="modalConfirmPassword" name="confirmPassword" 
                                    placeholder="Confirm new password" autocomplete="new-password"
                                    class="modern-input">
                                <button type="button" class="toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="button-group">
                            <button type="submit" class="btn primary-btn">
                                <i class="fas fa-save"></i> Update Password
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Danger Zone Section -->
                <div class="settings-section danger-zone">
                    <h3><i class="fas fa-exclamation-triangle"></i> Danger Zone</h3>
                    <p class="danger-text">Once you delete your account, there is no going back. Please be certain.</p>
                    <button type="button" class="btn danger-btn" id="deleteAccountBtn">
                        <i class="fas fa-trash-alt"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 