<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Register - Blitz Tesla Club</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/BvmtNLtB/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./nav.js"></script>
</head>
<body class="login-page">
    <nav></nav>

    <main class="login-container">
        <div class="login-box register-box">
            <div class="login-header">
                <img src="https://i.postimg.cc/BvmtNLtB/logo.png" alt="Blitz Tesla Club Logo" class="login-logo">
                <h2>Join Blitz Tesla Club</h2>
                <p>Create your account to become a member</p>
            </div>

            <div class="registration-progress">
                <div class="progress-step active current">
                    <div class="step-icon">
                        <i class="fas fa-user-plus"></i>
                        <span class="step-number">1</span>
                    </div>
                    <span class="step-text">Account</span>
                    <span class="step-description">Create your account</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step">
                    <div class="step-icon">
                        <i class="fas fa-envelope"></i>
                        <span class="step-number">2</span>
                    </div>
                    <span class="step-text">Verify</span>
                    <span class="step-description">Verify your email</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step">
                    <div class="step-icon">
                        <i class="fas fa-check-circle"></i>
                        <span class="step-number">3</span>
                    </div>
                    <span class="step-text">Complete</span>
                    <span class="step-description">Start exploring</span>
                </div>
            </div>

            <form class="login-form" id="registerForm" novalidate>
                <div class="form-group">

                </div>

                <div class="form-group">
                    <label for="fullName">
                        <i class="fas fa-user"></i>
                        Full Name
                    </label>
                    <input type="text" id="fullName" name="fullName" required
                           placeholder="Enter your full name"
                           autocomplete="name"
                           minlength="2"
                           pattern="^[a-zA-Z]+(([',. -][a-zA-Z ])?[a-zA-Z]*)*$">
                    <small class="form-hint">Please enter your real name as it will appear on your membership card</small>
                    <div class="form-validation-icon"></div>
                </div>

                <div class="form-group">
                    <label for="email">
                        <i class="fas fa-envelope"></i>
                        Email Address
                    </label>
                    <input type="email" id="email" name="email" required
                           placeholder="Enter your email"
                           autocomplete="email">
                    <small class="form-hint">We'll send a verification link to this email</small>
                    <div class="form-validation-icon"></div>
                </div>

                <div class="form-group">
                    <label for="password">
                        <i class="fas fa-lock"></i>
                        Password
                    </label>
                    <div class="password-input-wrapper">
                        <div class="password-input-group">
                            <input type="password" id="password" name="password" required
                                   placeholder="Create a password"
                                   autocomplete="new-password"
                                   minlength="8">
                            <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-strength-meter">
                            <div class="strength-bar"></div>
                        </div>
                    </div>
                    <small class="form-hint">Must be at least 8 characters with numbers and letters</small>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">
                        <i class="fas fa-lock"></i>
                        Confirm Password
                    </label>
                    <div class="password-input-group">
                        <input type="password" id="confirmPassword" name="confirmPassword" required
                               placeholder="Confirm your password"
                               autocomplete="new-password">
                        <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                            <i class="far fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group terms-checkbox">
                    <label for="terms">
                        <input type="checkbox" id="terms" name="terms" required>
                        I agree to the <a href="terms.html" target="_blank">Terms of Service</a> and 
                        <a href="privacy.html" target="_blank">Privacy Policy</a>
                    </label>
                </div>

                <button type="submit" class="btn login-btn" id="registerButton">
                    <i class="fas fa-user-plus"></i>
                    Create Account
                </button>

                <div class="form-footer">
                    <p>Already have an account? <a href="login.html">Sign in</a></p>
                </div>
            </form>
        </div>
    </main>

    <footer></footer>

    <script>
        // Helper function to get API URL
        function getApiUrl(endpoint) {
            const isDevelopment = window.location.hostname === 'localhost';
            const baseUrl = isDevelopment ? 'http://localhost:3000' : 'https://blitztclub.com';
            return `${baseUrl}/api/${endpoint}`;
        }

        // Initialize Supabase client
        const supabaseUrl = 'https://qhkcrrphsjpytdfqfamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoa2NycnBoc2pweXRkZnFmYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzMjQ4NzgsImV4cCI6MjA0OTkwMDg3OH0.S9JT_WmCWYMvSixRq1RrB1UlqXm6fix_riLFYCR3JOI';

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: false
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const registerForm = document.getElementById('registerForm');
            const passwordInput = document.getElementById('password');
            const strengthBar = document.querySelector('.strength-bar');

            // Function to show error messages
            function showMessage(message, isError = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isError ? 'error' : 'success'}`;
                messageDiv.textContent = message;
                
                // Remove any existing message
                const existingMessage = document.querySelector('.message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                // Insert message before the form
                registerForm.insertAdjacentElement('beforebegin', messageDiv);
                
                // Remove message after 5 seconds
                setTimeout(() => {
                    messageDiv.remove();
                }, 5000);
            }

            // Password visibility toggle
            document.querySelectorAll('.toggle-password').forEach(button => {
                button.addEventListener('click', function() {
                    const input = this.previousElementSibling;
                    const icon = this.querySelector('i');
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        input.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            });

            // Password strength checker
            function checkPasswordStrength(password) {
                let strength = 0;
                const patterns = {
                    length: password.length >= 8,
                    lowercase: /[a-z]/.test(password),
                    uppercase: /[A-Z]/.test(password),
                    numbers: /\d/.test(password),
                    special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
                };

                strength += patterns.length ? 1 : 0;
                strength += (patterns.lowercase && patterns.uppercase) ? 1 : 0;
                strength += patterns.numbers ? 1 : 0;
                strength += patterns.special ? 1 : 0;

                return { score: strength, patterns };
            }

            // Password strength meter
            passwordInput.addEventListener('input', () => {
                const { score, patterns } = checkPasswordStrength(passwordInput.value);
                strengthBar.className = 'strength-bar';
                
                if (score === 0) {
                    strengthBar.style.width = '0';
                } else if (score <= 2) {
                    strengthBar.classList.add('strength-weak');
                } else if (score === 3) {
                    strengthBar.classList.add('strength-medium');
                } else {
                    strengthBar.classList.add('strength-strong');
                }
            });

            // Function to generate sequential member ID
            async function generateMemberId() {
                try {
                    // Get the latest member ID from the database
                    const { data: profiles, error } = await supabaseClient
                        .from('profiles')
                        .select('member_id')
                        .not('member_id', 'is', null)
                        .order('member_id', { ascending: false })
                        .limit(1);

                    if (error) {
                        console.error('Error fetching latest member ID:', error);
                        throw error;
                    }

                    let nextNumber = 1; // Default start number

                    if (profiles && profiles.length > 0 && profiles[0].member_id) {
                        // Extract the number from the latest member ID (format: BTC#####)
                        const lastNumber = parseInt(profiles[0].member_id.replace('BTC', ''), 10);
                        if (!isNaN(lastNumber)) {
                            nextNumber = lastNumber + 1;
                        }
                    }

                    // Format the new member ID with leading zeros
                    const memberId = `BTC${nextNumber.toString().padStart(5, '0')}`;
                    console.log('Generated sequential member ID:', memberId);
                    return memberId;
                } catch (error) {
                    console.error('Error generating member ID:', error);
                    throw error;
                }
            }

            // Handle form submission
            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitButton = document.getElementById('registerButton');
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
                
                console.log('Starting registration process...');
                
                try {
                    const email = document.getElementById('email').value.trim();
                    const password = document.getElementById('password').value;
                    const fullName = document.getElementById('fullName').value.trim();
                    const terms = document.getElementById('terms').checked;

                    // Validate form
                    if (!email || !password || !fullName || !terms) {
                        throw new Error('Please fill in all fields and accept the terms');
                    }

                    // Check if email already exists in profiles
                    const { data: existingProfile } = await supabaseClient
                        .from('profiles')
                        .select('email')
                        .eq('email', email)
                        .single();

                    if (existingProfile) {
                        throw new Error('This email is already registered. Please sign in instead.');
                    }
                    
                    // Generate sequential member ID
                    const memberId = await generateMemberId();
                    console.log('Using member ID:', memberId);

                    // Create auth user
                    const { data, error } = await supabaseClient.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                full_name: fullName
                            }
                        }
                    });

                    if (error) throw error;

                    console.log('User created successfully:', data);

                    // Create profile with sequential member ID
                    const { error: profileError } = await supabaseClient
                        .from('profiles')
                        .upsert([
                            {
                                id: data.user.id,
                                email: email,
                                full_name: fullName,
                                username: email.split('@')[0],
                                member_id: memberId,
                                membership_status: 'pending',
                                membership_type: 'standard',
                                created_at: new Date().toISOString()
                            }
                        ], { 
                            onConflict: 'id',
                            ignoreDuplicates: false
                        });

                    if (profileError) {
                        console.error('Profile creation error:', profileError);
                        throw profileError;
                    }

                    // Generate verification token
                    const verificationToken = crypto.randomUUID();
                    console.log('Generated verification token');

                    // Store token in database and localStorage
                    const tokenExpiry = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(); // 24 hours
                    const { error: tokenError } = await supabaseClient
                        .from('profiles')
                        .update({
                            verification_token: verificationToken,
                            token_expires_at: tokenExpiry
                        })
                        .eq('id', data.user.id);

                    if (tokenError) {
                        console.error('Error storing verification token:', tokenError);
                        throw tokenError;
                    }

                    // Store token in localStorage as backup
                    localStorage.setItem('verificationToken', verificationToken);
                    localStorage.setItem('tokenExpiry', tokenExpiry);
                    localStorage.setItem('pendingVerificationEmail', email);
                    localStorage.setItem('pendingMemberId', memberId);
                    localStorage.setItem('registrationTime', new Date().toISOString());

                    // Get base URL for verification link
                    const baseUrl = window.location.hostname === 'localhost' 
                        ? 'http://localhost:3000' 
                        : 'https://www.blitztclub.com';
                    const verificationUrl = `${baseUrl}/verify-email.html?token=${verificationToken}`;

                    // Send verification email using FormSubmit
                    const formData = new FormData();
                    formData.append('email', email);
                    formData.append('_captcha', 'false');
                    formData.append('_template', 'box');
                    formData.append('_subject', 'Verify Your Blitz Tesla Club Membership');
                    formData.append('_autoresponse', 'Thank you for verifying your email. Your Blitz Tesla Club membership will be activated shortly.');
                    formData.append('message', `Welcome to Blitz Tesla Club!

Member ID: ${memberId}

Please click the link below to verify your email and activate your membership:
${verificationUrl}

Important Notes:
- This verification link will expire in 24 hours
- Please verify on the same device you're currently using
- After verification, your membership will be activated instantly

Next Steps:
1. Click the verification link above
2. Your membership will be activated instantly
3. Access your digital membership card
4. Start enjoying member benefits

If you can't click the link, copy and paste this URL into your browser:
${verificationUrl}

If you didn't request this email, please ignore it.

Best regards,
Blitz Tesla Club Team`);

                    // Send the verification email
                    const emailResponse = await fetch(`https://formsubmit.co/ajax/${email}`, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json'
                        },
                        body: formData
                    });

                    if (!emailResponse.ok) {
                        const responseText = await emailResponse.text();
                        console.error('FormSubmit response:', responseText);
                        throw new Error('Failed to send verification email');
                    }

                    // Redirect to verification sent page
                    window.location.href = 'verification-sent.html';
                } catch (error) {
                    console.error('Registration error:', error);
                    let errorMessage = 'Registration failed. Please try again.';
                    
                    if (error.message.includes('User already registered') || 
                        error.message.includes('already registered')) {
                        errorMessage = 'This email is already registered. Please sign in instead.';
                    } else if (error.code === '23505') {
                        errorMessage = 'An account with this information already exists.';
                    }
                    
                    showMessage(errorMessage);
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
                }
            });

            // Mobile menu
            const menuToggle = document.querySelector('.menu-toggle');
            const navLinks = document.querySelector('.nav-links');
            if (menuToggle && navLinks) {
                menuToggle.addEventListener('click', () => {
                    navLinks.classList.toggle('active');
                });
            }
        });
    </script>
</body>
</html> 